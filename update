#!/bin/bash
echo "Cảm ơn bạn đã sử dụng WPTangToc OLS"

if ! command -v pv &>/dev/null; then
  echo "Đang cài đặt công cụ hiển thị tiến trình (pv)..."
  if [ -f /etc/redhat-release ]; then
    dnf install pv -y -q >/dev/null 2>&1 || yum install pv -y -q >/dev/null 2>&1
  elif [ -f /etc/debian_version ]; then
    apt-get update -q >/dev/null 2>&1
    apt-get install pv -y -q >/dev/null 2>&1
  fi
fi

if [[ $(crontab -l | grep 'chmod-chown-auto-wptangtoc') = '' ]]; then
  cat <(crontab -l) | sed '/wptt-phan-quyen-all/d' | crontab -
  cat <(crontab -l) <(echo '*/6 * * * * /bin/bash /etc/wptt/chmod-chown-auto-wptangtoc >/dev/null 2>&1') | crontab -
  if $(cat /etc/*release | grep -q "Ubuntu"); then
    systemctl restart cron
  else
    systemctl restart crond
  fi
fi

he_dieu_hanh=$(cat /etc/*release)
if echo $he_dieu_hanh | grep -q "AlmaLinux 8"; then
  check_gpg=$(rpm -q gpg-pubkey-ced7258b-6525146f | grep -q 'not installed')
  if [[ $check_gpg ]]; then
    dnf -y clean packages
    rpm --import https://repo.almalinux.org/almalinux/RPM-GPG-KEY-AlmaLinux
  fi
fi

if echo $he_dieu_hanh | grep -q "CentOS Linux 7"; then
  if [[ $(cat /etc/yum.repos.d/CentOS-Base.repo | grep 'vault') = '' ]]; then
    wget -q http://wptangtoc.com/share/repo-centos7-fix-eol-het-han.zip --no-check-certificate
    unzip -oq repo-centos7-fix-eol-het-han.zip -d /etc/yum.repos.d
    rm -f repo-centos7-fix-eol-het-han.zip
  fi
fi

if $(cat /etc/*release | grep -q "Ubuntu"); then
  ln -sf /etc/cron.d/check-version-wptangtoc-ols.cron /etc/cron.d/check-version-wptangtoc-ols_cron
  systemctl restart cron
fi

/etc/wptt/.wptt.conf
if [[ $Website_chinh != 'wptangtoc-ols.com' ]]; then
  cat <<'EOF' >/root/.bashrc
# .bashrc

# User specific aliases and functions

alias rm='rm -i'
alias cp='cp -i'
alias mv='mv -i'

# Source global definitions
if [ -f /etc/bashrc ]; then
	. /etc/bashrc
fi

[[ $- != *i* ]] && return

alias 1='wptangtoc'
alias 11='wptangtoc'
alias 99='. /etc/wptt/wptt-update'
alias 999='. /etc/wptt/wptt-update2'
alias 00='. /etc/wptt/search-wptangtoc'

. /etc/wptt/wptt-status
. /etc/wptt/wptt-check

PS1="\[\e[37;40m\][\[\e[31;40m\]\u\[\e[37;40m\]@\h \[\e[35;40m\]\W\[\e[0m\]]\\$ "

HISTSIZE=5000
HISTTIMEFORMAT="%F %T $(whoami) "

wptt(){
    source /usr/bin/wptt $1 $2 $3
}

EOF
fi
