#!/bin/bash
# @author: Gia Tu·∫•n
# @website: https://wptangtoc.com
# @email: giatuan@wptangtoc.com
# @since: 2025

function huong_dan() {
  T√≠nh nƒÉng Factory Reset .htaccess [Kh√¥i ph·ª•c c√†i ƒë·∫∑t g·ªëc cho t·ªáp .htaccess] trong WPTangToc OLS l√† m·ªôt c√¥ng c·ª• gi√∫p b·∫°n ƒë∆∞a n·ªôi dung c·ªßa t·ªáp .htaccess trong th∆∞ m·ª•c g·ªëc c·ªßa m·ªôt website [th∆∞·ªùng l√† website WordPress] tr·ªü v·ªÅ tr·∫°ng th√°i m·∫∑c ƒë·ªãnh, chu·∫©n c·ªßa WordPress.

  ü§î T·ªáp .htaccess l√† g√¨?
  M·∫∑c d√π WPTangToc OLS qu·∫£n l√Ω OpenLiteSpeed [OLS], OLS v·∫´n c√≥ kh·∫£ nƒÉng ƒë·ªçc v√† x·ª≠ l√Ω c√°c ch·ªâ th·ªã trong t·ªáp .htaccess ƒë·ªÉ t∆∞∆°ng th√≠ch v·ªõi c√°c ·ª©ng d·ª•ng ph·ªï bi·∫øn nh∆∞ WordPress. T·ªáp n√†y ki·ªÉm so√°t nhi·ªÅu th·ª©, quan tr·ªçng nh·∫•t l√† c·∫•u tr√∫c ƒë∆∞·ªùng d·∫´n tƒ©nh [permalinks] v√† c√°c quy t·∫Øc b·∫£o m·∫≠t ho·∫∑c chuy·ªÉn h∆∞·ªõng do plugin th√™m v√†o. Plugin Cache th√™m v√†o...

  üéØ M·ª•c ƒë√≠ch ch√≠nh
  Vi·ªác reset .htaccess v·ªÅ m·∫∑c ƒë·ªãnh th∆∞·ªùng h·ªØu √≠ch khi:
  * S·ª≠a l·ªói 404 [Not Found]: Khi c√°c trang con c·ªßa website WordPress ƒë·ªôt nhi√™n b√°o l·ªói 404, nguy√™n nh√¢n ph·ªï bi·∫øn l√† do t·ªáp .htaccess b·ªã l·ªói ho·∫∑c thi·∫øu quy t·∫Øc chu·∫©n.
  * Lo·∫°i b·ªè quy t·∫Øc xung ƒë·ªôt: C√°c quy t·∫Øc t√πy ch·ªânh ho·∫∑c do plugin th√™m v√†o c√≥ th·ªÉ g√¢y xung ƒë·ªôt, l√†m website ho·∫°t ƒë·ªông kh√¥ng ƒë√∫ng. Reset s·∫Ω x√≥a b·ªè ch√∫ng.
  * Kh·∫Øc ph·ª•c s·ª± c·ªë sau khi b·ªã t·∫•n c√¥ng: ƒê√¥i khi, m√£ ƒë·ªôc c√≥ th·ªÉ ƒë∆∞·ª£c ch√®n v√†o t·ªáp .htaccess. Vi·ªác reset v·ªÅ m·∫∑c ƒë·ªãnh gi√∫p lo·∫°i b·ªè c√°c thay ƒë·ªïi tr√°i ph√©p n√†y [nh∆∞ng b·∫°n v·∫´n c·∫ßn ki·ªÉm tra b·∫£o m·∫≠t to√†n di·ªán].
  * Chu·∫©n h√≥a c·∫•u h√¨nh: ƒê∆∞a .htaccess v·ªÅ tr·∫°ng th√°i g·ªëc c·ªßa WordPress ƒë·ªÉ ƒë·∫£m b·∫£o c√°c ch·ª©c nƒÉng c∆° b·∫£n ho·∫°t ƒë·ªông ƒë√∫ng.
  * S·ª≠a l·ªói l·ªói 404 ngo√†i tr·ª´ trang ch·ªß h√£y s·ª≠ d·ª•ng t√≠nh nƒÉng n√†y.
  * S·ª≠a l·ªói website c·ªßa b·∫°n b·ªã l·ªói: download.php

  T√≠nh nƒÉng Factory Reset .htaccess l√† m·ªôt c√¥ng c·ª• g·ª° r·ªëi nhanh v√† hi·ªáu qu·∫£ cho nhi·ªÅu v·∫•n ƒë·ªÅ ph·ªï bi·∫øn c·ªßa WordPress li√™n quan ƒë·∫øn ƒë∆∞·ªùng d·∫´n v√† c√°c quy t·∫Øc trong .htaccess.
}

echo ""
echo ""
echo "========================================================================="
echo "|Qu·∫£n l√Ω WordPress => Reset htaccess                                    |"
echo "========================================================================="

if [[ $2 = 'premium' ]]; then
  unset key_activate
  . /etc/wptt/.wptt.conf
  if [[ -z $key_activate ]]; then
    echo "T√≠nh nƒÉng n√†y l√† t√≠nh nƒÉng Premium b·∫°n ph·∫£i mua Active key m·ªõi c√≥ th·ªÉ s·ª≠ d·ª•ng ƒë∆∞·ª£c"
    echo "B·∫°n h√£y activate key th√¨ s·∫Ω ƒë∆∞·ª£c s·ª≠ d·ª•ng t·∫•t c·∫£ c√°c t√≠nh nƒÉng trong add ons"
    check_menu_wptangtoc_active=$1
    if [[ $check_menu_wptangtoc_active = "98" ]]; then
      . /etc/wptt/wptt-add-one-main 1
    fi
    exit
  fi
fi

. /etc/wptt/echo-color
NAME=$1
if [[ $NAME = '98' ]]; then
  NAME=''
fi

if [[ $NAME = '' ]]; then
  function lua_chon_NAME() {
    NAME=""
    if [ "$(ls -At /etc/wptt/vhost)" ]; then
      selects=()
      for entry in $(ls -A /etc/wptt/vhost | grep -v '^\.\.conf$' | sort -uV); do
        NAME=$(echo $entry | sed 's/^.//' | sed 's/.conf//')
        if [[ -f /usr/local/lsws/$NAME/html/wp-config.php ]]; then
          if [ "$NAME" != "${NAME/./}" ] && [ "$NAME" != '.' ]; then #ƒëi·ªÅu ki·ªán domain ph·∫£i c√≥ d·∫•u . v√† l·ªói ch·ªâ c√≥ only .
            selects+=("$NAME")
          fi
        fi
      done

      if [[ $selects = '' ]]; then
        echo "Kh√¥ng c√≥ website n√†o s·ª≠ d·ª•ng WordPress"
        . /etc/wptt/wptt-wordpress-main 1
        exit
      fi

      #check t·ªïng s·ªë website, n·∫øu 2 website tr·ªü l√™n th√¨ s·∫Ω t·ª± ƒë·ªông c√≥ t√≠nh nƒÉng t·∫•t c·∫£
      a=0
      for select in ${selects[@]}; do
        a=$(expr $a + 1)
      done

      if [[ $a != 1 ]]; then
        selects+=("Tat-ca-website")
      fi
      PS3="
$(tput setab 0)-//- L·ª±a ch·ªçn website reset htaccess:$(tput sgr0)  "
      select select in ${selects[@]}; do
        NAME=$select
        index=$REPLY
        break
      done
    else
      clear
      echo "Kh√¥ng c√≥ domain n√†o t·ªìn t·∫°i tr√™n h·ªá th·ªëng."
    fi
  }

  lua_chon_NAME
fi

if [[ $NAME = 'Tat-ca-website' ]]; then
  if [ "$(ls -A /etc/wptt/vhost | grep -v '^\.\.conf$' | sort -uV)" ]; then
    for entry in $(ls -A /etc/wptt/vhost | grep -v '^\.\.conf$' | sort -uV); do
      domain=$(echo $entry | sed 's/^.//' | sed 's/.conf//')
      path="/usr/local/lsws/$domain/html/wp-config.php"
      path_html="/usr/local/lsws/$domain/html"
      i=1
      if [[ -f "$path" ]]; then
        . /etc/wptt/vhost/."$domain".conf
        _runing "reset htaccess $domain"
        . /etc/wptt/wptt-htaccess-reset $domain >/dev/null 2>&1
        _rundone "reset htaccess $domain"
      fi
    done
  fi
  exit
fi

if [[ "$NAME" = "0" || "$NAME" = "" ]]; then
  wptangtoc 1
fi

pathcheck="/etc/wptt/vhost/.$NAME.conf"
if [[ ! -f "$pathcheck" ]]; then
  clear
  echoDo "T√™n mi·ªÅn kh√¥ng t·ªìn t·∫°i tr√™n h·ªá th·ªëng n√†y"
  sleep 3
  wptangtoc 1
  exit
fi

pathcheckwp="/usr/local/lsws/$NAME/html/wp-load.php"
if [[ ! -f "$pathcheckwp" ]]; then
  clear
  echoDo "H·ªá th·ªëng x√°c nh·∫≠n b·∫°n kh√¥ng s·ª≠ d·ª•ng WordPress"
  echoDo "T√≠nh nƒÉng n√†y ch·ªâc√≥ th·ªÉ ho·∫°t ƒë·ªông tr√™n WordPress"
  sleep 3
  wptangtoc 1
  exit
fi

echo "Reset Htaccess website $NAME : $(date '+%d-%m-%Y %H:%M')" >>/var/log/wptangtoc-ols.log

_runing "reset htaccess cho website $NAME"
. /etc/wptt/vhost/."$NAME".conf
echo '# BEGIN WordPress
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]
RewriteBase /
RewriteRule ^index\.php$ - [L]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule . /index.php [L]
</IfModule>
# END WordPress' >/usr/local/lsws/"$NAME"/html/.htaccess
_rundone "reset htaccess cho website $NAME"

if [[ -f "/etc/letsencrypt/live/$NAME/cert.pem" || -d /usr/local/lsws/$NAME/ssl || -f "/etc/letsencrypt/live/www.$NAME/cert.pem" ]]; then
  _runing "renew chuy·ªÉn h∆∞·ªõng"
  . /etc/wptt/ssl/wptt-renew-chuyen-huong $NAME >/dev/null 2>&1
  _rundone "renew chuy·ªÉn h∆∞·ªõng"
fi

. /etc/wptt/php/php-cli-domain-config $NAME

if [[ -d /usr/local/lsws/$NAME/html/wp-content/plugins/litespeed-cache ]]; then
  /usr/local/lsws/lsphp${phien_ban_php_domain_thuc_thi}/bin/php /usr/local/bin/wp litespeed-option set cache-browser false --allow-root --path=/usr/local/lsws/$NAME >/dev/null 2>&1
fi

tuong_lua_7g=''
. /etc/wptt/vhost/.$NAME.conf
. /etc/wptt/.wptt.conf

if [[ $tuong_lua_7g ]]; then
  . /etc/wptt/bao-mat/wptt-firewall-7g $NAME
fi

_runing "Ph√¢n quy·ªÅn website $NAME"
chown -R "$User_name_vhost":"$User_name_vhost" /usr/local/lsws/"$NAME"/html

if [[ $2 = '' ]]; then
  _runing "Ph√¢n quy·ªÅn website $NAME"
  . /etc/wptt/wptt-phanquyen $NAME >/dev/null 2>&1
  _runing "Ph√¢n quy·ªÅn website $NAME"
fi

chmod 444 /usr/local/lsws/"$NAME"/html/index.php
chmod 600 /usr/local/lsws/"$NAME"/html/wp-config.php

#tuong thich ubuntu tuong thich nhom litespeed
if $(cat /etc/*release | grep -q "Ubuntu"); then
  tuong_thich_nhom_litespeed="nogroup"
else
  tuong_thich_nhom_litespeed="nobody"
fi

if [[ $id_dang_nhap_phpmyadmin && $Website_chinh = $NAME && -d /usr/local/lsws/"$NAME"/html/phpmyadmin ]]; then
  chown -R nobody:$tuong_thich_nhom_litespeed /usr/local/lsws/"$NAME"/html/phpmyadmin
fi

_rundone "Ph√¢n quy·ªÅn website $NAME"

#cache wptangtoc
if [[ -f /usr/local/lsws/$NAME/html/wp-content/plugins/wptangtoc/class/Cache.php ]]; then
  . /etc/wptt/cache/cache-wptangtoc-page-html $NAME
fi

/usr/local/lsws/lsphp${phien_ban_php_domain_thuc_thi}/bin/php /usr/local/bin/wp rewrite flush --allow-root --path=/usr/local/lsws/"$NAME"/html >/dev/null 2>&1
/usr/local/lsws/bin/lswsctrl restart >/dev/null 2>&1
echo "==================================================================="
echo "Ho√†n t·∫•t reset htaccess website $NAME              "
echo "==================================================================="

if [[ $2 = 'premium' ]]; then
  unset key_activate
  . /etc/wptt/.wptt.conf
  if [[ -z $key_activate ]]; then
    echo "T√≠nh nƒÉng n√†y l√† t√≠nh nƒÉng Premium b·∫°n ph·∫£i mua Active key m·ªõi c√≥ th·ªÉ s·ª≠ d·ª•ng ƒë∆∞·ª£c"
    echo "B·∫°n h√£y activate key th√¨ s·∫Ω ƒë∆∞·ª£c s·ª≠ d·ª•ng t·∫•t c·∫£ c√°c t√≠nh nƒÉng trong add ons"
    check_menu_wptangtoc_active=$1
    if [[ $check_menu_wptangtoc_active = "98" ]]; then
      . /etc/wptt/wptt-add-one-main 1
    fi
    exit
  fi
fi
