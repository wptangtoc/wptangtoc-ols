#!/bin/bash
function huong_dan() {
  TÃ­nh nÄƒng cÃ i Ä‘áº·t mÃ£ nguá»“n WordPress, thÃ¬ Ä‘Ã¢y lÃ  má»™t chá»©c nÄƒng tá»± Ä‘á»™ng hÃ³a máº¡nh máº½, giÃºp báº¡n triá»ƒn khai má»™t website WordPress hoÃ n toÃ n má»›i lÃªn mÃ¡y chá»§ má»™t cÃ¡ch nhanh chÃ³ng vÃ  dá»… dÃ ng.

  TÃ­nh nÄƒng CÃ i Ä‘áº·t MÃ£ nguá»“n WordPress [WPTangToc OLS]
  ðŸš€ Má»¥c Ä‘Ã­ch chÃ­nh:
  * Tiáº¿t kiá»‡m Thá»i gian &
  CÃ´ng sá»©c: Thay vÃ¬ pháº£i thá»±c hiá»‡n hÃ ng loáº¡t bÆ°á»›c thá»§ cÃ´ng [táº¡o database, táº£i WordPress, cáº¥u hÃ¬nh wp-config.php, cháº¡y cÃ i Ä‘áº·t], tÃ­nh nÄƒng nÃ y sáº½ lÃ m táº¥t cáº£ chá»‰ báº±ng má»™t vÃ i thao tÃ¡c hoáº·c má»™t lá»‡nh.
  * Chuáº©n hÃ³a CÃ i Ä‘áº·t: Äáº£m báº£o cÃ¡c website má»›i Ä‘Æ°á»£c cÃ i Ä‘áº·t theo má»™t cáº¥u trÃºc vÃ  cáº¥u hÃ¬nh chuáº©n, cÃ³ thá»ƒ Ä‘Ã£ Ä‘Æ°á»£c tá»‘i Æ°u sáºµn cho mÃ´i trÆ°á»ng OpenLiteSpeed vÃ  cÃ¡c tÃ­nh nÄƒng khÃ¡c cá»§a WPTangToc OLS.
  * Giáº£m thiá»ƒu Lá»—i: Tá»± Ä‘á»™ng hÃ³a giÃºp háº¡n cháº¿ tá»‘i Ä‘a cÃ¡c sai sÃ³t cÃ³ thá»ƒ xáº£y ra khi thá»±c hiá»‡n thá»§ cÃ´ng.
  * ThÃ¢n thiá»‡n vá»›i NgÆ°á»i dÃ¹ng: GiÃºp cáº£ nhá»¯ng ngÆ°á»i khÃ´ng quÃ¡ rÃ nh vá» ká»¹ thuáº­t cÅ©ng cÃ³ thá»ƒ dá»… dÃ ng táº¡o má»™t website WordPress má»›i.

  âœ… Lá»£i Ã­ch:
  * Triá»ƒn khai Nhanh: Táº¡o website má»›i chá»‰ trong vÃ i phÃºt.
  * Dá»… dÃ ng &
  Tiá»‡n lá»£i: Quy trÃ¬nh Ä‘Æ¡n giáº£n hÃ³a.
  * Tá»‘i Æ°u Sáºµn: Website má»›i cÃ³ kháº£ nÄƒng Ä‘Æ°á»£c cÃ i Ä‘áº·t vá»›i cÃ¡c thiáº¿t láº­p tá»‘i Æ°u cho OLS.
  TÃ³m láº¡i: TÃ­nh nÄƒng cÃ i Ä‘áº·t mÃ£ nguá»“n WordPress trong WPTangToc OLS lÃ  má»™t cÃ´ng cá»¥ tá»± Ä‘á»™ng hÃ³a giÃºp Ä‘Æ¡n giáº£n hÃ³a vÃ  tÄƒng tá»‘c quÃ¡ trÃ¬nh táº¡o má»™t website WordPress má»›i trÃªn mÃ¡y chá»§ OpenLiteSpeed, Ä‘á»“ng thá»i Ä‘áº£m báº£o website Ä‘Æ°á»£c thiáº¿t láº­p theo cÃ¡c tiÃªu chuáº©n cÃ³ thá»ƒ Ä‘Ã£ Ä‘Æ°á»£c tá»‘i Æ°u hÃ³a bá»Ÿi bá»™ cÃ´ng cá»¥ nÃ y.
}

export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8
stty iutf8 #tá»« latin1 sang utf8, nhiá»u khi anh em dÃ¹ng bá»™ gÃµ tiáº¿ng viá»‡t: dÃ¹ng Ã  Ã¢ nÃ³ thÃªm \xc3 hay \xa9 ... tÆ°Æ¡ng thÃ­ch vá»›i bá»™ gÃµ tiáº¿ng viá»‡t telex khi nháº­p domain

. /etc/wptt/.wptt.conf
if [[ $ngon_ngu = '' ]]; then
  ngon_ngu='vi'
fi
. /etc/wptt/lang/$ngon_ngu.sh

echo "========================================================================="
. /etc/wptt/tenmien
echo ""
echo ""
echo "$lua_chon_website_ban_muon $thiet_lap WordPress:"
echo ""
lua_chon_NAME
domain="$NAME"

if [[ "$NAME" = "0" || "$NAME" = "" ]]; then
  check_menu_wptangtoc_active=$1
  if [[ $check_menu_wptangtoc_active = "99" ]]; then
    wptangtoc 1
  fi

  if [[ $check_menu_wptangtoc_active = "98" ]]; then
    . /etc/wptt/wptt-wordpress-main 1
  fi
  return 2>/dev/null
  exit
fi

pathcheck="/etc/wptt/vhost/.$NAME.conf"
if [[ ! -f "$pathcheck" ]]; then
  clear
  echoDo "$ten_mien_nay_khong_ton_tai_tren_he_thong"
  sleep 3
  wptangtoc 1
  exit
fi

. /etc/wptt/vhost/."$NAME".conf
. /etc/wptt/.wptt.conf

. /etc/wptt/echo-color

if [[ -f /usr/local/lsws/$NAME/html/wp-load.php ]]; then
  echo "$dieu_nay_se_xoa_toan_bo_wordpress_hien_tai_hoan_toan"
fi

echo "$xac_nhan $thiet_lap Wordpress $phien_ban $moi_nhat cho domain $domain"
prompt="$nhap_lua_chon_cua_ban [1-2]: "
dongy_1="n"
options=("$dong_y" "$khong_dong_y")
PS3="$prompt"
select opt in "${options[@]}"; do
  case "$REPLY" in
  1)
    dongy_1="y"
    break
    ;;

  2)
    dongy_1="n"
    break
    ;;

  $((${#options[@]} + 1)))
    printf "\nBáº¡n nháº­p sai há»‡ thá»‘ng sáº½ chá»n lÃ  khÃ´ng Ä‘á»“ng Ã½\n"
    break
    ;;
  *)
    printf "Báº¡n nháº­p sai há»‡ thá»‘ng sáº½ chá»n lÃ  khÃ´ng Ä‘á»“ng Ã½\n"
    break
    ;;
  esac
done

if [[ "$dongy_1" = "y" ]]; then
  echo "Install mÃ£ nguá»“n Wordpress website $NAME : $(date '+%d-%m-%Y %H:%M')" >>/var/log/wptangtoc-ols.log
  if [[ $lock_down ]]; then
    _runing "$tat lock down website $NAME"
    . /etc/wptt/bao-mat/wptt-chattr-file-lock $NAME off
    sed -i '/lock_down/d' /etc/wptt/vhost/.$NAME.conf
    _rundone "$tat lock down website $NAME"
  fi

  _runing "$lam_sach_toan_bo_du_lieu_ma_nguon_cua $NAME"
  cd /usr/local/lsws/"$NAME"/html/

  rm -rf /usr/local/lsws/"$NAME"/html/*

  if [[ -d /usr/local/lsws/"$NAME"/luucache ]]; then
    rm -rf /usr/local/lsws/"$NAME"/luucache
  fi

  _rundone "$lam_sach_toan_bo_du_lieu_ma_nguon_cua $NAME"

  _runing "$tai $ma_nguon WordPress"

  wget -q https://wordpress.org/latest.tar.gz #download báº±ng https
  if [[ ! -f latest.tar.gz ]]; then
    wget -q http://wordpress.org/latest.tar.gz #download dá»± phÃ²ng báº±ng http
  fi

  if [[ ! -f latest.tar.gz ]]; then
    _runloi "$tai $ma_nguon WordPress"
    echoDo "ChÆ°a thá»ƒ download mÃ£ nguá»“n WordPress vui lÃ²ng thá»­ láº¡i sau"
    check_menu_wptangtoc_active=$1
    if [[ $check_menu_wptangtoc_active = "99" ]]; then
      wptangtoc 1
    fi
    return 2>/dev/null
    exit
  fi

  _rundone "$tai $ma_nguon WordPress"
  _runing "$giai_nen $ma_nguon WordPress"
  tar -zxf latest.tar.gz
  mv wordpress/* /usr/local/lsws/"$NAME"/html && rm -rf wordpress && rm -f latest.tar.gz
  _rundone "$giai_nen $ma_nguon WordPress"

  . /etc/wptt/ssl/check-ssl-cert-con-kha-dung $NAME #check ssl kháº£ dá»¥ng
  if [[ $ssl_xac_thuc_kha_dung = 'true' ]]; then
    ssl_check="https://"
  else
    ssl_check="http://"
  fi

  if [[ "$DB_Name_web" != "" ]]; then
    _runing "$lam_sach_toan_bo_du_lieu_database $NAME"
    database1="$DB_Name_web"
    mariadb -u $database_admin_username -p"$database_admin_password" --ssl-verify-server-cert=false -e "DROP DATABASE $DB_Name_web"
    mariadb -u $database_admin_username -p"$database_admin_password" --ssl-verify-server-cert=false -e "CREATE DATABASE IF NOT EXISTS $DB_Name_web"
    _rundone "$lam_sach_toan_bo_du_lieu_database $NAME"

    echo "$xac_nhan $ban_co_muon $thiet_lap $cai_dat WordPress $ngay_tai_day_khong: "
    prompt="$nhap_lua_chon_cua_ban [1-2]: "
    bien=$1
    dongyconfig="n"
    options=("$dong_y" "$khong_dong_y")
    PS3="$prompt"
    select opt in "${options[@]}"; do
      case "$REPLY" in
      1)
        dongyconfig="y"
        break
        ;;

      2)
        dongyconfig="n"
        break
        ;;

      $((${#options[@]} + 1)))
        printf "\nBáº¡n nháº­p sai há»‡ thá»‘ng sáº½ chá»n lÃ  khÃ´ng Ä‘á»“ng Ã½\n"
        break
        ;;
      *)
        printf "Báº¡n nháº­p sai há»‡ thá»‘ng sáº½ chá»n lÃ  khÃ´ng Ä‘á»“ng Ã½\n"
        break
        ;;
      esac

    done

    if [[ ! -f /usr/local/bin/wp ]]; then
      curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
      chmod +x wp-cli.phar
      mv wp-cli.phar /usr/local/bin/wp
    fi

    tien_to_db=$(
      date +%s | sha256sum | base64 | head -c 6
      echo
    )
    wp core config --dbname="$DB_Name_web" --dbuser="$DB_User_web" --dbpass="$DB_Password_web" --dbhost=localhost --dbprefix="${tien_to_db}"_ --dbcharset='utf8mb4' --dbcollate='utf8mb4_unicode_ci' --allow-root --extra-php >/dev/null 2>&1 <<PHP
define( 'WP_DEBUG_LOG', false );
define( 'WP_DEBUG_DISPLAY', false );
PHP

    mkdir -p /usr/local/lsws/"$NAME"/passwd
    Post_Install_Regenerate_Webadmin_Console_Passwd() {
      if [[ "$Server_Edition" = "OLS" ]]; then
        PHP_Command="admin_php"
      else
        PHP_Command="admin_php5"
      fi

      Webadmin_Pass=$(
        head /dev/urandom | tr -dc A-Za-z0-9 | head -c 12
        echo ''
      )
      id_ols_admin=$(
        date +%s | sha256sum | base64 | head -c 12
        echo
      )
      Encrypt_string=$(/usr/local/lsws/admin/fcgi-bin/admin_php -q /usr/local/lsws/admin/misc/htpasswd.php "${Webadmin_Pass}")
      echo "" >/usr/local/lsws/"$NAME"/passwd/.mk-setup
      echo "$id_ols_admin:$Encrypt_string" >/usr/local/lsws/"$NAME"/passwd/.mk-setup
    }
    Post_Install_Regenerate_Webadmin_Console_Passwd

    sed -i -e '/^realm '${NAME}wordpress-setup'/,/^}$/d' /usr/local/lsws/conf/vhosts/"$NAME"/"$NAME".conf
    sed -i -e '/^context exp:wp-admin\/install.php/,/^}$/d' /usr/local/lsws/conf/vhosts/"$NAME"/"$NAME".conf

    echo 'realm '${NAME}wordpress-setup' {

  userDB  {
    location              /usr/local/lsws/'$NAME'/passwd/.mk-setup
  }
}

context exp:wp-admin/install.php {
  location                $DOC_ROOT/$0
  allowBrowse             1
  realm                   '${NAME}wordpress-setup'

  accessControl  {
    allow                 ALL
  }

  rewrite  {

  }
  addDefaultCharset	  off

  phpIniOverride  {

  }
}' >>/usr/local/lsws/conf/vhosts/"$NAME"/"$NAME".conf

    if [[ "$dongyconfig" = "y" ]]; then
      read -p "1. $ten_tieu_de_website_wordpress_cua_ban_muon: " SiteTitle
      read -p "2. $nhap_id_dang_nhap_wordpress: " idusername
      # read -sp "3. $nhap_password_wordpress:
      # $luu_y_nhap_wordpress_it_nhat_12_ky_tu: " mypassword

      mypassword=""
      print_nhap_password="3. $nhap_password_wordpress:
$luu_y_nhap_wordpress_it_nhat_12_ky_tu: "
      echo -n "$print_nhap_password"

      while IFS= read -r -s -N 1 char; do

        # Kiá»ƒm tra Enter (kÃ½ tá»± rá»—ng HOáº¶C kÃ½ tá»± xuá»‘ng dÃ²ng '\n' HOáº¶C kÃ½ tá»± vá» Ä‘áº§u dÃ²ng '\r')
        if [[ -z "$char" ]] || [[ "$char" == $'\n' ]] || [[ "$char" == $'\r' ]]; then
          echo                              # Xuá»‘ng dÃ²ng sau khi nháº­p xong
          break                             # ThoÃ¡t vÃ²ng láº·p
        elif [[ "$char" == $'\x7f' ]]; then # Kiá»ƒm tra Backspace
          if [[ -n "$mypassword" ]]; then
            mypassword="${mypassword%?}"
            echo -ne '\b \b'
          fi
        else # KÃ½ tá»± bÃ¬nh thÆ°á»ng
          mypassword+="$char"
          echo -n '*'
        fi

      done

      if [[ $mypassword = "" ]]; then
        echo "$nhap_password_wordpress - $ban_chua_nhap_password"
        print_nhap_password="3. $nhap_password_wordpress:
$luu_y_nhap_wordpress_it_nhat_12_ky_tu: "
        echo -n "$print_nhap_password"

        while IFS= read -r -s -N 1 char; do

          # Kiá»ƒm tra Enter (kÃ½ tá»± rá»—ng HOáº¶C kÃ½ tá»± xuá»‘ng dÃ²ng '\n' HOáº¶C kÃ½ tá»± vá» Ä‘áº§u dÃ²ng '\r')
          if [[ -z "$char" ]] || [[ "$char" == $'\n' ]] || [[ "$char" == $'\r' ]]; then
            echo                              # Xuá»‘ng dÃ²ng sau khi nháº­p xong
            break                             # ThoÃ¡t vÃ²ng láº·p
          elif [[ "$char" == $'\x7f' ]]; then # Kiá»ƒm tra Backspace
            if [[ -n "$mypassword" ]]; then
              mypassword="${mypassword%?}"
              echo -ne '\b \b'
            fi
          else # KÃ½ tá»± bÃ¬nh thÆ°á»ng
            mypassword+="$char"
            echo -n '*'
          fi

        done

      fi

      echo ""
      read -p "4. $nhap Email website $domain
vÃ­ dá»¥ abc@gmail.com, giatuan@wptangtoc.com: " emailwp
      while [ "$emailwp" = "${emailwp/@/}" ]; do
        clear
        . /etc/wptt/echo-color
        echoDo "$email_khong_dung_dinh_dang"
        echo "Vui loÌ€ng nhÃ¢Ì£p laÌ£i Ä‘iÌ£a chiÌ‰ email"
        read -p "4. $nhap Email website $domain
vÃ­ dá»¥ abc@gmail.com, giatuan@wptangtoc.com: " emailwp
      done

      _runing "$thiet_lap WordPress"
      wp core install --url="${ssl_check}""${domain}" --title="$SiteTitle" --admin_user="$idusername" --admin_password="$mypassword" --admin_email="$emailwp" --allow-root >/dev/null 2>&1
      unset mypassword
    fi
  fi

  echo '
# BEGIN WordPress
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]
RewriteBase /
RewriteRule ^index\.php$ - [L]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule . /index.php [L]
</IfModule>
# END WordPress' >/usr/local/lsws/"$domain"/html/.htaccess

  if [[ "$dongyconfig" = "y" ]]; then
    wp language core install vi --path=/usr/local/lsws/"$NAME"/html --activate --allow-root >/dev/null 2>&1
    wp option update timezone_string "Asia/Ho_Chi_Minh" --path=/usr/local/lsws/"$NAME"/html --allow-root >/dev/null 2>&1
    wp rewrite structure '/%postname%/' --path=/usr/local/lsws/"$NAME"/html --allow-root >/dev/null 2>&1

    #delete báº£o máº­t login thiáº¿t láº­p wp-admin/install.php
    sed -i -e '/^realm '${NAME}wordpress-setup'/,/^}$/d' /usr/local/lsws/conf/vhosts/"$NAME"/"$NAME".conf
    sed -i -e '/^context exp:wp-admin\/install.php/,/^}$/d' /usr/local/lsws/conf/vhosts/"$NAME"/"$NAME".conf
    rm -f /usr/local/lsws/"$NAME"/passwd/.mk-setup

    _rundone "$thiet_lap WordPress"
  fi

  #tao file robots
  cat >"/usr/local/lsws/$NAME/html/robots.txt" <<END
User-agent: *
Disallow: /wp-admin/
Allow: /wp-admin/admin-ajax.php
END

  _runing "$phan_quyen website $NAME"
  chown -R "$User_name_vhost":"$User_name_vhost" /usr/local/lsws/"$domain"/html

  /usr/local/lsws/bin/lswsctrl restart >/dev/null 2>&1
  _rundone "$phan_quyen website $NAME"

  clear
  blue='\033[1;34m'
  NC='\033[0m'
  echo -e "${blue}               ...:..........:...              
           .:..      ....      ..:.           
        .:.   .::------------::.   .:.        
      ::.  .:---------------------:  .::      
    .:.  :------------------------.    .:.    
   ::  :-------------------------        ::   
  ::       . .--:.        . :----         ::  
 ::        :-------:      -------:      .  :: 
 -  -:      --------:      --------     :-  - 
:. .--.     .--------.     .-------:    --. .:
-  :---      :--------      --------.  .--:  -
-  :----      --------       -------   ---:  -
-  :----:     .------. .     .------  ----:  -
:. .-----.     :----- .-      -----. :----. .:
 -  :-----      ----  ---      ---: .----:  - 
 ::  -----:     .--. ----:     .--  -----  :: 
  ::  -----:     :- .-----.     -. :----  ::  
   ::  :----.       -------       .---:  ::   
    .:.  :---      --------:      --:  .:.    
      ::.  .-:    :---------:    :.  .::      
        .:.       -----------      .:.        
           .:...     ....     ...:.           
              ...:..........:...     ${NC}"
  echo "-------------------------------------------------------------------------"
  echo "$cai_dat_thanh_cong."
  echo "-------------------------------------------------------------------------"
  echo -e "Domain \t\t\t: ${ssl_check}${domain}"
  echo -e "$duong_dan_thu_muc\t: /usr/local/lsws/$domain/html/"
  echo "-------------------------------------------------------------------------"
  if [[ "$dongyconfig" = "y" ]]; then
    echo "$thong_tin WordPress domain $domain"
    echo "$ten_tieu_de_website_wordpress_cua_ban		: $SiteTitle "
    echo "URL WordPress Admin	: ${ssl_check}${domain}/wp-admin/"
    echo "$id_dang_nhap_wp			: $idusername "
    echo "Password Wordpress			: ****************** "
    echo "Email website			: $emailwp "
    echo "-------------------------------------------------------------------------"
  else
    echo -e "Username Ä‘Äƒng nháº­p WordPress thiáº¿t láº­p \t: $id_ols_admin"
    echo -e "PassWord Ä‘Äƒng nháº­p WordPress thiáº¿t láº­p \t: $Webadmin_Pass"

    phut='3'
    cat >"/etc/cron.d/wp-delete-setup-bao-mat-$NAME.cron" <<END
*/$phut * * * * root /bin/bash /etc/wptt/wordpress/delete-auth-setup-wordpress-config $NAME >/dev/null 2>&1
END

    if $(cat /etc/*release | grep -q "Ubuntu"); then
      NAME_CRON_ubuntu=${NAME//[.]/_}
      ln -sf /etc/cron.d/wp-delete-setup-bao-mat-$NAME.cron /etc/cron.d/wp-delete-setup-bao-mat-${NAME_CRON_ubuntu}_cron
      systemctl restart cron.service
    else
      systemctl restart crond.service
    fi

  fi
  echo

fi

check_menu_wptangtoc_active=$1
if [[ $check_menu_wptangtoc_active = "99" ]]; then
  wptangtoc 1
fi

if [[ $check_menu_wptangtoc_active = "98" ]]; then
  . /etc/wptt/wptt-wordpress-main 1
fi
