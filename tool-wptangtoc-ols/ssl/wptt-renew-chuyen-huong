#!/bin/bash
# @author: Gia Tu·∫•n
# @website: https://wptangtoc.com
# @since: 2025

function huong_dan() {
  WPTangToc OLS c√≥ t√≠nh nƒÉng Renew thi·∫øt l·∫≠p l·∫°i chuy·ªÉn h∆∞·ªõng HTTP to HTTPS, th√¨ ƒë√¢y l√† m·ªôt ch·ª©c nƒÉng quan tr·ªçng gi√∫p b·∫°n ki·ªÉm tra, s·ª≠a ch·ªØa v√† √°p d·ª•ng l·∫°i m·ªôt c√°ch d·ª©t kho√°t quy t·∫Øc chuy·ªÉn h∆∞·ªõng to√†n b·ªô truy c·∫≠p t·ª´ giao th·ª©c http:// kh√¥ng an to√†n sang https:// an to√†n cho website c·ªßa b·∫°n.

  Nh·∫•n m·∫°nh r·∫±ng t√≠nh nƒÉng n√†y kh√¥ng ch·ªâ t·∫°o m·ªõi m√† c√≤n c√≥ kh·∫£ nƒÉng kh√¥i ph·ª•c ho·∫∑c s·ª≠a ch·ªØa m·ªôt c·∫•u h√¨nh chuy·ªÉn h∆∞·ªõng c√≥ th·ªÉ ƒë√£ b·ªã l·ªói ho·∫∑c thay ƒë·ªïi tr∆∞·ªõc ƒë√≥.

  T√≠nh nƒÉng Renew [L√†m m·ªõi] / Thi·∫øt l·∫≠p l·∫°i Chuy·ªÉn h∆∞·ªõng HTTP to HTTPS
  üîí M·ª•c ƒë√≠ch ch√≠nh:
  * S·ª≠a l·ªói Chuy·ªÉn h∆∞·ªõng: Kh·∫Øc ph·ª•c c√°c t√¨nh hu·ªëng m√† vi·ªác t·ª± ƒë·ªông chuy·ªÉn t·ª´ HTTP sang HTTPS b·ªã h·ªèng, kh√¥ng ho·∫°t ƒë·ªông ho·∫∑c ho·∫°t ƒë·ªông kh√¥ng ch√≠nh x√°c do thay ƒë·ªïi c·∫•u h√¨nh, c·∫≠p nh·∫≠t ho·∫∑c l·ªói n√†o ƒë√≥.
  * ƒê·∫£m b·∫£o T√≠nh ƒê√∫ng ƒë·∫Øn: X√°c minh v√† √°p d·ª•ng l·∫°i quy t·∫Øc chuy·ªÉn h∆∞·ªõng theo ph∆∞∆°ng ph√°p chu·∫©n [th∆∞·ªùng l√† 301 Permanent Redirect] m√† c√¥ng c·ª• WPTangToc OLS khuy√™n d√πng.
  * Ti√™u chu·∫©n h√≥a C·∫•u h√¨nh: ƒê·∫£m b·∫£o t·∫•t c·∫£ c√°c website ƒë∆∞·ª£c qu·∫£n l√Ω ƒë·ªÅu √°p d·ª•ng m·ªôt c∆° ch·∫ø chuy·ªÉn h∆∞·ªõng HTTPS ƒë·ªìng nh·∫•t v√† hi·ªáu qu·∫£.
  * ƒê∆°n gi·∫£n h√≥a Qu·∫£n l√Ω: Cung c·∫•p m·ªôt n√∫t b·∫•m ho·∫∑c l·ªánh duy nh·∫•t ƒë·ªÉ x·ª≠ l√Ω to√†n b·ªô vi·ªác enforces HTTPS, thay v√¨ ph·∫£i can thi·ªáp th·ªß c√¥ng v√†o c·∫•u h√¨nh OpenLiteSpeed.
  * H·ªó tr·ª£ Sau khi C√†i/Gia h·∫°n SSL: L√† m·ªôt b∆∞·ªõc c·∫ßn thi·∫øt sau khi b·∫°n c√†i ƒë·∫∑t ho·∫∑c gia h·∫°n th√†nh c√¥ng ch·ª©ng ch·ªâ SSL ƒë·ªÉ ƒë·∫£m b·∫£o website ngay l·∫≠p t·ª©c s·ª≠ d·ª•ng n√≥.

  T√≥m l·∫°i: T√≠nh nƒÉng Renew thi·∫øt l·∫≠p l·∫°i chuy·ªÉn h∆∞·ªõng HTTP to HTTPS trong WPTangToc OLS l√† m·ªôt c√¥ng c·ª• m·∫°nh m·∫Ω v√† ti·ªán l·ª£i, gi√∫p b·∫°n ƒë·∫£m b·∫£o r·∫±ng website c·ªßa m√¨nh lu√¥n ho·∫°t ƒë·ªông m·ªôt c√°ch an to√†n v√† nh·∫•t qu√°n tr√™n giao th·ª©c HTTPS, ƒë·ªìng th·ªùi d·ªÖ d√†ng s·ª≠a ch·ªØa c√°c l·ªói c·∫•u h√¨nh li√™n quan.
}

. /etc/wptt/echo-color
NAME=$1

if [[ $NAME = "98" ]]; then
  NAME=""
fi

if [[ $NAME = "" ]]; then
  echo ""
  echo ""
  echo ""
  echo "========================================================================="
  echo "|Qu·∫£n l√Ω SSL => Renew chuy·ªÉn h∆∞·ªõng HTTP TO HTTPS                        |"
  echo "========================================================================="
  . /etc/wptt/tenmien-them-lua-chon-tat-ca-website
  echo ""
  echo ""
  echo "L·ª±a ch·ªçn website renew chuy·ªÉn h∆∞·ªõng (HTTPS): "
  echo ""
  lua_chon_NAME
fi

if [[ $NAME = 'T·∫•t c·∫£ website' ]]; then
  if [ "$(ls -A /etc/wptt/vhost | grep -v '^\.\.conf$' | sort -uV)" ]; then
    for entry in $(ls -A /etc/wptt/vhost | grep -v '^\.\.conf$' | sort -uV); do
      domain=$(echo $entry | sed 's/^.//' | sed 's/.conf//')
      path="/usr/local/lsws/$domain/html"
      i=1
      if [ "$domain" != "${domain/./}" ] && [ "$domain" != '.' ]; then #ƒëi·ªÅu ki·ªán domain ph·∫£i c√≥ d·∫•u . v√† l·ªói ch·ªâ c√≥ only .
        if [[ -d "$path" ]]; then
          if [[ ! -f "/etc/letsencrypt/live/$domain/cert.pem" && ! -f "/etc/letsencrypt/live/www.$domain/cert.pem" && ! -d "/usr/local/lsws/$domain/ssl" ]]; then
            continue
          fi
          _runing "Renew chuy·ªÉn h∆∞·ªõng SSL $domain"
          (/etc/wptt/ssl/wptt-renew-chuyen-huong $domain >/dev/null 2>&1)
          _rundone "Renew chuy·ªÉn h∆∞·ªõng SSL $domain"
        fi
      fi
    done
  fi

  check_menu_wptangtoc_active=$1
  if [[ $check_menu_wptangtoc_active = "98" ]]; then
    . /etc/wptt/wptt-ssl-main 1
  fi
  return 2>/dev/null
  exit
fi

if [[ "$NAME" = "0" || "$NAME" = "" ]]; then
  . /etc/wptt/wptt-ssl-main 1
fi

path="/etc/wptt/vhost/.$NAME.conf"
if [[ ! -f "$path" && ! -f /etc/wptt/chuyen-huong/.$NAME.conf ]]; then
  clear
  echoDo "$ten_mien_nay_khong_ton_tai_tren_he_thong"
  sleep 3
  . /etc/wptt/wptt-ssl-main 1
  return 2>/dev/null
  exit
fi

#curl -Is https://$NAME | grep -q 'cloudflare ki·ªÉm tra xem ssl c√≥ ƒë·ªÉ ch·∫ø ƒë·ªô flexbile kh√¥ng?
if [[ ! -f "/etc/letsencrypt/live/$NAME/cert.pem" && ! -f "/etc/letsencrypt/live/www.$NAME/cert.pem" && ! -d "/usr/local/lsws/$NAME/ssl" && ! $(curl -Is https://$NAME | grep 'cloudflare') ]]; then
  echoDo "website $NAME b·∫°n ch∆∞a ƒë∆∞·ª£c c√†i ƒë·∫∑t ch·ª©ng ch·ªâ SSL"
  return 2>/dev/null
  exit
fi

_runing "C·∫•u h√¨nh renew chuy·ªÉn h∆∞·ªõng"

. /etc/wptt/php/php-cli-domain-config $NAME
if [[ -f /usr/local/lsws/$NAME/html/wp-config.php ]]; then
  giatuanwww=$(/usr/local/lsws/lsphp${phien_ban_php_domain_thuc_thi}/bin/php /usr/local/bin/wp option get home --path=/usr/local/lsws/$NAME/html --allow-root 2>/dev/null | grep 'www.')
  if [[ $giatuanwww ]]; then
    /usr/local/lsws/lsphp${phien_ban_php_domain_thuc_thi}/bin/php /usr/local/bin/wp option update home "https://www.$NAME" --path=/usr/local/lsws/$NAME/html --allow-root >/dev/null 2>&1
    /usr/local/lsws/lsphp${phien_ban_php_domain_thuc_thi}/bin/php /usr/local/bin/wp option update siteurl "https://www.$NAME" --path=/usr/local/lsws/$NAME/html --allow-root >/dev/null 2>&1
  else
    /usr/local/lsws/lsphp${phien_ban_php_domain_thuc_thi}/bin/php /usr/local/bin/wp option update home "https://$NAME" --path=/usr/local/lsws/$NAME/html --allow-root >/dev/null 2>&1
    /usr/local/lsws/lsphp${phien_ban_php_domain_thuc_thi}/bin/php /usr/local/bin/wp option update siteurl "https://$NAME" --path=/usr/local/lsws/$NAME/html --allow-root >/dev/null 2>&1
  fi
fi

checkdns=$(host $NAME | grep -Eo -m 1 '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}')
if [[ "$checkdns" = "" ]]; then
  checkdns=$(nslookup $NAME | grep Address | cut -f5 | grep -Eo -m 1 '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}')
fi

ip=$(curl -skf --connect-timeout 5 --max-time 10 https://ipv4.icanhazip.com | grep -E -o '(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)' || curl -skf --connect-timeout 5 --max-time 10 https://checkip.amazonaws.com | grep -E -o '(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)')

checkdnscname=$(host www.$NAME | grep -Eo -m 1 '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}')
if [[ "$checkdnscname" = "" ]]; then
  checkdnscname=$(nslookup www.$NAME | grep Address | cut -f5 | grep -Eo -m 1 '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}')
fi

path2="/usr/local/lsws/$NAME/html/.htaccess"

grepwww=$(grep -c 'RewriteCond %{HTTP_HOST} ^www' $path2)
grepwww2=$(grep -c 'RewriteCond %{HTTP_HOST} !^www' $path2)
grepssl=$(grep -c 'RewriteCond %{HTTPS}' $path2)

#x√≥a chuy·ªÉn h∆∞·ªõng http to https
#sed -i '/RewriteCond %{HTTPS} !=on/,+1d' "$path2"
sed -i -e '/^#begin-chuyen-huong-http-to-https-wptangtoc-ols/,/^#end-chuyen-huong-http-to-https-wptangtoc-ols$/d' /usr/local/lsws/$NAME/html/.htaccess
# if [[ ! -f /etc/wptt/chuyen-huong/.$NAME.conf ]];then #t∆∞∆°ng th√≠ch kh√¥ng th·ª±c thi l·ªánh n√†y v·ªõi website chuy·ªÉn h∆∞·ªõng
#x√≥a chuy·ªÉn h∆∞·ªõng www to non-www
sed -i -e '/^#begin-chuyen-huong-www-to-non-www-wptangtoc-ols/,/^#end-chuyen-huong-www-to-non-www-wptangtoc-ols$/d' /usr/local/lsws/$NAME/html/.htaccess
# sed -i '/RewriteCond %{HTTP_HOST} ^www/,+1d' "$path2"
#x√≥a chuy·ªÉn h∆∞·ªõng non-www to www
sed -i -e '/^#begin-chuyen-huong-non-www-to-www-wptangtoc-ols/,/^#end-chuyen-huong-non-www-to-www-wptangtoc-ols$/d' /usr/local/lsws/$NAME/html/.htaccess
# sed -i '/RewriteCond %{HTTP_HOST} ^'$NAME' /,+1d' "$path2"
# fi
#end x√≥a chuy·ªÉn h∆∞·ªõng http to https

#chuy·ªÉn h∆∞·ªõng http to https
sed -i '1 i #begin-chuyen-huong-http-to-https-wptangtoc-ols\
RewriteCond %{HTTPS} !=on\
RewriteRule ^(.*)$ https:\/\/%{HTTP_HOST}%{REQUEST_URI} [L,R=301,NE]\
#end-chuyen-huong-http-to-https-wptangtoc-ols' /usr/local/lsws/"$NAME"/html/.htaccess

if [[ "$checkdns" = "$checkdnscname" ]]; then
  #chuy·ªÉn h∆∞·ªõng www to non www
  sed -i '1 i #begin-chuyen-huong-www-to-non-www-wptangtoc-ols\
RewriteCond %{HTTP_HOST} ^www.'$NAME' [NC]\
RewriteRule ^(.*)$ https:\/\/'$NAME'/$1 [L,R=301,NC]\
#end-chuyen-huong-www-to-non-www-wptangtoc-ols' /usr/local/lsws/"$NAME"/html/.htaccess
fi

if [[ ! -f /etc/wptt/chuyen-huong/.$NAME.conf ]]; then #t∆∞∆°ng th√≠ch kh√¥ng th·ª±c thi l·ªánh n√†y v·ªõi website chuy·ªÉn h∆∞·ªõng
  if [[ -f /usr/local/lsws/$NAME/html/wp-config.php ]]; then
    . /etc/wptt/php/php-cli-domain-config $NAME

    giatuanwww=$(/usr/local/lsws/lsphp${phien_ban_php_domain_thuc_thi}/bin/php /usr/local/bin/wp option get home --path=/usr/local/lsws/$NAME/html --allow-root 2>/dev/null | grep $NAME | grep 'www.')

    if [[ $giatuanwww ]]; then
      if [[ "$checkdns" = "$checkdnscname" ]]; then

        #x√≥a chuy·ªÉn h∆∞·ªõng www to non www
        sed -i -e '/^#begin-chuyen-huong-www-to-non-www-wptangtoc-ols/,/^#end-chuyen-huong-www-to-non-www-wptangtoc-ols$/d' /usr/local/lsws/$NAME/html/.htaccess
        # sed -i '/RewriteCond %{HTTP_HOST} ^www/,+1d' "$path2"

        #chuy·ªÉn h∆∞·ªõng non-www to www
        # sed -i '1 i RewriteCond %{HTTP_HOST} ^'$NAME' [NC]\
        # RewriteRule ^(.*)$ https:\/\/www.'$NAME'/$1 [L,R=301,NC]' /usr/local/lsws/"$NAME"/html/.htaccess
        #chuy·ªÉn h∆∞·ªõng non-www to www
        sed -i '1 i #begin-chuyen-huong-non-www-to-www-wptangtoc-ols\
RewriteCond %{HTTP_HOST} ^'$NAME' [NC]\
RewriteRule ^(.*)$ https:\/\/www\.'$NAME'/$1 [L,R=301,NC]\
#end-chuyen-huong-non-www-to-www-wptangtoc-ols' /usr/local/lsws/"$NAME"/html/.htaccess

      fi
    fi

  fi
fi

/usr/local/lsws/bin/lswsctrl restart >/dev/null 2>&1
echo "C·∫•u h√¨nh renew chuy·ªÉn h∆∞·ªõng website $NAME: $(date '+%d-%m-%Y %H:%M')" >>/var/log/wptangtoc-ols.log

_rundone "C·∫•u h√¨nh renew chuy·ªÉn h∆∞·ªõng"

check_menu_wptangtoc_active=$1
if [[ $check_menu_wptangtoc_active = "98" ]]; then
  . /etc/wptt/wptt-ssl-main 1
fi
