#!/bin/bash
# @author: Gia Tuáº¥n
# @website: https://wptangtoc.com
# @since: 2025

function huong_dan() {
  CÃ i Ä‘áº·t SSL miá»…n phÃ­: Dá»… dÃ ng cÃ i Ä‘áº·t chá»©ng chá»‰ SSL tá»« Lets Encrypt cho cÃ¡c tÃªn miá»n cá»§a báº¡n mÃ  khÃ´ng tá»‘n chi phÃ­.

  TÃ­nh nÄƒng CÃ i SSL Lets Encrypt lÃ  cÃ i Ä‘áº·t chá»©ng chá»‰ SSL/TLS miá»…n phÃ­ tá»« Lets Encrypt cho website cá»§a báº¡n, qua Ä‘Ã³ kÃ­ch hoáº¡t giao thá»©c HTTPS [káº¿t ná»‘i an toÃ n, mÃ£ hÃ³a].

  NÃ³i má»™t cÃ¡ch Ä‘Æ¡n giáº£n, Ä‘Ã¢y lÃ  cÃ¡ch Ä‘á»ƒ website cá»§a báº¡n cÃ³ biá»ƒu tÆ°á»£ng á»• khÃ³a ðŸ”’ trÃªn trÃ¬nh duyá»‡t, Ä‘áº£m báº£o dá»¯ liá»‡u truyá»n Ä‘i giá»¯a ngÆ°á»i dÃ¹ng vÃ  website Ä‘Æ°á»£c báº£o máº­t, vÃ  thÆ°á»ng Ä‘Æ°á»£c thá»±c hiá»‡n má»™t cÃ¡ch tá»± Ä‘á»™ng hoáº·c ráº¥t Ä‘Æ¡n giáº£n.

  Má»¥c ÄÃ­ch ChÃ­nh
  * Báº£o máº­t dá»¯ liá»‡u: MÃ£ hÃ³a thÃ´ng tin trao Ä‘á»•i [nhÆ° máº­t kháº©u, thÃ´ng tin cÃ¡ nhÃ¢n, tháº» tÃ­n dá»¥ng] giá»¯a trÃ¬nh duyá»‡t cá»§a ngÆ°á»i dÃ¹ng vÃ  website.
  * XÃ¡c thá»±c website: GiÃºp kháº³ng Ä‘á»‹nh website lÃ  Ä‘Ã¡ng tin cáº­y, khÃ´ng pháº£i trang giáº£ máº¡o [Ä‘á»‘i vá»›i loáº¡i chá»©ng chá»‰ Domain Validation - DV mÃ  Lets Encrypt cung cáº¥p].
  * Cáº£i thiá»‡n SEO: CÃ¡c cÃ´ng cá»¥ tÃ¬m kiáº¿m nhÆ° Google Æ°u tiÃªn cÃ¡c website sá»­ dá»¥ng HTTPS.
  * TÄƒng uy tÃ­n: NgÆ°á»i dÃ¹ng cáº£m tháº¥y an tÃ¢m hÆ¡n khi truy cáº­p website cÃ³ HTTPS.

  TÃ­nh nÄƒng cÃ i Ä‘áº·t SSL Lets Encrypt giÃºp viá»‡c báº£o máº­t website trá»Ÿ nÃªn dá»… dÃ ng, miá»…n phÃ­ vÃ  tá»± Ä‘á»™ng, gÃ³p pháº§n lÃ m cho Internet an toÃ n hÆ¡n.

  * Tá»± Ä‘á»™ng gia háº¡n: Chá»©ng chá»‰ SSL Lets Encrypt cÃ³ thá»i háº¡n nháº¥t Ä‘á»‹nh [thÆ°á»ng lÃ  90 ngÃ y]. WPTangToc OLS sáº½ tá»± Ä‘á»™ng thá»±c hiá»‡n quÃ¡ trÃ¬nh gia háº¡n nÃ y, Ä‘áº£m báº£o website cá»§a báº¡n luÃ´n Ä‘Æ°á»£c báº£o vá»‡ báº±ng HTTPS mÃ  khÃ´ng cáº§n can thiá»‡p thá»§ cÃ´ng.
  * Há»— trá»£ cho nhiá»u tÃªn miá»n: Báº¡n cÃ³ thá»ƒ quáº£n lÃ½ vÃ  cÃ i Ä‘áº·t SSL cho nhiá»u tÃªn miá»n vÃ  tÃªn miá»n phá»¥ trÃªn cÃ¹ng má»™t mÃ¡y chá»§.
  * Tá»± Ä‘á»™ng chuyá»ƒn hÆ°á»›ng HTTP sang HTTPS: Sau khi cÃ i Ä‘áº·t SSL thÃ nh cÃ´ng, WPTangToc OLS thÆ°á»ng sáº½ há»— trá»£ cáº¥u hÃ¬nh tá»± Ä‘á»™ng chuyá»ƒn hÆ°á»›ng truy cáº­p tá»« HTTP sang HTTPS, giÃºp Ä‘áº£m báº£o an toÃ n vÃ  cáº£i thiá»‡n SEO.
}

. /etc/wptt/.wptt.conf
if [[ $ngon_ngu = '' ]]; then
  ngon_ngu='vi'
fi
. /etc/wptt/lang/$ngon_ngu.sh

echo ""
echo ""
echo ""
echo "========================================================================="
echo "|$quan_ly_ssl => $cai_dat_ssl_letencrypt                            |"
echo "========================================================================="

. /etc/wptt/echo-color

NAME=$1

if [[ $NAME = "98" ]]; then
  NAME=""
fi

if [[ "$NAME" = "" ]]; then

  echo "$lua_chon_website_ban_muon $thiet_lap $chung_chi SSL letsencrypt (HTTPS): "
  function lua_chon_NAME() {
    NAME=""
    if [ "$(ls -At /etc/wptt/vhost)" ]; then
      selects=()
      for entry in $(ls -A /etc/wptt/vhost | sort -uV); do
        NAME=$(echo $entry | sed 's/^.//' | sed 's/.conf//')
        if [ "$NAME" != "${NAME/./}" ] && [ "$NAME" != '.' ]; then #Ä‘iá»u kiá»‡n domain pháº£i cÃ³ dáº¥u . vÃ  lá»—i chá»‰ cÃ³ only .
          selects+=("$NAME")
        fi
      done

      #add domain chuyá»ƒn hÆ°á»›ng
      if [[ -d /etc/wptt/chuyen-huong ]]; then
        if [[ $(ls -A /etc/wptt/chuyen-huong | grep '\.conf' | wc -l) != '0' ]]; then
          for entry2 in $(ls -A /etc/wptt/chuyen-huong); do
            NAME=$(echo $entry2 | sed 's/^.//' | sed 's/.conf//')
            if [ "$NAME" != "${NAME/./}" ] && [ "$NAME" != '.' ]; then #Ä‘iá»u kiá»‡n domain pháº£i cÃ³ dáº¥u . vÃ  lá»—i chá»‰ cÃ³ only .
              selects+=("$NAME")
            fi
          done
        fi
      fi

      PS3="
$(tput setab 0)-//- $nhap_lua_chon_website_cua_ban [0=$exit_thoat]:$(tput sgr0) "
      select select in ${selects[@]}; do
        NAME=$select
        index=$REPLY
        break
      done
    else
      clear
      echo "$khong_co_domain_nao_ton_tai_tren_he_thong"
      exit
    fi
  }

  # . /etc/wptt/tenmien
  # echo ""
  # echo ""
  # echo ""
  lua_chon_NAME
fi

if [[ $NAME = "0" || $NAME = '' ]]; then
  . /etc/wptt/wptt-ssl-main 1
fi

#tuong thich voi lockdown
unset lock_down
if [[ -f /etc/wptt/vhost/.$NAME.conf ]]; then #if tháº¿ nÃ y Ä‘á»ƒ tÆ°Æ¡ng vá»›i website chuyá»ƒn hÆ°á»›ng
  . /etc/wptt/vhost/.$NAME.conf
  if [[ $lock_down ]]; then
    if [[ -d /usr/local/lsws/$NAME/html/.well-known ]]; then
      rm -rf /usr/local/lsws/$NAME/html/.well-known
    fi
  fi
fi

path="/etc/wptt/vhost/.$NAME.conf"
if [[ ! -f "$path" && ! -f /etc/wptt/chuyen-huong/.$NAME.conf ]]; then
  clear
  echoDo "$ten_mien_nay_khong_ton_tai_tren_he_thong"
  sleep 3
  . /etc/wptt/wptt-ssl-main 1
  exit
fi

echo "CÃ i Ä‘áº·t SSL free letsencrypt website $NAME: $(date '+%d-%m-%Y %H:%M')" >>/var/log/wptangtoc-ols.log

if [[ ! -d /usr/local/lsws/$NAME/html ]]; then
  echoDo "Há»‡ thá»‘ng khÃ´ng xÃ¡c nháº­n Ä‘Æ°á»£c thÆ° má»¥c mÃ£ nguá»“n cá»§a website $NAME"
  echoDo "Thu muc ma nguon tieu chuan cua WPTangToc OLS: /usr/local/lsws/$NAME/html khong hop le"
  echoDo "Nguyen nhan dan den viec nay co the ban da thay doi cau truc thu muc hoac su dung unikey de them tien mien"
  echoDo "Vui long kiem tra lai duong dan thu muc cua ban"
  echoDo "Ho tro sua loi		: https://wptangtoc.com/lien-he/"
  exit
fi

if [[ -f /etc/wptt/.cloudflare/wptt-$NAME.ini ]]; then
  echo "$cai SSL by Cloudflare API DNS"
  . /etc/wptt/ssl/wptt-caissl-cloudlflare-api-dns $NAME 98
  return 2>/dev/null
  exit
fi

check_http_online=$(curl -Is http://$NAME)
if [[ $check_http_online = "" ]]; then
  check_http_online=$(curl -Is http://$NAME)
  if [[ $check_http_online = "" ]]; then
    echo "Kiá»ƒm tra website $NAME khÃ´ng hoáº¡t Ä‘á»™ng vÃ¬ váº­y khÃ´ng tháº¿ cÃ i Ä‘áº·t Ä‘Æ°á»£c chá»©ng chá»‰ SSL"
    . /etc/wptt/wptt-ssl-main 1
    return 2>/dev/null
    exit
  fi
fi

_runing "$cai_dat $chung_chi SSL letsencrypt website $NAME"

#check dns ipv4
checkdns=$(host $NAME | grep -Eo -m 1 '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}')
checkdns2=$(nslookup $NAME | grep Address | cut -f5 | grep -Eo -m 1 '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}')
checkdns3_api_google_check_dns_online_ipv4=$(curl -s --connect-timeout 5 https://dns.google/resolve?name=${NAME}\&type=A | grep -E -o '(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)' | head -1)

api_cloudflare_dns_check_ipv4=$(curl -s --connect-timeout 5 -H 'accept: application/dns-json' 'https://cloudflare-dns.com/dns-query?name='${NAME}'&type=A' | grep -E -o '(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)' | head -1)

ip=$(ip a | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' | sed '/127.0.0.1/d' | sed '/192.168/d' | sort -u)
ip+=$(curl -sf --connect-timeout 5 --max-time 10 https://ipv4.icanhazip.com || curl -sf --connect-timeout 5 --max-time 10 https://checkip.amazonaws.com | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}')
if [[ $ip ]]; then #kiá»ƒm tra xem server cÃ³ support ipv4 khÃ´ng?
  if ! [[ $(echo $ip | grep $checkdns 2>/dev/null) || $(echo $ip | grep $checkdns2 2>/dev/null) || $(echo $ip | grep $checkdns3_api_google_check_dns_online_ipv4 2>/dev/null) || $(echo $ip | grep $api_cloudflare_dns_check_ipv4 2>/dev/null) ]]; then
    error_ssl_ipv4='1'
  fi
fi

#xac thuc kiem tra da tro ip ipv6 dns chua

check_server_dang_su_dung_ipv6=$(cat /usr/local/lsws/conf/httpd_config.conf | grep 'address' | grep '\[ANY\]') #kiá»ƒm tra litespeed Ä‘ang sá»­ dá»¥ng ipv6 khÃ´ng
if [[ $check_server_dang_su_dung_ipv6 ]]; then

  unset checkdns checkdns2 checkdns3_api_google_check_dns_online_ipv6 api_cloudflare_dns_check_ipv6 ip
  checkdns=$(host $NAME | grep IPv6 | grep -Eio '([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|:(:[0-9a-fA-F]{1,4}){1,7}|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])')
  checkdns2=$(nslookup $NAME | grep 'Address:' | grep -Eio '([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|:(:[0-9a-fA-F]{1,4}){1,7}|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])')
  checkdns3_api_google_check_dns_online_ipv6=$(curl -s --connect-timeout 5 https://dns.google/resolve?name=${NAME}\&type=AAAA | grep -oE '\b([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}\b|\b([0-9a-fA-F]{1,4}:){1,7}:\b|\b([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}\b|\b([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}\b|\b([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}\b|\b([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}\b|\b([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}\b|\b[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})\b|\b:((:[0-9a-fA-F]{1,4}){1,7}|:)\b|\bfe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}\b|\b::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\b|\b([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\b' | head -1)

  api_cloudflare_dns_check_ipv6=$(curl -s --connect-timeout 5 -H 'accept: application/dns-json' 'https://cloudflare-dns.com/dns-query?name='${NAME}'&type=AAAA' | grep -oE '\b([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}\b|\b([0-9a-fA-F]{1,4}:){1,7}:\b|\b([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}\b|\b([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}\b|\b([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}\b|\b([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}\b|\b([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}\b|\b[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})\b|\b:((:[0-9a-fA-F]{1,4}){1,7}|:)\b|\bfe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}\b|\b::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\b|\b([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\b' | head -1)

  ip=$(ip -6 a | grep 'inet6 ' | awk '{print $2}' | sed '/fe80::/d' | sed '/::1/d' | sort -u | cut -f1 -d '/')
  ip+=$(curl -s https://ipv6.icanhazip.com)
  if [[ $ip ]]; then #kiá»ƒm tra server cÃ³ support ipv6 khÃ´ng?
    if ! [[ $(echo $ip | grep $checkdns 2>/dev/null) || $(echo $ip | grep $checkdns2 2>/dev/null) || $(echo $ip | grep $checkdns3_api_google_check_dns_online_ipv6 2>/dev/null) || $(echo $ip | grep $api_cloudflare_dns_check_ipv6 2>/dev/null) ]]; then
      error_ssl_ipv6='1'
    fi
  fi
else
  error_ssl_ipv6='1' #check litespeed khÃ´ng support ipv6
fi

if [[ $error_ssl_ipv4 = '1' && $error_ssl_ipv6 = '1' ]]; then
  checknameserver=$(host -t ns $NAME)
  _runloi "$cai_dat $chung_chi SSL letsencrypt website $NAME"

  TRACE_OUTPUT=$(curl -Is --connect-timeout 5 --max-time 10 "https://$NAME/cdn-cgi/trace" 2>/dev/null)

  # Kiá»ƒm tra output cÃ³ chá»©a cÃ¡c key Ä‘áº·c trÆ°ng cá»§a Cloudflare khÃ´ng
  if echo "$TRACE_OUTPUT" | grep -qi 'cloudflare\|cf-ray'; then #check xem cÃ³ Ä‘ang sá»­ dá»¥ng cloudflare cdn khÃ´ng
    echo "PhÃ¡t hiá»‡n website $NAME Ä‘ang sá»­ dá»¥ng Cloudflare CDN"
    echo "Khi báº¡n Ä‘Ã£ sá»­ dá»¥ng ssl cloudflare cdn rá»“i"
    echo "thÃ¬ báº¡n lÃ m gÃ¬ cáº§n pháº£i cÃ i Ä‘áº·t ssl letsencrypt lÃ m gÃ¬ ná»¯a"
    check_website_cdn_cloudflare_online=$(curl -Is --connect-timeout 5 --max-time 10 https://$NAME | head -1 | grep '200' || curl -Is --connect-timeout 5 --max-time 10 https://www.$NAME | head -1 | grep '200')
    if [[ $check_website_cdn_cloudflare_online ]]; then
      echo "Há»‡ thá»‘ng kiá»ƒm tra thÃ¬ báº¡n Ä‘ang sá»­ dá»¥ng SSL cloudflare hoáº¡t Ä‘á»™ng hoÃ n tÃ¬nh bÃ¬nh thÆ°á»ng"
    else
      echo "Báº¡n hÃ£y vÃ o dashboard cloudflare => SSL/TLS =>Overview hÃ£y chuyá»ƒn vá» cháº¿ Ä‘á»™ SSL Full hoáº·c Flexible"
      echo "ThÃ¬ website sáº½ hoáº¡t Ä‘á»™ng nhÆ° bÃ¬nh thÆ°á»ng nhÃ©"
    fi

    check_menu_wptangtoc_active=$1
    if [[ $check_menu_wptangtoc_active = "98" ]]; then
      . /etc/wptt/wptt-ssl-main 1
    fi
    return 2>/dev/null
    exit
  fi

  echo "$cai_dat $chung_chi SSL $khong_thanh_cong - thÃ´ng bÃ¡o lá»—i"
  unset ip
  ip=$(curl -skf --connect-timeout 5 --max-time 10 https://ipv4.icanhazip.com | grep -E -o '(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)' || curl -skf --connect-timeout 5 --max-time 10 https://checkip.amazonaws.com | grep -E -o '(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)')
  echo "Báº¡n chÆ°a trá» tÃªn miá»n DNS $NAME vá» mÃ¡y chá»§ IP: $ip"
  echo "HÃ£y trá» DNS thÃ¬ má»›i cÃ³ thá»ƒ cÃ i Ä‘Æ°á»£c chá»©ng chá»‰ SSL"
  echo "HÃ£y trá» DNS $checkdns thÃ nh $ip rá»“i quay trá»Ÿ láº¡i Ä‘á»ƒ cÃ i chá»©ng chá»‰ SSL"
  if [[ "$checkdns" = "" ]]; then
    echo "$ten_mien $NAME $chua_duoc_tro_ip. $ban_vui_long_tro_ip_ve $ip"
  fi
  echo "$ten_mien $NAME Ä‘ang Ä‘Æ°á»£c quáº£n lÃ½ bá»Ÿi $checknameserver báº¡n hÃ£y truy cáº­p vÃ o Ä‘á»ƒ trá» tÃªn miá»n cá»§a mÃ¬nh vá» $ip"
  check_menu_wptangtoc_active=$1
  if [[ $check_menu_wptangtoc_active = "98" ]]; then
    . /etc/wptt/wptt-ssl-main 1
  fi
  return 2>/dev/null
  exit
fi

#cli check ipv4 vÃ  ipv6: grep -Eio '([0-9]{1,3}\.){3}[0-9]{1,3}|[0-9a-fA-F:]{2,}(:[0-9a-fA-F]{0,4}){1,}'
checkdnscname=$(host www.$NAME | grep -Eio '([0-9]{1,3}\.){3}[0-9]{1,3}|[0-9a-fA-F:]{2,}(:[0-9a-fA-F]{0,4}){1,}')
checkdnscname2=$(nslookup www.$NAME | grep Address | cut -f5 | grep -Eio '([0-9]{1,3}\.){3}[0-9]{1,3}|[0-9a-fA-F:]{2,}(:[0-9a-fA-F]{0,4}){1,}')
checkdnscname3_www_api_google_check_dns_online_ipv4=$(curl -s --connect-timeout 5 https://dns.google/resolve?name=www.${NAME}\&type=A | grep -E -o '(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)' | head -1)

checkcname_www_api_cloudflare_dns_check_ipv4=$(curl -s --connect-timeout 5 -H 'accept: application/dns-json' 'https://cloudflare-dns.com/dns-query?name=www.'${NAME}'&type=A' | grep -E -o '(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)' | head -1)

if [[ $(echo $ip | grep $checkdnscname 2>/dev/null) = '' || $checkdnscname = '' ]]; then #kiÃªÌ‰m tra xem troÌ‰ Ä‘uÌng ip www Ä‘aÌƒ troÌ‰ Ä‘uÌng ip chÆ°a
  checkdnscname='172.168.0.1'
fi

if [[ $(echo $ip | grep $checkdnscname2 2>/dev/null) = '' || $checkdnscname2 = '' ]]; then
  checkdnscname2='172.168.0.1'
fi

if [[ $(echo $ip | grep $checkdnscname3_www_api_google_check_dns_online_ipv4 2>/dev/null) = '' || $checkdnscname3_www_api_google_check_dns_online_ipv4 = '' ]]; then
  checkdnscname3_www_api_google_check_dns_online_ipv4='172.168.0.1'
fi

if [[ $(echo $ip | grep $checkcname_www_api_cloudflare_dns_check_ipv4 2>/dev/null) = '' || $checkcname_www_api_cloudflare_dns_check_ipv4 = '' ]]; then
  checkcname_www_api_cloudflare_dns_check_ipv4='172.168.0.1'
fi

# check_dev_wptangtoc=$(echo $check_http_online | grep 'WPTangTocOLS')
# if [[ $wptangtoc_ols_giatuan = '' ]];then
# 	if [[ $check_dev_wptangtoc = "" ]];then
# 		_runloi "$cai_dat $chung_chi SSL letsencrypt website $NAME"
# 		echoDo "Báº¡n khÃ´ng thá»ƒ cÃ i Ä‘áº·t chá»©ng chá»‰ SSL"
# 		echoDo "Vui lÃ²ng $yeu_cau_ho_tro vá»›i tÃ¡c giáº£ $gia_tuan Ä‘á»ƒ Ä‘Æ°á»£c trá»£ giÃºp"
# 		. /etc/wptt/wptt-ssl-main 1
# 		return 2>/dev/null ; exit
# 	fi
# fi

rm -f /tmp/ssl-$NAME.txt

if [[ -f "/etc/letsencrypt/live/$NAME/cert.pem" ]]; then
  echo "Báº¡n Ä‘Ã£ cÃ i Ä‘áº·t SSL trÆ°á»›c Ä‘Ã³ cho website $NAME rá»“i"
  echo "Subdomain báº¡n cÃ³ muá»‘n má»Ÿ rá»™ng thÃªm chÃºng chá»‰ SSL sá»­ dá»¥ng cÃ¹ng 1 chá»©ng chi website $NAME"
  read -p "Báº¡n cÃ³ muá»‘n má»Ÿ rá»™ng chá»©ng chá»‰ ssl website $NAME khÃ´ng ? (y/n): " renew
  if [[ "$renew" = "y" ]]; then
    . /etc/wptt/ssl/wptt-mo-rong-ssl-free $NAME
  else
    . /etc/wptt/wptt-ssl-main 1
    exit
  fi
fi

if [[ -f "/etc/letsencrypt/live/$NAME-0001/cert.pem" ]]; then
  echo "Ban da cai dat SSL cho $NAME roi"
  read -p "Ban co muon renew lai ssl khong? (y/n): " renew
  if [[ "$renew" = "y" ]]; then
    echo "Tien hanh xoa SSL cu cua ban"
    certbot revoke --cert-path /etc/letsencrypt/live/$NAME-0001/cert.pem
    rm -rf /etc/letsencrypt/live/$NAME-0001
  else
    . /etc/wptt/wptt-ssl-main 1
    exit
  fi
fi

#tu dong them subdomain multisite wordpress
if [[ -f /usr/local/lsws/$NAME/html/wp-config.php ]]; then
  check_mulsite_dang_su_dung=$(cat /usr/local/lsws/$NAME/html/wp-config.php | grep MULTISITE)
  if [[ $check_mulsite_dang_su_dung ]]; then
    sub_domain_multisite=$(wp site list --field=url --path=/usr/local/lsws/$NAME/html --allow-root 2>/dev/null | cut -f3 -d '/' | sort -u | uniq)
    echo "$sub_domain_multisite" >>/tmp/ssl-$NAME.txt
  fi
fi

#kiem tra mo rong ssl da tro ip chua
if [[ -f /tmp/ssl-$NAME.txt ]]; then
  multisite_check_dns_tro_ip_chua=($(cat /tmp/ssl-$NAME.txt))
  for multisite in ${multisite_check_dns_tro_ip_chua[@]}; do
    multisite_check_dns=$(host $multisite | grep -Eio '([0-9]{1,3}\.){3}[0-9]{1,3}|[0-9a-fA-F:]{2,}(:[0-9a-fA-F]{0,4}){1,}')
    if [[ $multisite_check_dns != $ip ]]; then
      echo ''
      echo "domain $multisite chua tro dns ve $ip de co the cai SSL"
      sed -i "/$multisite/d" /tmp/ssl-$NAME.txt
    fi
  done
fi

echo "$NAME" >>/tmp/ssl-$NAME.txt

#Ä‘iá»u kiá»‡n kiá»ƒm tra xem website cÃ³ trá» www khÃ´ng
if [[ "$checkdns" = "$checkdnscname" || "$checkdns2" = "$checkdnscname2" || "$checkdns" = "$checkdnscname2" || "$checkdns2" = "$checkdnscname" || "$checkdns3_api_google_check_dns_online_ipv4" = "$checkdnscname3_www_api_google_check_dns_online_ipv4" || "$api_cloudflare_dns_check_ipv4" = "$checkcname_www_api_cloudflare_dns_check_ipv4" ]]; then

  #check Ä‘iá»u kiá»‡n www ngÆ°á»i dÃ¹ng cÃ³ trá» dns nhÆ°ng mÃ  hÃ£ng dns bá»‹ lá»—i
  if [[ $(host www.$NAME | grep -q 'SERVFAIL') = '' ]]; then
    echo "www.$NAME" >>/tmp/ssl-$NAME.txt
  fi
fi

# echo "Dang tien hanh cai SSL cho website $NAME..."
# list_all_ssl_thong_bao=($(cat /tmp/ssl-$NAME.txt | sort -u | sed '/^$/d' | uniq))
# for domain_ssl in ${list_all_ssl_thong_bao[@]};do
# echo "Tien hanh cai dat ssl domain: $domain_ssl"
# done

#náº¡p toÃ¡n bá»™ biáº¿n táº¥t cáº£ subdomain vÃ  domain
list_ssl_domain_all=$(cat /tmp/ssl-$NAME.txt | sort -u | uniq | sed '/^$/d' | sed 's/^/-d /g' | tr -s '\n' ' ')

#tiáº¿n hÃ nh thá»±c thi cÃ i Ä‘áº·t ssl

duong_dan_docroot_web=$(cat /usr/local/lsws/conf/vhosts/$NAME/$NAME.conf | grep 'docRoot' | awk '{print $2}' | head -1) #truy tÃ¬m docRoot Ä‘á»ƒ tÆ°Æ¡ng thÃ­ch khi ngÆ°á»i dÃ¹ng cá»‘ gáº¯ng custom Ä‘Æ°á»ng dáº«n path
# certbot certonly --non-interactive --agree-tos --register-unsafely-without-email --expand --webroot -w /usr/local/lsws/$NAME/html/ $list_ssl_domain_all >/dev/null 2>&1

certbot certonly --non-interactive --agree-tos --register-unsafely-without-email --expand --webroot -w ${duong_dan_docroot_web} $list_ssl_domain_all >/dev/null 2>&1

#setup láº¡i vhost náº¿u trong trÆ°á»ng há»£p ngÆ°á»i dÃ¹ng Ä‘Ã£ kÃ­ch hoáº¡t ssl tráº£ phÃ­ trÆ°á»›c Ä‘Ã³ Ä‘á»ƒ clean láº¡i
sed -i -e '/^vhssl /,/^}$/d' /usr/local/lsws/conf/vhosts/$NAME/$NAME.conf
echo "vhssl  {
keyFile                 /etc/letsencrypt/live/$NAME/privkey.pem
certFile                /etc/letsencrypt/live/$NAME/cert.pem
certChain               0
CACertFile              /etc/letsencrypt/live/$NAME/chain.pem
sslProtocol             24
renegProtection         1
sslSessionCache         1
sslSessionTickets       1
enableSpdy              15
enableQuic              1
}

" >>/usr/local/lsws/conf/vhosts/"$NAME"/"$NAME".conf

#xoÃ¡ ssl tá»± kÃ½ dai dien port
if [[ "$NAME" = "$Website_chinh" ]]; then
  sed -i "/keyFile/d" /usr/local/lsws/conf/httpd_config.conf
  sed -i "/certFile/d" /usr/local/lsws/conf/httpd_config.conf
  sed -i "/CACertFile/d" /usr/local/lsws/conf/httpd_config.conf

  sed -i "/https/a   keyFile              \/etc\/letsencrypt\/live\/${NAME}\/privkey.pem" /usr/local/lsws/conf/httpd_config.conf
  sed -i "/https/a   certFile             \/etc\/letsencrypt\/live\/${NAME}\/cert.pem" /usr/local/lsws/conf/httpd_config.conf
  sed -i "/https/a   CACertFile           \/etc\/letsencrypt\/live\/${NAME}\/chain.pem" /usr/local/lsws/conf/httpd_config.conf
fi

/usr/local/lsws/bin/lswsctrl restart >/dev/null 2>&1

# tu dong chuyen thu muc www cho ve non-www náº¿u letsencrypt táº¡o thÆ° má»¥c www
if [[ -d /etc/letsencrypt/live/www.$NAME ]]; then
  ln -s /etc/letsencrypt/live/www.$NAME /etc/letsencrypt/live/$NAME
fi

http_status=$(curl -o /dev/null -s -w "%{http_code}" "https://${NAME}")

# 1. File chá»©ng chá»‰ khÃ´ng tá»“n táº¡i, HOáº¶C
# 2. MÃ£ tráº¡ng thÃ¡i HTTP khÃ´ng pháº£i lÃ  200 VÃ€ cÅ©ng khÃ´ng pháº£i lÃ  301
if [[ ! -f "/etc/letsencrypt/live/$NAME/cert.pem" || ("$http_status" -ne 200 && "$http_status" -ne 301 && "$http_status" -ne 404) ]]; then
  _runloi "CÃ i Ä‘áº·t chá»©ng chá»‰ SSL letsencrypt cho website $NAME"
  echoDo "QuÃ¡ trÃ¬nh cÃ i Ä‘áº·t SSL khÃ´ng thÃ nh cÃ´ng, Ä‘Ã£ xáº£y ra sá»± cá»‘"
  if [[ -f "/etc/letsencrypt/live/$NAME/cert.pem" ]]; then
    echo "Chá»©ng chá»‰ SSL cá»§a báº¡n Ä‘Ã£ Ä‘Æ°á»£c cÃ i Ä‘áº·t, kiá»ƒm tra thá»±c táº¿ https://$NAME thÃ¬ khÃ´ng hoáº¡t Ä‘á»™ng"
    # . /etc/wptt/.wptt.conf
    # if [[ "$Website_chinh" != "$NAME" && ! -f "/etc/letsencrypt/live/$Website_chinh/cert.pem" && ! -d "/usr/local/lsws/$Website_chinh/ssl" ]]; then
    # 	echo "Website chÃ­nh $Website_chinh chÆ°a Ä‘Æ°á»£c cÃ i Ä‘áº·t SSL"
    # 	echo "vui lÃ²ng cÃ i Ä‘áº·t SSL cho website $Website_chinh trÆ°á»›c thÃ¬ cÃ¡c website khÃ¡c má»›i má»›i cÃ³ thá»ƒ sá»­ dá»¥ng HTTPS"
    # fi
  else
    echo "Chá»©ng chá»‰ SSL cÃ i Ä‘áº·t khÃ´ng thÃ nh cÃ´ng, báº¡n cÃ³ thá»ƒ xem nguyÃªn nhÃ¢n khÃ´ng cÃ i Ä‘Æ°á»£c SSL táº¡i Ä‘Ã¢y: /var/log/letsencrypt"
  fi

  if [[ -f "/etc/letsencrypt/live/$NAME-0001/cert.pem" && ! -f "/etc/letsencrypt/live/$NAME/cert.pem" ]]; then
    clear
    echo "Tien hanh fix loi ssl"
    sed -i "s:/etc/letsencrypt/live/$NAME:/etc/letsencrypt/live/$NAME-0001:g" /usr/local/lsws/conf/vhosts/$NAME/$NAME.conf
    echo "Chuyen doi cai ssl 2 lan lien tiep"
    echoDone "Hoan tat kich hoat lai SSL"
    /usr/local/lsws/bin/lswsctrl restart >/dev/null 2>&1
  fi
  exit
else
  _rundone "$cai_dat $chung_chi SSL letsencrypt website $NAME"
fi
sleep 1

_runing "$renew_thiet_lap_chuyen_huong_http_sang_https"

#táº¡m thá»i bypass chuyá»ƒn hÆ°á»›ng website to website, khÃ´ng cáº§n renew http sang https
. /etc/wptt/ssl/wptt-renew-chuyen-huong $NAME >/dev/null 2>&1

if [[ "$checkdns" = "$checkdnscname" || "$checkdns2" = "$checkdnscname2" || "$checkdns" = "$checkdnscname2" || "$checkdns2" = "$checkdnscname" ]]; then
  chuyenhuongwww="Tu dong chuyen huong www.$NAME sang $NAME"
fi

_rundone "$renew_thiet_lap_chuyen_huong_http_sang_https"

echo "========================================================================="
echo "$phat_trien_boi_gia_tuan"
echo "========================================================================="
if [[ "$renew" = "y" ]]; then
  echo "========================================================================="
  echo "SSL cua $NAME da duoc renew"
  echo "========================================================================="
fi

/usr/local/lsws/bin/lswsctrl restart >/dev/null 2>&1
#config vhost chuyá»ƒn cáº¥u hÃ¬nh htaccess
if [[ -f /etc/wptt/vhost/.$NAME.conf ]]; then
  . /etc/wptt/vhost/.$NAME.conf
  if [[ $vhost_chuyen_htaccess ]]; then
    . /etc/wptt/wptt-vhost-chuyen-ve-htaccess $NAME >/dev/null 2>&1
  fi
fi

#tuong thich csf tu dong mo port 443, trÃ¡nh tÃ¬nh tráº¡ng chÆ°a cÃ i ssl Ä‘Ã£ vá»™i cÃ i csf
if [[ -f /etc/csf/csf.conf ]]; then
  if [[ $(cat /etc/csf/csf.conf | grep '^TCP_IN' | grep "443") = '' ]]; then
    sed -i "s/^TCP_IN = \"/TCP_IN = \"443,/g" /etc/csf/csf.conf
    csf -x >/dev/null 2>&1
    csf -e >/dev/null 2>&1
  fi
fi

. /etc/wptt/.wptt.conf
if [[ $download_api ]]; then
  if [[ -f /etc/wptt/add-one/check.sh ]]; then
    if [[ $email_check_downtime && $telegram_id ]]; then
      . /etc/wptt/add-one/check.sh $telegram_id $telegram_api $email >/dev/null 2>&1
    fi
    if [[ -z $email_check_downtime && $telegram_id ]]; then
      . /etc/wptt/add-one/check.sh $telegram_id $telegram_api >/dev/null 2>&1
    fi
    if [[ $email_check_downtime && -z $telegram_id ]]; then
      . /etc/wptt/add-one/check.sh $email_check_downtime >/dev/null 2>&1
    fi
  fi
fi

check_menu_wptangtoc_active=$1
if [[ $check_menu_wptangtoc_active = "98" ]]; then
  . /etc/wptt/wptt-ssl-main 1
fi
