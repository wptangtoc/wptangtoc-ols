#!/bin/bash
# @author: Gia Tuáº¥n
# @website: https://wptangtoc.com
# @email: giatuan@wptangtoc.com
# @since: 2025

function huong_dan() {
  TÃ­nh nÄƒng XÃ³a SSL Lets Encrypt lÃ  quÃ¡ trÃ¬nh gá»¡ bá» má»™t chá»©ng chá»‰ SSL/TLS cá»§a Lets Encrypt Ä‘Ã£ Ä‘Æ°á»£c cÃ i Ä‘áº·t cho má»™t tÃªn miá»n [website] cá»¥ thá»ƒ khá»i mÃ¡y chá»§ web. Äá»“ng thá»i, viá»‡c nÃ y thÆ°á»ng bao gá»“m cáº£ viá»‡c vÃ´ hiá»‡u hÃ³a cáº¥u hÃ¬nh HTTPS liÃªn quan Ä‘áº¿n chá»©ng chá»‰ Ä‘Ã³ vÃ  cÃ³ thá»ƒ dá»«ng tiáº¿n trÃ¬nh tá»± Ä‘á»™ng gia háº¡n cho chá»©ng chá»‰ nÃ y.

  NÃ³i má»™t cÃ¡ch Ä‘Æ¡n giáº£n, Ä‘Ã¢y lÃ  hÃ nh Ä‘á»™ng gá»¡ bá» á»• khÃ³a ðŸ”’ Lets Encrypt khá»i website cá»§a báº¡n, khiáº¿n website Ä‘Ã³ khÃ´ng cÃ²n sá»­ dá»¥ng káº¿t ná»‘i mÃ£ hÃ³a HTTPS thÃ´ng qua chá»©ng chá»‰ Lets Encrypt Ä‘Ã³ ná»¯a.

  Má»¥c ÄÃ­ch ChÃ­nh
  * Khi ngá»«ng sá»­ dá»¥ng website/tÃªn miá»n: Náº¿u website khÃ´ng cÃ²n hoáº¡t Ä‘á»™ng, chá»©ng chá»‰ SSL cá»§a nÃ³ cÅ©ng khÃ´ng cÃ²n cáº§n thiáº¿t.
  * Chuyá»ƒn sang loáº¡i chá»©ng chá»‰ SSL khÃ¡c: Khi báº¡n muá»‘n sá»­ dá»¥ng chá»©ng chá»‰ tá»« má»™t nhÃ  cung cáº¥p khÃ¡c [vÃ­ dá»¥: chá»©ng chá»‰ tráº£ phÃ­ cÃ³ xÃ¡c thá»±c tá»• chá»©c - OV, hoáº·c xÃ¡c thá»±c má»Ÿ rá»™ng - EV].
  * Gá»¡ lá»—i sá»± cá»‘ SSL phá»©c táº¡p: Trong má»™t sá»‘ trÆ°á»ng há»£p, viá»‡c xÃ³a vÃ  cÃ i Ä‘áº·t láº¡i cÃ³ thá»ƒ lÃ  má»™t bÆ°á»›c Ä‘á»ƒ kháº¯c phá»¥c sá»± cá»‘.
  * Cáº¥u hÃ¬nh láº¡i mÃ¡y chá»§: Khi cÃ³ nhá»¯ng thay Ä‘á»•i lá»›n vá» cáº¥u hÃ¬nh mÃ¡y chá»§ hoáº·c chuyá»ƒn Ä‘á»•i mÃ¡y chá»§.
  * Ngá»«ng gia háº¡n tá»± Ä‘á»™ng cho má»™t tÃªn miá»n cá»¥ thá»ƒ: Náº¿u báº¡n khÃ´ng muá»‘n tÃªn miá»n Ä‘Ã³ tiáº¿p tá»¥c sá»­ dá»¥ng HTTPS vá»›i Lets Encrypt.

  Sau khi xÃ³a, website sáº½ khÃ´ng cÃ²n phá»¥c vá»¥ qua HTTPS báº±ng chá»©ng chá»‰ Lets Encrypt Ä‘Ã³ ná»¯a. Náº¿u khÃ´ng cÃ³ chá»©ng chá»‰ nÃ o khÃ¡c Ä‘Æ°á»£c cáº¥u hÃ¬nh, truy cáº­p HTTPS sáº½ tháº¥t báº¡i, vÃ  website cÃ³ thá»ƒ chá»‰ truy cáº­p Ä‘Æ°á»£c qua HTTP [khÃ´ng mÃ£ hÃ³a].
}

. /etc/wptt/.wptt.conf
if [[ $ngon_ngu = '' ]]; then
  ngon_ngu='vi'
fi
. /etc/wptt/lang/$ngon_ngu.sh

. /etc/wptt/echo-color
echo ""
echo ""
echo ""
echo "========================================================================="
echo "|$quan_ly_ssl => $xoa_chung_chi_ssl_letencrypt                      |"
echo "========================================================================="
echo ""
echo ""
echo "$lua_chon_website_ban_muon $xoa_chung_chi_ssl_letencrypt: "
echo ""
function lua_chon_NAME() {
  NAME=""
  if [ "$(ls -At /etc/wptt/vhost)" ]; then
    selects=()
    for entry in $(ls -A /etc/wptt/vhost | sort -uV); do
      NAME=$(echo $entry | sed 's/^.//' | sed 's/.conf//')
      if [ "$NAME" != "${NAME/./}" ]; then
        if [[ -f /etc/letsencrypt/live/$NAME/cert.pem || -f /etc/letsencrypt/live/www.${NAME}/cert.pem ]]; then
          selects+=("$NAME")
        fi
      fi
    done

    #add domain chuyá»ƒn hÆ°á»›ng
    if [[ -d /etc/wptt/chuyen-huong ]]; then
      if [[ $(ls -A /etc/wptt/chuyen-huong | grep '\.conf' | wc -l) != '0' ]]; then
        for entry2 in $(ls -A /etc/wptt/chuyen-huong); do
          NAME=$(echo $entry2 | sed 's/^.//' | sed 's/.conf//')
          if [ "$NAME" != "${NAME/./}" ]; then
            if [[ -f /etc/letsencrypt/live/$NAME/cert.pem || -f /etc/letsencrypt/live/www.${NAME}/cert.pem ]]; then
              selects+=("$NAME")
            fi
          fi
        done
      fi
    fi

    PS3="
$(tput setab 0)-//- $nhap_lua_chon_website_cua_ban [0=$exit_thoat]:$(tput sgr0) "
    select select in ${selects[@]}; do
      NAME=$select
      index=$REPLY
      break
    done
  else
    clear
    echo "KhÃ´ng cÃ³ domain trÆ°á»›c Ä‘Ã³ Ä‘Æ°á»£c cÃ i ssl letsencrypt"
    echo "$khong_co_domain_nao_ton_tai_tren_he_thong"
    exit
  fi
}

# . /etc/wptt/tenmien
# echo ""
# echo ""
# echo ""
lua_chon_NAME

CLEAN="$NAME"

. /etc/wptt/echo-color
if [[ "$NAME" = "0" || "$NAME" = "" ]]; then
  . /etc/wptt/wptt-ssl-main 1
fi

pathcheck="/etc/wptt/vhost/.$NAME.conf"
if [[ ! -f "$pathcheck" && ! -f /etc/wptt/chuyen-huong/.$NAME.conf ]]; then
  clear
  echoDo "$ten_mien_nay_khong_ton_tai_tren_he_thong"
  sleep 3
  . /etc/wptt/wptt-ssl-main 1
  exit
fi

check_ssl="/etc/letsencrypt/live/$NAME/cert.pem"
if [[ ! -f /etc/letsencrypt/live/$NAME/cert.pem && ! -f /etc/letsencrypt/live/www.${NAME}/cert.pem ]]; then
  echoDo "website $NAME Báº¡n chÆ°a cÃ i Ä‘áº·t chá»©ng chá»‰ SSL letsencrypt"
  . /etc/wptt/wptt-ssl-main 1
  exit
fi

echo "$xac_nhan $xoa_chung_chi_ssl_letencrypt website $NAME?: "
prompt="$nhap_lua_chon_cua_ban [1-2]: "
dongy="n"
options=("$dong_y" "$khong_dong_y")
PS3="$prompt"
select opt in "${options[@]}"; do
  case "$REPLY" in
  1)
    dongy="y"
    break
    ;;

  2)
    dongy="n"
    break
    ;;

  $((${#options[@]} + 1)))
    printf "\n$ban_nhap_sai_he_thong_se_chon_khong_dong_y\n"
    break
    ;;
  *)
    printf "$ban_nhap_sai_he_thong_se_chon_khong_dong_y\n"
    break
    ;;
  esac
done

if [[ "$dongy" = "y" ]]; then
  _runing "$xoa_chung_chi_ssl_letencrypt website $NAME"
  if [[ "$NAME" = "$Website_chinh" ]]; then
    #khá»Ÿi táº¡o ssl tá»± kÃ½
    mkdir -p /etc/wptt-ssl-tu-ky/$NAME
    cd /etc/wptt-ssl-tu-ky/$NAME
    openssl req -new -newkey rsa:2048 -nodes -keyout $NAME.key -out $NAME.csr -subj "/C=VN/ST=Hanoi/L=Hanoi/O=wptangtoc ols/OU=IT Department/CN=$NAME/emailAddress=admin@example.com" >/dev/null 2>&1
    openssl x509 -req -in $NAME.csr -signkey $NAME.key -out cert.crt -days 3650 >/dev/null 2>&1
    #end khá»Ÿi táº¡o ssl tá»± kÃ½
    sed -i "/keyFile/d" /usr/local/lsws/conf/httpd_config.conf
    sed -i "/certFile/d" /usr/local/lsws/conf/httpd_config.conf
    sed -i "/CACertFile/d" /usr/local/lsws/conf/httpd_config.conf
    sed -i "/https/a   keyFile              \/etc\/wptt-ssl-tu-ky\/$NAME\/$NAME.key" /usr/local/lsws/conf/httpd_config.conf
    sed -i "/https/a   certFile             \/etc\/wptt-ssl-tu-ky\/$NAME\/cert.crt" /usr/local/lsws/conf/httpd_config.conf
    /usr/local/lsws/bin/lswsctrl restart >/dev/null 2>&1
  fi

  if [[ -f $check_ssl ]]; then
    certbot revoke --non-interactive --agree-tos --cert-path $check_ssl >/dev/null 2>&1
    rm -rf /etc/letsencrypt/live/$CLEAN
    rm -f /etc/letsencrypt/renewal/$CLEAN.conf
    rm -rf /etc/letsencrypt/archive/${CLEAN}
  fi
  if [[ -f /etc/letsencrypt/live/www.${CLEAN}/cert.pem ]]; then
    certbot revoke --non-interactive --agree-tos --cert-path /etc/letsencrypt/live/www.${CLEAN}/cert.pem >/dev/null 2>&1
    rm -rf /etc/letsencrypt/live/www.${CLEAN}
    rm -f /etc/letsencrypt/renewal/www.${CLEAN}.conf
    rm -rf /etc/letsencrypt/archive/www.${CLEAN}
  fi
  _rundone "$xoa_chung_chi_ssl_letencrypt website $NAME"
fi

_runing "XÃ³a chuyá»ƒn hÆ°á»›ng http sang https website $NAME"
path2="/usr/local/lsws/$CLEAN/html/.htaccess"

#xÃ³a chuyá»ƒn hÆ°á»›ng http to https
sed -i -e '/^#begin-chuyen-huong-http-to-https-wptangtoc-ols/,/^#end-chuyen-huong-http-to-https-wptangtoc-ols$/d' $path2
#xÃ³a chuyá»ƒn hÆ°á»›ng www to non-www
sed -i -e '/^#begin-chuyen-huong-www-to-non-www-wptangtoc-ols/,/^#end-chuyen-huong-www-to-non-www-wptangtoc-ols$/d' $path2
#xÃ³a chuyá»ƒn hÆ°á»›ng non-www to www
sed -i -e '/^#begin-chuyen-huong-non-www-to-www-wptangtoc-ols/,/^#end-chuyen-huong-non-www-to-www-wptangtoc-ols$/d' $path2
#end xÃ³a chuyá»ƒn hÆ°á»›ng http to https

/usr/local/lsws/bin/lswsctrl restart >/dev/null 2>&1
_rundone "XÃ³a chuyá»ƒn hÆ°á»›ng http sang https website $NAME"

echo "XoÃ¡ SSL free letsencrypt website $NAME: $(date '+%d-%m-%Y %H:%M')" >>/var/log/wptangtoc-ols.log

echo "==================================================================="
echoDone "$xoa_chung_chi_ssl_letencrypt website $CLEAN $hoan_tat            "
echo "==================================================================="

check_menu_wptangtoc_active=$1
if [[ $check_menu_wptangtoc_active = "98" ]]; then
  . /etc/wptt/wptt-ssl-main 1
fi
