#!/bin/bash

function huong_dan() {
  Quét virus ClamAV là một công cụ quét virus mã nguồn mở, miễn phí và rất phổ biến trên các hệ điều hành Linux. Tính năng chính của nó là giúp phát hiện và loại bỏ các phần mềm độc hại như virus, trojans, worms, và các mối đe dọa khác. Nếu bạn không có nhu cầu cần sử dụng có thể dùng tính năng này để xoá cài đặt để giải phóng dung lượng cho máy chủ
}

echo ""
echo ""
echo ""
echo "========================================================================="
echo "|Bảo mật => Xoá phần mềm Scan quet virus website                        |"
echo "========================================================================="
echo ""
echo ""

if [[ ! -f "/usr/local/maldetect/uninstall.sh" ]]; then
  echo "Bạn chưa cài đặt phần mềm diệt virus trên hệ thống này"
  exit
fi

RED='\033[1;31m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# 1. XAC NHAN TRUOC KHI XOA (AN TOAN)
echo -e "${YELLOW}Canh bao: Hanh dong nay se xoa toan bo ClamAV, Maldet va lich su quet.${NC}"
read -p "Bạn có chắc chắn muốn tiếp tục không? (y/n): " confirm
if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
  check_menu_wptangtoc_active=$1
  if [[ $check_menu_wptangtoc_active = "98" ]] && [[ -f "/etc/wptt/wptt-bao-mat-main" ]]; then
    . /etc/wptt/wptt-bao-mat-main 1
  fi
  exit
fi

# 2. KIEM TRA HE DIEU HANH
if [ -f /etc/redhat-release ]; then
  OS_TYPE="rhel"
elif [ -f /etc/debian_version ]; then
  OS_TYPE="debian"
else
  echo -e "${RED}He dieu hanh khong duoc ho tro!${NC}"
  exit 1
fi

echo ""
echo -e "${YELLOW}Dang tien hanh go bo... Vui long doi.${NC}"

# 3. DUNG CAC SERVICE LIEN QUAN (Tranh loi file in use)
echo " -> Dang dung cac dich vu (Services)..."
if [[ "$OS_TYPE" == "rhel" ]]; then
  systemctl stop clamav-server@scan 2>/dev/null
  systemctl stop clamav-freshclam 2>/dev/null
elif [[ "$OS_TYPE" == "debian" ]]; then
  systemctl stop clamav-daemon 2>/dev/null
  systemctl stop clamav-freshclam 2>/dev/null
fi

# 4. GO BO LINUX MALWARE DETECT (MALDET)
if [[ -f "/usr/local/maldetect/uninstall.sh" ]]; then
  echo " -> Dang go bo Maldetect..."
  # Chay script uninstall mac dinh nhung giau output
  bash /usr/local/maldetect/uninstall.sh >/dev/null 2>&1

  # Xoa them thu muc neu script mac dinh xoa sot
  rm -rf /usr/local/maldetect
  rm -f /etc/cron.daily/maldet
  rm -f /etc/cron.d/maldet_pub
else
  echo " -> Khong tim thay Maldetect (hoac da xoa)."
fi

# 5. GO BO CLAMAV (TUY THEO HDH)
echo " -> Dang go bo ClamAV..."

if [[ "$OS_TYPE" == "rhel" ]]; then
  # Go bo goi tren CentOS/AlmaLinux
  yum remove clamav-server clamav-update clamav-filesystem clamav clamav-scanner-systemd clamav-devel clamav-lib clamav-server-systemd -y -q >/dev/null 2>&1

  # Xoa file cau hinh con sot lai
  rm -rf /etc/clamd.d
  rm -rf /var/lib/clamav
  rm -f /etc/freshclam.conf
  rm -f /etc/freshclam.conf.rpmsave

elif [[ "$OS_TYPE" == "debian" ]]; then
  # Go bo goi tren Ubuntu (Them --purge de xoa sach file config)
  apt-get remove --purge clamav clamav-daemon clamav-base libclamav9 -y -q >/dev/null 2>&1
  apt-get autoremove -y -q >/dev/null 2>&1

  # Xoa file cau hinh con sot lai
  rm -rf /etc/clamav
  rm -rf /var/lib/clamav
  rm -rf /var/log/clamav
fi

# 6. DON DEP CUOI CUNG
# Xoa file log quet virus (neu ban muon xoa sach dau vet)
rm -rf /usr/local/maldetect/logs
rm -rf /var/log/maldetect

echo ""
if [[ -f "/etc/wptt/echo-color" ]]; then
  . /etc/wptt/echo-color
  echoDone "Hoàn tất xoá phần mềm diệt virus!"
fi

# Quay ve menu
check_menu_wptangtoc_active=$1
if [[ $check_menu_wptangtoc_active = "98" ]] && [[ -f "/etc/wptt/wptt-bao-mat-main" ]]; then
  . /etc/wptt/wptt-bao-mat-main 1
fi
