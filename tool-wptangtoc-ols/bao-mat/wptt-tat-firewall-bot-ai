#!/bin/bash

function huong_dan() {
  Huỷ kích hoạt tường lửa Block AI Crawlers:
  Gỡ bỏ tường lửa chặn AI Crawlers: Cho phép GPTBot, CCBot... thu thập dữ liệu để index. Cần thiết nếu bạn muốn làm SEO cho các mô hình tìm kiếm AI [AI Search].
  Cho phép các Bot AI [ChatGPT, Claude...] truy cập lại website. Giúp nội dung của bạn có cơ hội xuất hiện và được trích dẫn trên các công cụ tìm kiếm AI thế hệ mới.
  Mở cửa cho Bot AI: Website sẽ được các AI thu thập dữ liệu trở lại.
  Lưu ý: Việc này có thể làm tăng tải CPU/RAM nếu có quá nhiều bot quét cùng lúc.
}

. /etc/wptt/echo-color
NAME=$1
if [[ $NAME = "98" ]]; then
  NAME=""
fi
if [[ $NAME = "" ]]; then
  echo ""
  echo ""
  echo ""
  echo "========================================================================="
  echo "|Bảo mật => Huỷ Kích hoạt tường lửa chặn BOT AI Crawlers                  |"
  echo "========================================================================="

  RED='\033[0;31m'
  NC='\033[0m'
  xanh='\033[0;32m'

  if [ "$(ls -A /etc/wptt/vhost | grep -v '^\.\.conf$' | sort -uV)" ]; then
    echo
    echo "Kiểm tra website kích hoạt tường lửa chặn BOT AI Crawlers:"
    echo "========================================================================="
    for entry in $(ls -A /etc/wptt/vhost | grep -v '^\.\.conf$' | sort -uV); do
      domain=$(echo "$entry" | sed 's/^.//' | sed 's/.conf//')
      path="/usr/local/lsws/$domain/html/.htaccess"
      i=1
      if [ "$domain" != "${domain/./}" ] && [ "$domain" != '.' ]; then #điều kiện domain phải có dấu . và lỗi chỉ có only .
        if [[ -f "$path" ]]; then
          if [[ $(cat /usr/local/lsws/$domain/html/.htaccess | grep '#begin-tuong-lua-block-bot-ai') = '' ]]; then
            hoatdong="Đang được tắt"
            echo -e "Hệ thống kiểm tra website $domain :${RED} $hoatdong${NC}"
          else
            hoatdong="Đang được bật"
            echo -e "Hệ thống kiểm tra website $domain :${xanh} $hoatdong${NC}"
            tuan_7g='1'
          fi
        fi
      fi
    done
    echo "========================================================================="
    echo
  fi

  if [[ $tuan_7g = '' ]]; then
    . /etc/wptt/echo-color
    echoDo "Chưa có website nào kích hoạt tường lửa chặn BOT AI Crawlers"
    check_menu_wptangtoc_active=$1
    if [[ $check_menu_wptangtoc_active = "98" ]]; then
      . /etc/wptt/wptt-bao-mat-main 1
    fi
    return 2>/dev/null
    exit
  fi

  . /etc/wptt/tenmien-them-lua-chon-tat-ca-website
  echo ""
  echo ""
  echo "Lựa chọn website huỷ kích hoạt tường lửa chặn BOT AI Crawlers: "
  echo ""
  lua_chon_NAME
fi

. /etc/wptt/echo-color

if [[ $NAME = 'Tất cả website' ]]; then
  if [ "$(ls -A /etc/wptt/vhost | grep -v '^\.\.conf$' | sort -uV)" ]; then
    for entry in $(ls -A /etc/wptt/vhost | grep -v '^\.\.conf$' | sort -uV); do
      domain=$(echo $entry | sed 's/^.//' | sed 's/.conf//')
      path_html="/usr/local/lsws/$domain/html"
      i=1
      if [ "$domain" != "${domain/./}" ] && [ "$domain" != '.' ]; then #điều kiện domain phải có dấu . và lỗi chỉ có only .
        if [[ -d "$path_html" ]]; then
          if [[ $(cat /usr/local/lsws/$domain/html/.htaccess | grep '#begin-tuong-lua-block-bot-ai') ]]; then
            _runing "Thiết lập tường lửa chặn BOT AI Crawlers website $domain"
            (/etc/wptt/bao-mat/wptt-tat-firewall-bot-ai $domain >/dev/null 2>&1)
            _rundone "Thiết lập tường lửa chặn BOT AI Crawlers website $domain"
          fi
        fi
      fi
    done
  fi

  check_menu_wptangtoc_active=$1
  if [[ $check_menu_wptangtoc_active = "98" ]]; then
    . /etc/wptt/wptt-bao-mat-main 1
  fi

  exit
fi

if [[ "$NAME" = "0" || "$NAME" = "" ]]; then
  . /etc/wptt/wptt-bao-mat-main 1
fi

pathcheck="/etc/wptt/vhost/.$NAME.conf"
if [[ ! -f "$pathcheck" ]]; then
  clear
  echoDo "Tên miền không tồn tại trên hệ thống này"
  sleep 3
  . /etc/wptt/wptt-bao-mat-main 1
  exit
fi

if [[ ! -f /usr/local/lsws/$NAME/html/.htaccess ]]; then
  echoDo "Không xác định được file .htaccess"
  exit
fi

# dem_so_dong=$(cat /etc/wptt/bao-mat/firewall.txt | wc -l)
# dem_so_dong_tru_sed=$(expr $dem_so_dong - 1)

htaccess_hien_tai=$(cat /usr/local/lsws/$NAME/html/.htaccess)
#kiểm tra đã kích hoạt trước đó chưa
if ! [[ $(echo $htaccess_hien_tai | grep '#begin-tuong-lua-block-bot-ai') ]]; then
  echoDo "website $NAME chưa được kích hoạt tường lửa chặn BOT AI Crawlers"
  . /etc/wptt/wptt-bao-mat-main 1
  exit
fi

# sed -i '/#tuong-lua-bao-mat-7g/,+'$dem_so_dong_tru_sed'd' /usr/local/lsws/$NAME/html/.htaccess

#xoá theo block

echo "Xoá thiết lập tường lửa chặn BOT AI Crawlers website $NAME: $(date '+%d-%m-%Y %H:%M')" >>/var/log/wptangtoc-ols.log

sed -i -e '/^#begin-tuong-lua-block-bot-ai/,/^#end-tuong-lua-block-bot-ai$/d' /usr/local/lsws/$NAME/html/.htaccess

/usr/local/lsws/bin/lswsctrl restart >/dev/null 2>&1

#clear htaccess chuyen vhost
vhost_chuyen_htaccess=''
. /etc/wptt/vhost/.$NAME.conf
if [[ $vhost_chuyen_htaccess ]]; then
  . /etc/wptt/wptt-htaccess-tat-chuyen-doi-vhost $NAME >/dev/null 2>&1
fi

echoDone "Hoàn tất hủy Kích hoạt tường lửa chặn BOT AI Crawlers cho website $NAME"

check_menu_wptangtoc_active=$1
if [[ $check_menu_wptangtoc_active = "98" ]]; then
  . /etc/wptt/wptt-bao-mat-main 1
fi
