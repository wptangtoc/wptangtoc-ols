#!/bin/bash

function huong_dan() {
  Nếu ai đó truy vấn cố tình spam tính năng search sẽ bị chặn lại.
  Ví dụ tính năng search khi truy cập: https://domain.com?s=abc
  cái query sting là ?s= thường là giá trị search tính năng của WordPress, hoặc một số nền tảng khác...
  Nếu IP nào đó trong 15 giây mà yêu cầu 5 yêu cầu search thì IP sẽ bị khóa trong 2 tiếng
}

echo ""
echo ""
echo ""
echo "========================================================================="
echo "|Bảo mật => Kích hoạt chống search                                |"
echo "========================================================================="
echo ""
echo ""
echo ""

. /etc/wptt/echo-color
check=$(cat /etc/fail2ban/jail.local | grep '#begin-ddos-search-wordpress')
if [[ $check = '' ]]; then
  echo "Xác nhận muốn kích hoạt chống ddos search"
  prompt="Nhập lựa chọn của bạn [1-2]: "
  dongy="n"
  options=("Đồng ý" "Không đồng ý")
  PS3="$prompt"
  select opt in "${options[@]}"; do
    case "$REPLY" in
    1)
      dongy="y"
      break
      ;;

    2)
      dongy="n"
      break
      ;;

    $((${#options[@]} + 1)))
      printf "\nBạn nhập sai hệ thống sẽ chọn là không đồng ý\n"
      break
      ;;
    *)
      printf "Bạn nhập sai hệ thống sẽ chọn là không đồng ý\n"
      break
      ;;
    esac
  done

  if [[ $dongy = 'n' ]]; then
    . /etc/wptt/wptt-bao-mat-main 1
  fi

  _runing "Kích hoạt chặn chống ddos search"

  if [ "$(ls -At /etc/wptt/vhost)" ]; then
    selects=()
    for entry in $(ls -A /etc/wptt/vhost | sort -uV); do
      NAME=$(echo $entry | sed 's/^.//' | sed 's/.conf//')
      if [ "$NAME" != "${NAME/./}" ] && [ "$NAME" != '.' ]; then #điều kiện domain phải có dấu . và lỗi chỉ có only .

        unset TRACE_OUTPUT
        TRACE_OUTPUT=$(curl -Is --connect-timeout 5 --max-time 10 "https://$NAME/cdn-cgi/trace" 2>/dev/null)
        # Kiểm tra output có chứa các key đặc trưng của Cloudflare không
        if echo "$TRACE_OUTPUT" | grep -qi 'cloudflare\|cf-ray'; then #check xem có đang sử dụng cloudflare cdn không
          if [[ $(cat /usr/local/lsws/conf/httpd_config.conf | grep 'allow' | grep '103.21.244.0') = '' ]]; then
            _runloi "Kích hoạt chặn chống ddos search"
            echo "Phát hiện website $NAME đang sử dụng Cloudflare CDN"
            echo "Vui lòng phải kích hoạt sử dụng tính năng Hiện thị IP Log Real bypass Cloudflare CDN (MENU add ons 35=>8)"
            echo "Thì mới có thể sử dụng được tính năng này để tránh bị chặn nhầm"
            check_menu_wptangtoc_active=$1
            if [[ $check_menu_wptangtoc_active = "98" ]]; then
              . /etc/wptt/wptt-bao-mat-main 1
            fi
            return 2>/dev/null
            exit
          fi
        fi

        if [[ ! $(cat /usr/local/lsws/conf/vhosts/"$NAME"/"$NAME".conf | grep 'accesslog') ]]; then
          sed -i -e '/^errorlog /,/^}$/d' /usr/local/lsws/conf/vhosts/"$NAME"/"$NAME".conf
          sed -i -e '/^accesslog /,/^}$/d' /usr/local/lsws/conf/vhosts/"$NAME"/"$NAME".conf
          echo '
errorlog $VH_ROOT/logs/error.log {
  useServer               1
  logLevel                ERROR
  rollingSize             10M
}

accesslog $VH_ROOT/logs/access.log {
  useServer               0
  rollingSize             10M
  keepDays                30
  compressArchive         1
}' >>/usr/local/lsws/conf/vhosts/"$NAME"/"$NAME".conf
          mkdir -p /usr/local/lsws/"$NAME"/logs

          #tuong thich ubuntu tuong thich nhom litespeed
          if $(cat /etc/*release | grep -q "Ubuntu"); then
            tuong_thich_nhom_litespeed="nogroup"
          else
            tuong_thich_nhom_litespeed="nobody"
          fi

          chown -R nobody:$tuong_thich_nhom_litespeed /usr/local/lsws/"$NAME"/logs
          chmod 700 /usr/local/lsws/"$NAME"/logs
          /usr/local/lsws/bin/lswsctrl restart >/dev/null 2>&1
        fi
      fi
    done
  fi

  #kiểm tra đang sử dụng nền tảng tường firewall nào
  if [[ -f /etc/csf/csf.conf ]]; then
    action_thuc_thi_block='iptables-multiport[name=wordpress, port="http,https", protocol=tcp]'
  elif [[ $(systemctl status nftables.service 2>/dev/null | grep 'Active' | cut -f2 -d':' | xargs | cut -f1 -d' ' | xargs) = "active" ]]; then
    action_thuc_thi_block='nftables-allports'
  elif [[ $(systemctl status firewalld.service 2>/dev/null | grep 'Active' | cut -f2 -d':' | xargs | cut -f1 -d' ' | xargs) = "active" ]]; then
    action_thuc_thi_block='firewallcmd-allports'
  else
    echo "Hiện tại không support một tường lừa nào để sử dụng"
    check_menu_wptangtoc_active=$1
    if [[ $check_menu_wptangtoc_active = "98" ]]; then
      . /etc/wptt/wptt-bao-mat-main 1
    fi
    return 2>/dev/null
    exit
  fi

  echo '#begin-ddos-search-wordpress
[ddos-search-wptangtoc]
enabled = true
action = '$action_thuc_thi_block'
filter = ddos-search-wptangtoc
logpath = /usr/local/lsws/*/logs/access.log
maxretry = 5
bantime = 7200
findtime = 15
#end-ddos-search-wordpress' >>/etc/fail2ban/jail.local

  echo '[Definition]
failregex = ^<HOST> - .* "(GET|POST|HEAD).*\/?s=.*HTTP.*200.*$' >/etc/fail2ban/filter.d/ddos-search-wptangtoc.conf

  fail2ban-client reload >/dev/null 2>&1
  systemctl restart fail2ban
  _rundone "Kích hoạt chặn chống ddos search"
  echo "Nếu trong 15 giây mà yêu cầu 5 yêu cầu search thì IP sẽ bị khóa trong 2 tiếng"
fi

if [[ $check ]]; then
  echo "Bạn đang kích họat chống ddos search"
  echo "Xác nhận muốn hủy kích hoạt chống ddos search"
  prompt="Nhập lựa chọn của bạn [1-2]: "
  dongy="n"
  options=("Đồng ý" "Không đồng ý")
  PS3="$prompt"
  select opt in "${options[@]}"; do
    case "$REPLY" in
    1)
      dongy="y"
      break
      ;;

    2)
      dongy="n"
      break
      ;;

    $((${#options[@]} + 1)))
      printf "\nBạn nhập sai hệ thống sẽ chọn là không đồng ý\n"
      break
      ;;
    *)
      printf "Bạn nhập sai hệ thống sẽ chọn là không đồng ý\n"
      break
      ;;
    esac
  done

  if [[ $dongy = 'n' ]]; then
    . /etc/wptt/wptt-bao-mat-main 1
  fi

  _runing "Hủy kích hoạt chống ddos 404"
  # sed -i '/chan search ddos wptangtoc/,+8d' /etc/fail2ban/jail.local
  sed -i -e '/^#begin-ddos-search-wordpress/,/^#end-ddos-search-wordpress$/d' /etc/fail2ban/jail.local
  fail2ban-client reload >/dev/null 2>&1
  systemctl restart fail2ban
  _rundone "Hủy kích hoạt chống ddos 404"
fi

check_menu_wptangtoc_active=$1
if [[ $check_menu_wptangtoc_active = "98" ]]; then
  . /etc/wptt/wptt-bao-mat-main 1
fi
