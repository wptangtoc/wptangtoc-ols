#!/bin/bash

function huong_dan() {
  T√≠nh nƒÉng Ch·ªëng DDoS [WPTangToc OLS] s·ª≠ d·ª•ng Fail2ban
  üõ°Ô∏è M·ª•c ƒë√≠ch:
  T√≠nh nƒÉng n√†y gi√∫p t·ª± ƒë·ªông ph√°t hi·ªán v√† ch·∫∑n c√°c ƒë·ªãa ch·ªâ IP c√≥ d·∫•u hi·ªáu truy c·∫≠p b·∫•t th∆∞·ªùng, ƒë·∫∑c bi·ªát l√† nh·∫Øm v√†o c√°c n·ªôi dung ƒë·ªông [dynamic content] - nh·ªØng n·ªôi dung t·ªën nhi·ªÅu t√†i nguy√™n x·ª≠ l√Ω c·ªßa m√°y ch·ªß [nh∆∞ PHP, c∆° s·ªü d·ªØ li·ªáu] nh·∫•t.

  ‚öôÔ∏è Quy t·∫Øc ho·∫°t ƒë·ªông c·ª• th·ªÉ:
  * C√¥ng c·ª•: S·ª≠ d·ª•ng Fail2ban, m·ªôt ph·∫ßn m·ªÅm gi√°m s√°t log v√† ch·∫∑n IP.
  * ƒêi·ªÅu ki·ªán K√≠ch ho·∫°t [Trigger]: Fail2ban s·∫Ω theo d√µi log truy c·∫≠p [access.log] c·ªßa OpenLiteSpeed. N·∫øu m·ªôt ƒë·ªãa ch·ªâ IP th·ª±c hi·ªán 20 y√™u c·∫ßu [requests] ƒë·∫øn c√°c t·ªáp tin ƒë·ªông [html document], t·ª©c c√°c trang c·∫ßn x·ª≠ l√Ω b·ªüi WordPress/PHP, kh√¥ng ph·∫£i file tƒ©nh nh∆∞ ·∫£nh, css, js] trong v√≤ng 30 gi√¢y.
  * H√†nh ƒë·ªông [Action]: Ngay l·∫≠p t·ª©c, Fail2ban s·∫Ω ra l·ªánh cho t∆∞·ªùng l·ª≠a [firewall] c·ªßa m√°y ch·ªß ch·∫∑n [block] ƒë·ªãa ch·ªâ IP ƒë√≥.
  * Th·ªùi gian Ch·∫∑n [Duration]: ƒê·ªãa ch·ªâ IP b·ªã ch·∫∑n s·∫Ω kh√¥ng th·ªÉ truy c·∫≠p v√†o website [ho·∫∑c to√†n b·ªô server, t√πy c·∫•u h√¨nh] trong v√≤ng 2 ti·∫øng.

  L·ª£i √≠ch:
  * T·ª± ƒë·ªông h√≥a: T·ª± ƒë·ªông ch·∫∑n c√°c IP t·∫•n c√¥ng m√† kh√¥ng c·∫ßn can thi·ªáp th·ªß c√¥ng.
  * B·∫£o v·ªá T√†i nguy√™n: NgƒÉn ch·∫∑n c√°c cu·ªôc t·∫•n c√¥ng nh·ªè ho·∫∑c bot l√†m c·∫°n ki·ªát t√†i nguy√™n PHP v√† c∆° s·ªü d·ªØ li·ªáu.
  * Gi·∫£m thi·ªÉu T√°c ƒë·ªông: Gi√∫p website ·ªïn ƒë·ªãnh h∆°n tr∆∞·ªõc c√°c truy c·∫≠p qu√° m·ª©c.

  gi·∫£i th√≠ch ƒë∆°n gi·∫£n: ip n√†o trong 30 gi√¢y m√† y√™u c·∫ßu 20 y√™u c·∫ßu [html document] t·ª©c file ƒë·ªông th√¨ IP s·∫Ω b·ªã kh√≥a trong 2 ti·∫øng

  T√≥m l·∫°i: T√≠nh nƒÉng n√†y trong WPTangToc OLS l√† m·ªôt c·∫•u h√¨nh Fail2ban, gi√∫p t·ª± ƒë·ªông h√≥a vi·ªác b·∫£o v·ªá website kh·ªèi c√°c truy c·∫≠p ƒë·ªông qu√° m·ª©c, g√≥p ph·∫ßn tƒÉng c∆∞·ªùng an ninh v√† ·ªïn ƒë·ªãnh cho m√°y ch·ªß OpenLiteSpeed c·ªßa b·∫°n.
}

. /etc/wptt/.wptt.conf

echo "/-----------------------------------------------------------------------/"
echo "B·∫£o m·∫≠t => Ch·ªëng ddos website"
echo "/-----------------------------------------------------------------------/"

NAME=$1
if [[ $NAME = "98" ]]; then
  NAME=""
fi

. /etc/wptt/echo-color

if [[ $NAME = '' ]]; then
  if [ "$(ls -A /etc/wptt/vhost | grep -v '^\.\.conf$' | sort -uV)" ]; then
    echo "========================================================================="
    echo "Danh s√°ch Domain ƒë√£ k√≠ch ho·∫°t ch·ªëng ddos:"
    echo "========================================================================="
    for entry in $(ls -A /etc/wptt/vhost | grep -v '^\.\.conf$' | sort -uV); do
      domain=$(echo $entry | sed 's/^.//' | sed 's/.conf//')
      domain2=${domain//[-._]/wp}
      path="/etc/fail2ban/filter.d/ddos-$domain2.conf"
      i=1
      if [[ -f "$path" ]]; then
        checkauto="ƒê√£ k√≠ch ho·∫°t"
      else
        checkauto="Ch∆∞a k√≠ch ho·∫°t"
      fi
      echo "Website $domain $checkauto ch·ªëng ddos"
    done
    echo "========================================================================="
    echo
  fi

  echo ""
  echo ""
  echo "L·ª±a ch·ªçn website k√≠ch ho·∫°t ch·ªëng ddos website: "
  echo ""
  function lua_chon_NAME() {
    NAME=""
    if [ "$(ls -At /etc/wptt/vhost)" ]; then
      selects=()
      for entry in $(ls -A /etc/wptt/vhost | grep -v '^\.\.conf$' | sort -uV); do
        NAME=$(echo $entry | sed 's/^.//' | sed 's/.conf//')
        NAME2=${NAME//[-._]/wp}
        if [[ ! -f /etc/fail2ban/filter.d/ddos-$NAME2.conf ]]; then
          selects+=("$NAME")
        fi
      done

      if [[ $selects = '' ]]; then
        echo "T·∫•t c·∫£ website WordPress tr√™n h·ªá th·ªëng ƒë√£ ƒë∆∞·ª£c k√≠ch ho·∫°t ch·ªëng DDOS h·∫øt r·ªìi"
        . /etc/wptt/wptt-bao-mat-main 1
      fi

      #check t·ªïng s·ªë website, n·∫øu 2 website tr·ªü l√™n th√¨ s·∫Ω t·ª± ƒë·ªông c√≥ t√≠nh nƒÉng t·∫•t c·∫£
      a=0
      for select in ${selects[@]}; do
        a=$(expr $a + 1)
      done

      if [[ $a != 1 ]]; then
        selects+=("T·∫•t c·∫£ website")
      fi

      PS3="
-//- Nh·∫≠p l·ª±a ch·ªçn website c·ªßa b·∫°n [0=Tho√°t]: "
      select select in ${selects[@]}; do
        NAME=$select
        index=$REPLY
        break
      done
    else
      clear
      echo "Khong co domain tren he thong cua ban."
      exit
    fi
  }

  lua_chon_NAME
fi

if [[ $NAME = 'T·∫•t c·∫£ website' ]]; then
  if [ "$(ls -A /etc/wptt/vhost | grep -v '^\.\.conf$' | sort -uV)" ]; then
    for entry in $(ls -A /etc/wptt/vhost | grep -v '^\.\.conf$' | sort -uV); do
      domain=$(echo $entry | sed 's/^.//' | sed 's/.conf//')
      domain2=${domain//[-._]/wp}
      if [[ ! -f /etc/fail2ban/filter.d/ddos-$domain2.conf ]]; then
        _runing "Thi·∫øt l·∫≠p ch·ªëng ddos website $domain"
        (/etc/wptt/bao-mat/wptt-canh-bao-ddos-thiet-lap $domain >/dev/null 2>&1)
        _rundone "Thi·∫øt l·∫≠p ch·ªëng ddos website $domain"
      fi
    done
  fi

  check_menu_wptangtoc_active=$1
  if [[ $check_menu_wptangtoc_active = "98" ]]; then
    . /etc/wptt/wptt-logs-main 1
  fi
  exit
fi

if [[ $NAME = '0' || $NAME = '' ]]; then
  . /etc/wptt/wptt-bao-mat-main 1
  exit
fi

. /etc/wptt/echo-color

NAME2=${NAME//[-._]/wp}

read -p "B·∫°n c√≥ mu·ªën b·∫≠t t√≠nh nƒÉng ch·ªëng ddos website? (y/n): " dongy
if [[ "$dongy" = "y" ]]; then
  _runing "Thi·∫øt l·∫≠p ch·ªëng ddos cho website $NAME"

  unset TRACE_OUTPUT
  TRACE_OUTPUT=$(curl -Is --connect-timeout 5 --max-time 10 "https://$NAME/cdn-cgi/trace" 2>/dev/null)
  # Ki·ªÉm tra output c√≥ ch·ª©a c√°c key ƒë·∫∑c tr∆∞ng c·ªßa Cloudflare kh√¥ng
  if echo "$TRACE_OUTPUT" | grep -qi 'cloudflare\|cf-ray'; then #check xem c√≥ ƒëang s·ª≠ d·ª•ng cloudflare cdn kh√¥ng
    if [[ $(cat /usr/local/lsws/conf/httpd_config.conf | grep 'allow' | grep '103.21.244.0') = '' ]]; then
      _runloi "Thi·∫øt l·∫≠p ch·ªëng ddos cho website $NAME"
      echo "Ph√°t hi·ªán website $NAME ƒëang s·ª≠ d·ª•ng Cloudflare CDN"
      echo "Vui l√≤ng ph·∫£i k√≠ch ho·∫°t s·ª≠ d·ª•ng t√≠nh nƒÉng Hi·ªán th·ªã IP Log Real bypass Cloudflare CDN (MENU add ons 35=>8)"
      echo "Th√¨ m·ªõi c√≥ th·ªÉ s·ª≠ d·ª•ng ƒë∆∞·ª£c t√≠nh nƒÉng n√†y ƒë·ªÉ tr√°nh b·ªã ch·∫∑n nh·∫ßm"
      check_menu_wptangtoc_active=$1
      if [[ $check_menu_wptangtoc_active = "98" ]]; then
        . /etc/wptt/wptt-bao-mat-main 1
      fi
      return 2>/dev/null
      exit
    fi
  fi

  if [[ ! $(cat /usr/local/lsws/conf/vhosts/"$NAME"/"$NAME".conf | grep 'accesslog') ]]; then
    sed -i -e '/^errorlog /,/^}$/d' /usr/local/lsws/conf/vhosts/"$NAME"/"$NAME".conf
    sed -i -e '/^accesslog /,/^}$/d' /usr/local/lsws/conf/vhosts/"$NAME"/"$NAME".conf
    echo '
errorlog $VH_ROOT/logs/error.log {
  useServer               1
  logLevel                ERROR
  rollingSize             10M
}

accesslog $VH_ROOT/logs/access.log {
  useServer               0
  rollingSize             10M
  keepDays                30
  compressArchive         1
}' >>/usr/local/lsws/conf/vhosts/"$NAME"/"$NAME".conf
  fi

  mkdir -p /usr/local/lsws/"$NAME"/logs

  #tuong thich ubuntu tuong thich nhom litespeed
  if $(cat /etc/*release | grep -q "Ubuntu"); then
    tuong_thich_nhom_litespeed="nogroup"
  else
    tuong_thich_nhom_litespeed="nobody"
  fi

  chown -R nobody:$tuong_thich_nhom_litespeed /usr/local/lsws/"$NAME"/logs
  chmod 700 /usr/local/lsws/"$NAME"/logs

  #ki·ªÉm tra ƒëang s·ª≠ d·ª•ng n·ªÅn t·∫£ng t∆∞·ªùng firewall n√†o
  if [[ -f /etc/csf/csf.conf ]]; then
    action_thuc_thi_block='iptables-multiport[name=wordpress, port="http,https", protocol=tcp]'
  elif [[ $(systemctl status nftables.service 2>/dev/null | grep 'Active' | cut -f2 -d':' | xargs | cut -f1 -d' ' | xargs) = "active" ]]; then
    action_thuc_thi_block='nftables-allports'
  else
    action_thuc_thi_block='firewallcmd-allports'
  fi

  #rules firewalld ch∆∞a ch·ª©a t·ªëi ƒëa 28 k√Ω t·ª±: f2b- + v·ªõi t√™n rules
  rule_fail2ban_name="ddos-$NAME2"
  #ky tu toi da l√† 32 k√Ω t·ª± user trong linux
  check_ky_tu=$(echo $rule_fail2ban_name | wc -c)
  if (($check_ky_tu > 24)); then
    rule_fail2ban_name=$(echo $rule_fail2ban_name | cut -c 1-23)
  fi

  echo '#begin-ddos-website-'$NAME2'
['$rule_fail2ban_name']
enabled = true
action = '$action_thuc_thi_block'
filter = ddos-'$NAME2'
logpath = /usr/local/lsws/'$NAME'/logs/access.log
bantime = 7200
maxretry = 20
findtime = 30
#end-ddos-website-'$NAME2'' >>/etc/fail2ban/jail.local

  #ki·ªÉm tra log get html, s·∫Ω lo·∫°i b·ªè nh·ªØng file static
  echo '[Definition]
failregex = ^<HOST> -.*"(GET|POST) ([_0-9a-zA-Z-\/?&=]+) .*
ignoreregex =' >>/etc/fail2ban/filter.d/ddos-$NAME2.conf
  #loai bo static v√† c√≥ th·ªÉ gi·∫£m maxretry xu·ªëng th·∫•p h∆°n nhi·ªÅu kho·∫£ng 20 tr·ªëng ddos theo d·∫°ng dynamic hmtl file

  # echo '[Definition]
  # failregex = ^<HOST> -.*"(GET|POST).*
  # ignoreregex = ^<HOST> .* "GET /wp-content/.* HTTP.* 200' >>/etc/fail2ban/filter.d/ddos-$NAME2.conf

  #fail2ban-client reload >/dev/null 2>&1

  #xo√° access cho n√≥ nh·∫π h∆°n ƒë·ªÉ fail2ban ƒë·ªçc nhanh h∆°n, tr√°nh fail2ban ƒÉn qu√° nhi·ªÅu cpu, s·∫Ω s·ª≠ d·ª•ng n·∫øu b·ªã ƒë√°nh r√°t qu√°
  #*/1 * * * * truncate -s 0 /var/usr/local/lsws/$NAME/access.log

  systemctl restart fail2ban
  /usr/local/lsws/bin/lswsctrl restart >/dev/null 2>&1
  _rundone "Thi·∫øt l·∫≠p ch·ªëng ddos cho website $NAME"
  echo "N·∫øu trong 30 gi√¢y m√† y√™u c·∫ßu 20 y√™u c·∫ßu (html document) th√¨ IP s·∫Ω b·ªã kh√≥a trong 2 ti·∫øng"
fi

check_menu_wptangtoc_active=$1
if [[ $check_menu_wptangtoc_active = "98" ]]; then
  . /etc/wptt/wptt-bao-mat-main 1
fi
