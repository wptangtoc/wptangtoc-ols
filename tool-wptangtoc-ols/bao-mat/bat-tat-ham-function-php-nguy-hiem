#!/bin/bash

function huong_dan(){
KÃ­ch hoáº¡t hoáº·c huá»· kÃ­ch hoáº¡t cháº·n thá»±c thi nhá»¯ng hÃ m nguy hiá»ƒm vá» báº£o máº­t PHP:

Cháº·n cÃ¡c hÃ m PHP nhÆ° exec, system, passthru, shell_exec, dl, show_source, vÃ  cÃ¡c hÃ m posix_* khÃ¡c lÃ  má»™t biá»‡n phÃ¡p báº£o máº­t quan trá»ng trÃªn mÃ¡y chá»§ web. Viá»‡c nÃ y giÃºp ngÄƒn cháº·n cÃ¡c cuá»™c táº¥n cÃ´ng tiá»m áº©n, Ä‘áº·c biá»‡t khi cháº¡y cÃ¡c á»©ng dá»¥ng PHP cÃ³ thá»ƒ chá»©a lá»— há»•ng.

Gá»“m nhá»¯ng hÃ m: exec,system,passthru,shell_exec,dl,show_source,posix_kill,posix_mkfifo,posix_getpwuid,posix_setpgid,posix_setsid,posix_setuid,posix_setgid,posix_seteuid,posix_setegid,posix_uname

Táº¡i sao cáº§n cháº·n cÃ¡c hÃ m nÃ y?
CÃ¡c hÃ m báº¡n liá»‡t kÃª cÃ³ kháº£ nÄƒng thá»±c hiá»‡n nhá»¯ng tÃ¡c vá»¥ nháº¡y cáº£m, cÃ³ thá»ƒ bá»‹ láº¡m dá»¥ng náº¿u mÃ£ PHP bá»‹ xÃ¢m nháº­p hoáº·c chá»©a lá»— há»•ng:

Thá»±c thi lá»‡nh há»‡ thá»‘ng ðŸ’»:
 * exec[], system[], passthru[], shell_exec[]: Cho phÃ©p PHP cháº¡y cÃ¡c lá»‡nh trá»±c tiáº¿p trÃªn há»‡ Ä‘iá»u hÃ nh cá»§a mÃ¡y chá»§. Náº¿u káº» táº¥n cÃ´ng kiá»ƒm soÃ¡t Ä‘Æ°á»£c Ä‘áº§u vÃ o cá»§a cÃ¡c hÃ m nÃ y, há» cÃ³ thá»ƒ thá»±c thi mÃ£ Ä‘á»™c, chiáº¿m quyá»n kiá»ƒm soÃ¡t mÃ¡y chá»§.
 * Táº£i thÆ° viá»‡n Ä‘á»™ng vÃ  hiá»ƒn thá»‹ mÃ£ nguá»“n ðŸ“–:
 * dl[]: Cho phÃ©p táº£i cÃ¡c pháº§n má»Ÿ rá»™ng PHP Ä‘á»™ng trong lÃºc cháº¡y. Káº» táº¥n cÃ´ng cÃ³ thá»ƒ dÃ¹ng nÃ³ Ä‘á»ƒ táº£i mÃ£ Ä‘á»™c. [HÃ m nÃ y thÆ°á»ng bá»‹ vÃ´ hiá»‡u hÃ³a máº·c Ä‘á»‹nh á»Ÿ cÃ¡c phiÃªn báº£n PHP má»›i hÆ¡n].
 * show_source[] [cÃ²n gá»i lÃ  highlight_file[]]: Hiá»ƒn thá»‹ mÃ£ nguá»“n cá»§a má»™t tá»‡p PHP. Káº» táº¥n cÃ´ng cÃ³ thá»ƒ lá»£i dá»¥ng Ä‘á»ƒ xem mÃ£ nguá»“n, tÃ¬m kiáº¿m lá»— há»•ng.
 * Quáº£n lÃ½ tiáº¿n trÃ¬nh vÃ  thÃ´ng tin POSIX ðŸ›¡ï¸:
 * CÃ¡c hÃ m posix_* [nhÆ° posix_kill, posix_setuid, posix_getpwuid, posix_uname]: Cung cáº¥p kháº£ nÄƒng tÆ°Æ¡ng tÃ¡c sÃ¢u vá»›i há»‡ Ä‘iá»u hÃ nh dá»±a trÃªn POSIX, bao gá»“m viá»‡c káº¿t thÃºc tiáº¿n trÃ¬nh, thay Ä‘á»•i quyá»n sá»Ÿ há»¯u cá»§a tiáº¿n trÃ¬nh, hoáº·c thu tháº­p thÃ´ng tin chi tiáº¿t vá» há»‡ thá»‘ng vÃ  ngÆ°á»i dÃ¹ng. Viá»‡c láº¡m dá»¥ng cÃ¡c hÃ m nÃ y cÃ³ thá»ƒ dáº«n Ä‘áº¿n leo thang Ä‘áº·c quyá»n hoáº·c phÃ¡ hoáº¡i há»‡ thá»‘ng.

TÃ¡c Ä‘á»™ng
 * TÄƒng cÆ°á»ng báº£o máº­t ðŸ‘: Giáº£m Ä‘Ã¡ng ká»ƒ nguy cÆ¡ mÃ¡y chá»§ bá»‹ táº¥n cÃ´ng qua cÃ¡c lá»— há»•ng trong mÃ£ PHP hoáº·c khi káº» táº¥n cÃ´ng tÃ¬m cÃ¡ch thá»±c thi mÃ£ tÃ¹y Ã½.
 * CÃ³ thá»ƒ áº£nh hÆ°á»Ÿng Ä‘áº¿n má»™t sá»‘ á»©ng dá»¥ng âš ï¸: Má»™t sá»‘ plugin, theme hoáº·c á»©ng dá»¥ng PHP há»£p lá»‡ cÃ³ thá»ƒ sá»­ dá»¥ng cÃ¡c hÃ m nÃ y cho cÃ¡c chá»©c nÄƒng cá»¥ thá»ƒ [vÃ­ dá»¥: má»™t sá»‘ plugin backup cÃ³ thá»ƒ dÃ¹ng shell_exec]. Náº¿u báº¡n cháº·n chÃºng, cÃ¡c á»©ng dá»¥ng Ä‘Ã³ cÃ³ thá»ƒ khÃ´ng hoáº¡t Ä‘á»™ng Ä‘Ãºng cÃ¡ch. Trong trÆ°á»ng há»£p nÃ y, báº¡n cáº§n cÃ¢n nháº¯c ká»¹ giá»¯a báº£o máº­t vÃ  tÃ­nh nÄƒng, hoáº·c tÃ¬m giáº£i phÃ¡p thay tháº¿ an toÃ n hÆ¡n.

 NÃ³i chung, viá»‡c cháº·n cÃ¡c hÃ m PHP nguy hiá»ƒm nÃ y lÃ  má»™t thá»±c hÃ nh tá»‘t Ä‘á»ƒ báº£o vá»‡ mÃ¡y chá»§ cá»§a báº¡n, Ä‘áº·c biá»‡t trong mÃ´i trÆ°á»ng chia sáº» hosting hoáº·c khi cháº¡y cÃ¡c á»©ng dá»¥ng khÃ´ng hoÃ n toÃ n Ä‘Ã¡ng tin cáº­y.

Ghi chÃº: khi báº­t cÃ³ thá»ƒ bá»‹ lá»—i má»™t sá»‘ tÃ­nh nÄƒng báº¡n vui lÃ²ng kiá»ƒm tra ká»¹ trÆ°á»›c khi triá»ƒn khai.
}

echo ""
echo ""
echo ""
echo "========================================================================="
echo "|Quáº£n lÃ½ báº£o máº­t => Báº­t/Táº¯t hÃ m nguy hiá»ƒm PHP                           |"
echo "========================================================================="
. /etc/wptt/tenmien
echo ""
echo ""
echo "Lá»±a chá»n website muá»‘n Báº­t/Táº¯t cháº·n hÃ m nguy hiá»ƒm PHP: "
lua_chon_NAME
echo ""

. /etc/wptt/echo-color

if [[ "$NAME" = "0" || "$NAME" = "" ]]; then
	. /etc/wptt/wptt-bao-mat-main 1
fi

pathcheck="/etc/wptt/vhost/.$NAME.conf"
if [[ ! -f "$pathcheck" ]]; then
	clear
	echoDo "TÃªn miá»n khÃ´ng tá»“n táº¡i trÃªn há»‡ thá»‘ng nÃ y"
	sleep 3
	. /etc/wptt/wptt-bao-mat-main 1
	exit
fi

check_da_duoc_gan_gia_tri=$(cat /usr/local/lsws/conf/vhosts/"$NAME"/"$NAME".conf | grep 'open_basedir')
check_open_shell_exec=$(cat /usr/local/lsws/conf/vhosts/"$NAME"/"$NAME".conf | grep 'shell_exec')

# gia tri dieu kien khi Ä‘Ã£ Ä‘Æ°á»£c add phpIniOverride
if [[ $check_da_duoc_gan_gia_tri = '' ]];then
	if [[ $check_open_shell_exec ]];then
		echo "Hiá»‡n táº¡i website $NAME Ä‘ang kÃ­ch hoáº¡t tÃ­nh nÄƒng cháº·n hÃ m nhá»¯ng hÃ m nguy hiá»ƒm"
		read -p "Báº¡n cÃ³ muá»‘n táº¯t tÃ­nh nÄƒng cháº·n nhá»¯ng hÃ m nguy hiá»ƒm khÃ´ng? (y/n): " dongytat
		if [[ $dongytat = 'y' ]];then
			sed -i -e '/^phpIniOverride/,/^}$/d' /usr/local/lsws/conf/vhosts/$NAME/$NAME.conf
			echoDone "HoÃ n táº¥t táº¯t cháº·n nhá»¯ng hÃ m nguy hiá»ƒm cho website $NAME"
		fi
	else
		echo "Hiá»‡n táº¡i website $NAME khÃ´ng kÃ­ch hoáº¡t tÃ­nh nÄƒng cháº·n hÃ m nguy hiá»ƒm PHP"
		read -p "Báº¡n cÃ³ muá»‘n báº­t cháº·n nhá»¯ng hÃ m nguy hiá»ƒm khÃ´ng? (y/n): " dongybat
		if [[ $dongybat = 'y' ]];then
echo "
phpIniOverride  {
php_admin_value disable_functions \"exec,system,passthru,shell_exec,dl,show_source,posix_kill,posix_mkfifo,posix_getpwuid,posix_setpgid,posix_setsid,posix_setuid,posix_setgid,posix_seteuid,posix_setegid,posix_uname\"
}" >> /usr/local/lsws/conf/vhosts/$NAME/$NAME.conf
			echoDone "HoÃ n táº¥t báº­t cháº·n nhá»¯ng hÃ m nguy hiá»ƒm website $NAME"
		fi
	fi
fi

# gia tri dieu kien khi chua duoc add phpIniOverride
if [[ $check_da_duoc_gan_gia_tri ]];then
	if [[ $check_open_shell_exec ]];then
		echo "Hiá»‡n táº¡i website $NAME Ä‘ang kÃ­ch hoáº¡t tÃ­nh nÄƒng cháº·n hÃ m nguy hiá»ƒm PHP"
		read -p "Báº¡n cÃ³ muá»‘n táº¯t cháº·n hÃ m shell_exec khÃ´ng? (y/n): " dongytat
		if [[ $dongytat = 'y' ]];then
			sed -i '/disable_functions/d' /usr/local/lsws/conf/vhosts/$NAME/$NAME.conf
			echoDone "HoÃ n táº¥t táº¯t cháº·n hÃ m shell_exec cá»§a website $NAME"
		fi
	else
		echo "Hiá»‡n táº¡i website $NAME khÃ´ng kÃ­ch hoáº¡t tÃ­nh nÄƒng cháº·n nhá»¯ng hÃ m nguy hiá»ƒm báº£o máº­t"
		read -p "Báº¡n cÃ³ muá»‘n báº­t cháº·n funtions nguy hiá»ƒm khÃ´ng? (y/n): " dongybat
		if [[ $dongybat = 'y' ]];then
			sed -i '/^phpIniOverride/a php_admin_value disable_functions "exec,system,passthru,shell_exec,dl,show_source,posix_kill,posix_mkfifo,posix_getpwuid,posix_setpgid,posix_setsid,posix_setuid,posix_setgid,posix_seteuid,posix_setegid,posix_uname"' /usr/local/lsws/conf/vhosts/$NAME/$NAME.conf
			echoDone "HoÃ n táº¥t báº­t cháº·n hÃ m shell_exec cá»§a website $NAME"
		fi
	fi
fi

#reboot láº¡i há»‡ thá»‘ng Ä‘á»ƒ xÃ¡c nháº­n
if [[ $dongybat = 'y' || $dongytat = 'y' ]];then
	/usr/local/lsws/bin/lswsctrl restart >/dev/null 2>&1
fi

check_menu_wptangtoc_active=$1
if [[ $check_menu_wptangtoc_active = "98" ]];then
	. /etc/wptt/wptt-bao-mat-main 1
fi


