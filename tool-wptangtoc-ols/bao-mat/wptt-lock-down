#!/bin/bash

function huong_dan() {
  T√≠nh nƒÉng Lockdown WordPress [b·∫£o m·∫≠t] n√≥ √°m ch·ªâ vi·ªác √°p d·ª•ng m·ªôt t·∫≠p h·ª£p c√°c bi·ªán ph√°p v√† c·∫•u h√¨nh b·∫£o m·∫≠t nghi√™m ng·∫∑t nh·∫±m kh√≥a ch·∫∑t v√† l√†m c·ª©ng [harden] website WordPress c·ªßa b·∫°n, gi·∫£m thi·ªÉu t·ªëi ƒëa c√°c b·ªÅ m·∫∑t t·∫•n c√¥ng v√† nguy c∆° b·ªã x√¢m nh·∫≠p. üõ°Ô∏èüîí‚öôÔ∏è

  N√≥i m·ªôt c√°ch ƒë∆°n gi·∫£n, lockdown l√† b·∫°n tri·ªÉn khai nhi·ªÅu l·ªõp b·∫£o v·ªá m·∫°nh m·∫Ω ƒë·ªÉ ni√™m phong c√°c khu v·ª±c nh·∫°y c·∫£m c·ªßa website, khi·∫øn cho k·∫ª x·∫•u kh√≥ c√≥ th·ªÉ ƒë·ªôt nh·∫≠p ho·∫∑c g√¢y h·∫°i. ho·∫∑c d√π c√≥ ƒë·ªôt nh·∫≠p ƒë∆∞·ª£c nh∆∞ng kh√¥ng th·ªÉ ph√° ho·∫°i ƒë∆∞·ª£c g√¨.

  M·ª•c ƒê√≠ch Ch√≠nh
  * N√¢ng cao b·∫£o m·∫≠t t·ªëi ƒëa: T·∫°o ra m·ªôt h√†ng r√†o ph√≤ng th·ªß v·ªØng ch·∫Øc ch·ªëng l·∫°i c√°c cu·ªôc t·∫•n c√¥ng d√≤ m·∫≠t kh·∫©u, m√£ ƒë·ªôc, v√† truy c·∫≠p tr√°i ph√©p.
  * B·∫£o v·ªá c√°c khu v·ª±c quan tr·ªçng: ƒê·∫∑c bi·ªát kh√≥a c√°c ph·∫ßn nh·∫°y c·∫£m nh∆∞ trang qu·∫£n tr·ªã [wp-admin], [Plugin], [Themes] v√† c√°c t·ªáp tin c·ªët l√µi [nh∆∞ wp-config.php].
  * Gi·∫£m thi·ªÉu b·ªÅ m·∫∑t t·∫•n c√¥ng: H·∫°n ch·∫ø ho·∫∑c v√¥ hi·ªáu h√≥a c√°c t√≠nh nƒÉng kh√¥ng c·∫ßn thi·∫øt c√≥ th·ªÉ b·ªã l·ª£i d·ª•ng.
  * Ph√≤ng ng·ª´a ch·ªß ƒë·ªông: √Åp d·ª•ng c√°c bi·ªán ph√°p m·∫°nh m·∫Ω ƒë·ªÉ ngƒÉn ch·∫∑n t·∫•n c√¥ng thay v√¨ ch·ªâ ph·∫£n ·ª©ng sau khi s·ª± c·ªë x·∫£y ra.
  M·ªôt website WordPress ƒë∆∞·ª£c lockdown s·∫Ω c√≥ kh·∫£ nƒÉng ch·ªëng ch·ªãu t·∫•n c√¥ng t·ªët h∆°n nhi·ªÅu, gi·∫£m thi·ªÉu r·ªßi ro v√† mang l·∫°i s·ª± an t√¢m h∆°n cho ng∆∞·ªùi qu·∫£n tr·ªã.
}

. /etc/wptt/.wptt.conf
if [[ $ngon_ngu = '' ]]; then
  ngon_ngu='vi'
fi
. /etc/wptt/lang/$ngon_ngu.sh

echo ""
echo ""
echo ""
echo "========================================================================="
echo "|$bao_mat => $bat/$tat Lock Down 	                                      |"
echo "========================================================================="
echo ""

RED='\033[0;31m'
NC='\033[0m'
xanh='\033[0;32m'

if [ "$(ls -A /etc/wptt/vhost | grep -v '^\.\.conf$' | grep -v '^\.\.conf$' | sort -uV)" ]; then
  echo
  echo "Ki·ªÉm tra website Lock Down:"
  echo "========================================================================="
  for entry in $(ls -A /etc/wptt/vhost | grep -v '^\.\.conf$' | sort -uV); do
    domain=$(echo "$entry" | sed 's/^.//' | sed 's/.conf//')
    path="/usr/local/lsws/$domain/html"
    i=1
    if [[ -d "$path" ]]; then
      unset lock_down
      . /etc/wptt/vhost/.$domain.conf
      if [[ $lock_down = '' ]]; then
        hoatdong="ƒêang ƒë∆∞·ª£c t·∫Øt"
        echo -e "H·ªá th·ªëng ki·ªÉm tra website $domain t√≠nh nƒÉng :${RED} $hoatdong${NC}"
      else
        hoatdong="ƒêang ƒë∆∞·ª£c b·∫≠t"
        echo -e "H·ªá th·ªëng ki·ªÉm tra website $domain t√≠nh nƒÉng :${xanh} $hoatdong${NC}"
      fi
    fi
  done
  echo "========================================================================="
  echo
fi

. /etc/wptt/tenmien
echo ""
echo ""
echo "$lua_chon_website_ban_muon $bat/$tat Lock Down: "
echo ""
lua_chon_NAME

. /etc/wptt/echo-color
unset lock_down
. /etc/wptt/vhost/.$NAME.conf

if [[ $lock_down = '' ]]; then
  echo "X√°c nh·∫≠n b·∫°n mu·ªën b·∫≠t t√≠nh nƒÉng Lock Down cho website ${NAME}? "
  prompt="Nh·∫≠p l·ª±a ch·ªçn c·ªßa b·∫°n [1-2]: "
  dongy="n"
  options=("ƒê·ªìng √Ω" "Kh√¥ng ƒë·ªìng √Ω")
  PS3="$prompt"
  select opt in "${options[@]}"; do
    case "$REPLY" in
    1)
      dongy="y"
      break
      ;;

    2)
      dongy="n"
      break
      ;;

    $((${#options[@]} + 1)))
      printf "\nB·∫°n nh·∫≠p sai h·ªá th·ªëng s·∫Ω ch·ªçn l√† kh√¥ng ƒë·ªìng √Ω\n"
      break
      ;;
    *)
      printf "B·∫°n nh·∫≠p sai h·ªá th·ªëng s·∫Ω ch·ªçn l√† kh√¥ng ƒë·ªìng √Ω\n"
      break
      ;;
    esac
  done

  if [[ $dongy = 'y' ]]; then

    _runing "K√≠ch ho·∫°t t√≠nh nƒÉng lock down"
    find /usr/local/lsws/"$NAME"/html -type f -print0 | xargs -0 chmod 404
    find /usr/local/lsws/"$NAME"/html -type d -print0 | xargs -0 chmod 515

    if [[ -f /usr/local/lsws/"$NAME"/html/wp-content/preload-wptangtoc-url.txt ]]; then
      chmod 644 /usr/local/lsws/"$NAME"/html/wp-content/preload-wptangtoc-url.txt
    fi

    if [[ -f /usr/local/lsws/"$NAME"/html/wp-content/preload-wptangtoc.json ]]; then
      chmod 644 /usr/local/lsws/"$NAME"/html/wp-content/preload-wptangtoc.json
    fi

    #lockdown v·∫´n c√≥ th·ªÉ uploads ƒë∆∞·ª£c d·ªØ li·ªáu wp-uploads
    if [[ -d /usr/local/lsws/"$NAME"/html/wp-content/uploads ]]; then
      find /usr/local/lsws/"$NAME"/html/wp-content/uploads -type d -print0 | xargs -0 chmod 755
    fi

    #chmod nh·ªØng file index.php trong th∆∞ m·ª•c uploads, b·∫£o m·∫≠t tr√°nh b·ªã ch√®n uploads php v√†o th∆∞ m·ª•c uploads
    unset uploads_dir_all
    uploads_dir_all=($(find /usr/local/lsws/$NAME/html/wp-content/uploads -type f -name "index.php"))
    if [[ $uploads_dir_all ]]; then
      for pull_index_path in ${uploads_dir_all[@]}; do
        chmod 404 $pull_index_path
      done
    fi

    . /etc/wptt/bao-mat/wptt-chattr-file-lock $NAME on

    #lockdown t∆∞∆°ng th√≠ch v·ªõi m·ªôt s·ªë plugin cache
    if [[ -d /usr/local/lsws/"$NAME"/html/wp-content/cache ]]; then
      find /usr/local/lsws/"$NAME"/html/wp-content/cache -type d -print0 | xargs -0 chmod 755
      find /usr/local/lsws/"$NAME"/html/wp-content/cache -type f -print0 | xargs -0 chmod 644
    fi

    #lockdown t∆∞∆°ng th√≠ch v·ªõi m·ªôt s·ªë plugin litespeed m·ªôt s·ªë ng∆∞·ªùi d√πng s·ª≠ d·ª•ng t√≠nh nƒÉng n√©n g·ªôp css,js
    if [[ -d /usr/local/lsws/"$NAME"/html/wp-content/litespeed ]]; then
      find /usr/local/lsws/"$NAME"/html/wp-content/litespeed -type d -print0 | xargs -0 chmod 755
      find /usr/local/lsws/"$NAME"/html/wp-content/litespeed -type f -print0 | xargs -0 chmod 644
    fi

    if [[ -f /etc/wptt/vhost/.$NAME.conf ]]; then
      sed -i '/lock_down/d' /etc/wptt/vhost/.$NAME.conf
      echo "lock_down=1" >>/etc/wptt/vhost/.$NAME.conf
    fi
    _rundone "K√≠ch ho·∫°t t√≠nh nƒÉng lock down"

  fi
fi

if [[ $lock_down ]]; then
  echo "X√°c nh·∫≠n b·∫°n mu·ªën t·∫Øt t√≠nh nƒÉng Lock Down cho website ${NAME}? "
  prompt="Nh·∫≠p l·ª±a ch·ªçn c·ªßa b·∫°n [1-2]: "
  dongy="n"
  options=("ƒê·ªìng √Ω" "Kh√¥ng ƒë·ªìng √Ω")
  PS3="$prompt"
  select opt in "${options[@]}"; do
    case "$REPLY" in
    1)
      dongy="y"
      break
      ;;

    2)
      dongy="n"
      break
      ;;

    $((${#options[@]} + 1)))
      printf "\nB·∫°n nh·∫≠p sai h·ªá th·ªëng s·∫Ω ch·ªçn l√† kh√¥ng ƒë·ªìng √Ω\n"
      break
      ;;
    *)
      printf "B·∫°n nh·∫≠p sai h·ªá th·ªëng s·∫Ω ch·ªçn l√† kh√¥ng ƒë·ªìng √Ω\n"
      break
      ;;
    esac
  done

  if [[ $dongy = 'y' ]]; then
    _runing "T·∫Øt t√≠nh nƒÉng lock down"

    . /etc/wptt/bao-mat/wptt-chattr-file-lock $NAME off

    find /usr/local/lsws/"$NAME"/html -type f -print0 | xargs -0 chmod 644
    find /usr/local/lsws/"$NAME"/html -type d -print0 | xargs -0 chmod 755

    if [[ -f /etc/wptt/vhost/.$NAME.conf ]]; then
      sed -i '/lock_down/d' /etc/wptt/vhost/.$NAME.conf
    fi
    _rundone "T·∫Øt t√≠nh nƒÉng lock down"
  fi
fi

check_menu_wptangtoc_active=$1
if [[ $check_menu_wptangtoc_active = "98" ]]; then
  . /etc/wptt/wptt-bao-mat-main 1
fi
