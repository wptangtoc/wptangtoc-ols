#!/bin/bash

set -e

if ! command -v jq &>/dev/null; then
  echo "Lá»—i: Lá»‡nh 'jq' khÃ´ng tá»“n táº¡i. Vui lÃ²ng cÃ i Ä‘áº·t báº±ng lá»‡nh:"
  echo "sudo dnf install jq -y"
  exit 1
fi

MAP_NAME="blacklist_map"
MAP_ID=$(sudo bpftool map list | grep "$MAP_NAME" | awk '{print $1}' | sed 's/://')

if [ -z "$MAP_ID" ]; then
  echo "Lá»—i: KhÃ´ng tÃ¬m tháº¥y '$MAP_NAME'."
  exit 1
fi

echo "TÃ¬m tháº¥y '$MAP_NAME' vá»›i ID: $MAP_ID"

# *** THAY Äá»”I DUY NHáº¤T Náº°M á» ÄÃ‚Y ***
# Sá»­a láº¡i lá»‡nh jq Ä‘á»ƒ giá»¯ láº¡i tiá»n tá»‘ "0x" báº±ng cÃ¡ch dÃ¹ng join(" ")
HEX_KEY_LIST=$(sudo bpftool -j map dump id "$MAP_ID" | jq -r '.[].key | join(" ")')

if [ -z "$HEX_KEY_LIST" ]; then
  echo "ThÃ´ng bÃ¡o: '$MAP_NAME' Ä‘Ã£ trá»‘ng. âœ…"
  exit 0
fi

echo "Báº¯t Ä‘áº§u quÃ¡ trÃ¬nh gá»¡ cháº·n táº¥t cáº£ IP..."

# VÃ²ng láº·p nÃ y bÃ¢y giá» sáº½ nháº­n Ä‘Æ°á»£c input chuáº©n: "0x7b 0x19 0x21 0x02"
echo "$HEX_KEY_LIST" | while read -r key_line; do
  echo "  -> Äang xÃ³a IP vá»›i key: $key_line"
  sudo bpftool map delete id "$MAP_ID" key $key_line
done

echo "HoÃ n táº¥t! ÄÃ£ xÃ³a thÃ nh cÃ´ng toÃ n bá»™ IP khá»i danh sÃ¡ch Ä‘en. ğŸ‘"
