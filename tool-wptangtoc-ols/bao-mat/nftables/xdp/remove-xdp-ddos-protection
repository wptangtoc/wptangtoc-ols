#!/bin/bash

# --- CẤU HÌNH ---
# Thay thế 'eth0' bằng tên card mạng thực tế của bạn nếu cần
IFACE="eth0"

# Tên chương trình và map đã pin
PINNED_PROG="/sys/fs/bpf/xdp_ddos_protection_prog"
PINNED_MAP="/sys/fs/bpf/log_blacklist"

# Tên file dịch vụ systemd
SERVICE_FILE="/etc/systemd/system/ddos-blocker-xdp.service"

echo "Bat dau qua trinh go bo he thong XDP Blocker..."
echo "--------------------------------------------------"

# Bước 1: Dừng và vô hiệu hóa dịch vụ Go
echo "[1/4] Dang dung va vo hieu hoa dich vu 'ddos-blocker-xdp'..."
if systemctl is-active --quiet ddos-blocker-xdp.service; then
  sudo systemctl stop ddos-blocker-xdp.service
  echo "--> Da dung dich vu."
else
  echo "--> Dich vu khong hoat dong."
fi

if systemctl is-enabled --quiet ddos-blocker-xdp.service; then
  sudo systemctl disable ddos-blocker-xdp.service
  echo "--> Da vo hieu hoa dich vu."
else
  echo "--> Dich vu chua duoc kich hoat."
fi

# Bước 2: Gỡ chương trình XDP khỏi card mạng
echo "[2/4] Dang go chuong trinh XDP khoi card mang '${IFACE}'..."
sudo bpftool net detach xdp dev "${IFACE}" || true
echo "--> Da go chuong trinh."

# Bước 3: Xóa các file đã được pin trong BPF filesystem
echo "[3/4] Dang xoa cac file da pin..."
if [ -f "$PINNED_PROG" ]; then
  sudo rm -f "$PINNED_PROG"
  echo "--> Da xoa file chuong trinh: $PINNED_PROG"
fi
if [ -f "$PINNED_MAP" ]; then
  sudo rm -f "$PINNED_MAP"
  echo "--> Da xoa file map: $PINNED_MAP"
fi

# Bước 4: Xóa file dịch vụ systemd
echo "[4/4] Dang xoa file dich vu systemd..."
if [ -f "$SERVICE_FILE" ]; then
  sudo rm -f "$SERVICE_FILE"
  sudo systemctl daemon-reload
  echo "--> Da xoa file dich vu va tai lai daemon."
fi

if [[ -f /usr/local/bin/start_blocker.sh ]]; then
  rm -f /usr/local/bin/start_blocker.sh
fi

cat <(crontab -l) | sed "/cleanup_maps/d" | crontab -
if $(cat /etc/*release | grep -q "Ubuntu"); then
  systemctl restart cron
else
  systemctl restart crond
fi
rm -f /etc/wptt/bao-mat/nftables/xdp/go.mod
rm -f /etc/wptt/bao-mat/nftables/xdp/go.sum
rm -rf /etc/xdp-protection

if systemctl is-active --quiet ddos-blocker-xdp-access.service; then
  SERVICE_FILE="/etc/systemd/system/ddos-blocker-xdp-access.service"
  systemctl stop ddos-blocker-xdp-access
  systemctl disable ddos-blocker-xdp-access
  rm -f $SERVICE_FILE
fi

echo "--------------------------------------------------"
echo "✅ Da go bo thanh cong!"
echo "Kiem tra lai trang thai:"
bpftool net list dev "${IFACE}"
ls -l /sys/fs/bpf/

check_con_map_khong=$(bpftool map list 2>/dev/null)
if [[ $check_con_map_khong ]]; then
  echo "Map vẫn còn nếu muốn clean hẳn hãy reboot lại máy chủ"
fi
