#!/bin/bash

# Kแปch bแบฃn ฤแป gแปก chแบทn thแปง cรดng mแปt ฤแปa chแป IP khแปi XDP map,
# tฦฐฦกng thรญch vแปi XDP dรนng __builtin_bswap32.

set -e

# --- CแบคU HรNH ---
# Tรชn map phแบฃi khแปp vแปi map ฤฦฐแปฃc dรนng ฤแป chแบทn
MAP_NAME="log_blacklist"

# --- LOGIC CHรNH ---

# 1. Kiแปm tra xem ngฦฐแปi dรนng cรณ cung cแบฅp IP khรดng
if [ -z "$1" ]; then
  echo "Lแปi: Vui lรฒng cung cแบฅp ฤแปa chแป IP cแบงn gแปก chแบทn."
  echo "Vรญ dแปฅ sแปญ dแปฅng: sudo $0 1.2.3.4"
  exit 1
fi

IP_TO_UNBAN=$1

# 2. Tรฌm ID cแปงa BPF map
MAP_ID=$(sudo bpftool map list | grep "$MAP_NAME" | awk '{print $1}' | sed 's/://' || true)

if [ -z "$MAP_ID" ]; then
  echo "Lแปi: Khรดng tรฌm thแบฅy map '$MAP_NAME'."
  exit 1
fi

# 3. Chuyแปn ฤแปi IP sang dแบกng 4 byte hexa, little-endian
#    (PHแบขI GIแปNG HแปT logic cแปงa script chแบทn ฤแป tรฌm ฤรบng key)
HEX_KEY=$(echo "$IP_TO_UNBAN" |
  awk -F. '{
            printf "0x%02x 0x%02x 0x%02x 0x%02x\n", $4, $3, $2, $1
          }')

echo "ฤang gแปก chแบทn IP: $IP_TO_UNBAN"

# 4. Xรณa IP khแปi BPF map bแบฑng key
#    Lแปnh `delete` chแป cแบงn `key`, khรดng cแบงn `value`.
sudo bpftool map delete id "$MAP_ID" key $HEX_KEY

echo "โ ฤรฃ gแปก thรnh cรดng IP $IP_TO_UNBAN khแปi danh sรกch ฤen."

# 5. Kiแปm tra lแบกi ฤแป chแบฏc chแบฏn key khรดng cรฒn tแปn tแบกi
echo "--- Kiแปm tra lแบกi map '$MAP_NAME' ---"
# Lแปnh `lookup` sแบฝ thแบฅt bแบกi (exit code != 0) nแบฟu khรดng tรฌm thแบฅy key
if sudo bpftool map lookup id "$MAP_ID" key $HEX_KEY >/dev/null 2>&1; then
  echo "โ๏ธ Cแบฃnh bรกo: Vแบซn tรฌm thแบฅy IP $IP_TO_UNBAN trong map. Gแปก chแบทn cรณ thแป ฤรฃ thแบฅt bแบกi."
else
  echo "๐ Xรกc nhแบญn: IP $IP_TO_UNBAN khรดng cรฒn trong map."
fi
