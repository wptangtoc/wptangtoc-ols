#!/bin/bash

set -e

# --- PHẦN CHÍNH CỦA SCRIPT ---
if ! command -v jq &>/dev/null; then
  echo "Lỗi: Lệnh 'jq' không tồn tại. Vui lòng cài đặt bằng lệnh:"
  echo "sudo dnf install jq -y"
  exit 1
fi

# Định nghĩa danh sách các map blacklist cần kiểm tra
MAPS_TO_CHECK=("log_blacklist" "rl_blacklist")

TOTAL_BLOCKED_COUNT=0

echo "--- Bat dau kiem tra so luong IP bi chan ---"

# Lặp qua từng map để đếm
for map_name in "${MAPS_TO_CHECK[@]}"; do

  # Dùng `bpftool map dump` và `jq` để đếm số phần tử trong map
  # `|| echo 0` để xử lý trường hợp map không tồn tại hoặc trống
  COUNT=$(sudo bpftool -j map dump name "$map_name" 2>/dev/null | jq 'length' || echo 0)

  echo "So IP bi chan trong map '$map_name': $COUNT"

  # Cộng dồn vào tổng số
  TOTAL_BLOCKED_COUNT=$((TOTAL_BLOCKED_COUNT + COUNT))
done

echo "---------------------------------------------"
echo "✅ Tổng số ip hiện đang bị chặn: $TOTAL_BLOCKED_COUNT"
