#!/bin/bash

function huong_dan() {
  WPTangToc OLS cÃ³ tÃ­nh nÄƒng chá»‘ng DDoS LiteSpeed Web Server, thÃ¬ Ä‘Ã¢y lÃ  chá»©c nÄƒng giÃºp báº¡n cáº¥u hÃ¬nh vÃ  táº­n dá»¥ng cÃ¡c cÆ¡ cháº¿ báº£o vá»‡ tÃ­ch há»£p sáºµn ngay bÃªn trong mÃ¡y chá»§ web OpenLiteSpeed [OLS] Ä‘á»ƒ chá»‘ng láº¡i cÃ¡c cuá»™c táº¥n cÃ´ng tá»« chá»‘i dá»‹ch vá»¥ [DDoS] hoáº·c cÃ¡c truy cáº­p quÃ¡ má»©c.

  KhÃ¡c vá»›i Fail2ban [hoáº¡t Ä‘á»™ng báº±ng cÃ¡ch Ä‘á»c log vÃ  cháº·n qua firewall], cÃ¡c tÃ­nh nÄƒng nÃ y hoáº¡t Ä‘á»™ng trá»±c tiáº¿p táº¡i táº§ng web server, thÆ°á»ng táº­p trung vÃ o viá»‡c giá»›i háº¡n káº¿t ná»‘i vÃ  yÃªu cáº§u [throttling].

  TÃ­nh nÄƒng Chá»‘ng DDoS TÃ­ch há»£p cá»§a LiteSpeed Web Server
  ðŸ›¡ï¸ Má»¥c Ä‘Ã­ch chÃ­nh:
  * Báº£o vá»‡ MÃ¡y chá»§: NgÄƒn cháº·n cÃ¡c Ä‘á»‹a chá»‰ IP Ä‘Æ¡n láº» hoáº·c cÃ¡c bot táº¡o ra quÃ¡ nhiá»u káº¿t ná»‘i hoáº·c yÃªu cáº§u, lÃ m cáº¡n kiá»‡t tÃ i nguyÃªn mÃ¡y chá»§ [CPU, RAM, connections].
  * Duy trÃ¬ á»”n Ä‘á»‹nh: GiÃºp website hoáº¡t Ä‘á»™ng á»•n Ä‘á»‹nh hÆ¡n ngay cáº£ khi cÃ³ lÆ°á»£ng truy cáº­p cao hoáº·c Ä‘ang bá»‹ táº¥n cÃ´ng á»Ÿ má»©c Ä‘á»™ nhá» Ä‘áº¿n vá»«a.
  * Pháº£n á»©ng Nhanh: VÃ¬ lÃ  tÃ­nh nÄƒng tÃ­ch há»£p, OLS cÃ³ thá»ƒ pháº£n á»©ng ráº¥t nhanh vá»›i cÃ¡c thay Ä‘á»•i vá» lÆ°u lÆ°á»£ng truy cáº­p.

  âœ… Lá»£i Ã­ch:
  * Hiá»‡u suáº¥t Cao: Xá»­ lÃ½ ngay táº¡i táº§ng web server, ráº¥t nhanh vÃ  hiá»‡u quáº£.
  * TÃ­ch há»£p Sáºµn: KhÃ´ng cáº§n cÃ i Ä‘áº·t thÃªm pháº§n má»m bÃªn ngoÃ i.
  * Kiá»ƒm soÃ¡t Trá»±c tiáº¿p: Quáº£n lÃ½ trá»±c tiáº¿p cÃ¡ch OLS xá»­ lÃ½ cÃ¡c káº¿t ná»‘i.

  TÃ³m láº¡i: TÃ­nh nÄƒng nÃ y trong WPTangToc OLS giÃºp báº¡n khai thÃ¡c vÃ  quáº£n lÃ½ cÃ¡c cÆ¡ cháº¿ phÃ²ng thá»§ DDoS tÃ­ch há»£p sáºµn cá»§a OpenLiteSpeed, chá»§ yáº¿u thÃ´ng qua viá»‡c giá»›i háº¡n káº¿t ná»‘i vÃ  yÃªu cáº§u tá»« má»—i IP, táº¡o thÃªm má»™t lá»›p báº£o vá»‡ quan trá»ng cho website cá»§a báº¡n.

  Mode limit chá»‘ng ddos LiteSpeed thiáº¿t láº­p nhÆ° sau:
  Náº¿u IP Ä‘Ã³ truy cáº­p gá»i file tÃ­nh static 40 yÃªu cáº§u / giÃ¢y sáº½ bá»‹ cháº·n
  Náº¿u IP Ä‘Ã³ truy cáº­p gá»i file tÃ­nh Ä‘á»™ng [html document] 3 yÃªu cáº§u / giÃ¢y sáº½ bá»‹ cháº·n
  Náº¿u IP Ä‘Ã³ truy cáº­p gá»i file tÃ­nh Ä‘á»™ng [html document] quÃ¡ 20 giÃ¢y sáº½ bá»‹ cháº·n
}

. /etc/wptt/echo-color
. /etc/wptt/.wptt.conf

if [[ $mod_chong_ddos = '' ]]; then
  echo "XÃ¡c nháº­n báº¡n muá»‘n sá»­ dá»¥ng cháº¿ Ä‘á»™ chá»‘ng ddos tÃ´i Ä‘ang bá»‹ táº¥n cÃ´ng"
  prompt="Nháº­p lá»±a chá»n cá»§a báº¡n [1-2]: "
  dongy="n"
  options=("Äá»“ng Ã½" "KhÃ´ng Ä‘á»“ng Ã½")
  PS3="$prompt"
  select opt in "${options[@]}"; do
    case "$REPLY" in
    1)
      dongy="y"
      break
      ;;

    2)
      dongy="n"
      break
      ;;

    $((${#options[@]} + 1)))
      printf "\nBáº¡n nháº­p sai há»‡ thá»‘ng sáº½ chá»n lÃ  khÃ´ng Ä‘á»“ng Ã½\n"
      break
      ;;
    *)
      printf "Báº¡n nháº­p sai há»‡ thá»‘ng sáº½ chá»n lÃ  khÃ´ng Ä‘á»“ng Ã½\n"
      break
      ;;
    esac
  done

  if [[ $dongy = 'n' ]]; then
    . /etc/wptt/wptt-bao-mat-main 1
  fi

  _runing "Báº­t cháº¿ Ä‘á»™ chá»‘ng ddos tÃ´i Ä‘ang bá»‹ táº¥n cÃ´ng"
  #Báº¡n nÃªn Ä‘iá»u chá»‰nh Max Connections vÃ  Max SSL Connections cao hÆ¡n bÃ¬nh thÆ°á»ng cÃ³ thá»ƒ 30k hay 20k, hoáº·c tháº­m chÃ­ cao hÆ¡n miá»…n lÃ  mÃ¡y chá»§ cÃ³ Ä‘á»§ bá»™ nhá»› ram trá»‘ng. Má»¥c Ä‘Ã­ch cá»§a viá»‡c thay Ä‘á»•i lÃ  Ä‘á»ƒ tÄƒng dung lÆ°á»£ng, khÃ´ng pháº£i Ä‘á»ƒ giá»›i háº¡n báº£n thÃ¢n dÆ°á»›i cuá»™c táº¥n cÃ´ng DoS.

  work_cpucore='1024'
  cpucore=$(grep -c ^processor /proc/cpuinfo)

  # gáº¥p 4 láº§n so vá»›i hiá»‡n táº¡i: bÃ¬nh thÆ°á»ng nhÃ¢n 3, ddos cho nhÃ¢n 12: táº­n chÃ­ cÃ³ thá»ƒ cao hÆ¡n, Ä‘á»ƒ trÃ¡nh sáº­p port 443
  max_client_max=$(expr $work_cpucore \* $cpucore \* 12)

  #cho tuning lÃªn cao khg bá»‹ xung Ä‘á»™t thá»±c thi trÆ°á»›c, khÃ´ng nÃ³ xoÃ¡ máº¥t perClientConnLimit

  #  connTimeout             20 tá»©c lÃ  thá»i gian káº¿t ná»‘i tá»‘i Ä‘a Ä‘á»ƒ chá»‘ng ká»¹ thuáº­t: slowloris, cÃ³ thá»ƒ giáº£m xuá»‘ng 5 Ä‘áº¿n 15 náº¿u muá»‘n.
  sed -i -e '/^tuning /,/^}$/d' /usr/local/lsws/conf/httpd_config.conf
  echo "tuning  {
  maxConnections          $max_client_max
  maxSSLConnections       $max_client_max
  connTimeout             20
  maxKeepAliveReq         1000
  keepAliveTimeout        10
  sndBufSize              0
  rcvBufSize              0
  maxReqURLLen            32768
  maxReqHeaderSize        65536
  maxReqBodySize          2047M
  maxDynRespHeaderSize    32768
  maxDynRespSize          2047M
  maxCachedFileSize       4096
  totalInMemCacheSize     20M
  maxMMapFileSize         256K
  totalMMapCacheSize      40M
  useSendfile             1
  fileETag                28
  enableGzipCompress      1
  compressibleTypes       default
  enableDynGzipCompress   1
  gzipCompressLevel       1
  gzipAutoUpdateStatic    1
  gzipStaticCompressLevel 6
  brStaticCompressLevel   6
  gzipMaxFileSize         10M
  gzipMinFileSize         300

  quicEnable              1
  quicShmDir              /dev/shm
} " >>/usr/local/lsws/conf/httpd_config.conf

  sed -i -e '/^perClientConnLimit /,/^}$/d' /usr/local/lsws/conf/httpd_config.conf
  sed -i -e '/^lsrecaptcha /,/^}$/d' /usr/local/lsws/conf/httpd_config.conf

  #nÃªn Ä‘áº·t 3 yÃªu cáº§u html trá»Ÿ lÃªn, trÃªn 1/giÃ¢y vÃ¬ cÃ³ thá»ƒ ngÆ°á»i dÃ¹ng sáº½ dÃ¹ng tÃ­nh nÄƒng hover thÃ¬ cÃ³ thá»ƒ bá»‹ gÃ¢y cháº·n khÃ´ng cáº§n thiáº¿t
  #quÃ¡ 20 giÃ¢y cháº·n slow http
  #Ã½ nghÄ©a config YÃªu cáº§u tÄ©nh/giÃ¢y = 40, vÃ  YÃªu cáº§u Ä‘á»™ng/giÃ¢y = 3 Ä‘iá»u tiáº¿t bÄƒng thÃ´ng.
  #banPeriod: náº¿u bá»‹ quÃ¡ sáº½ bá»‹ khoÃ¡ 600 giÃ¢y (10 PHÃºt) cÃ³ thá»ƒ tÄƒng cao hÆ¡n náº¿u muá»‘n
  #hardLimit náº¿u 20 káº¿t ná»‘i trong vÃ²ng 15 gracePeriod thÃ¬ bá»‹ block 600 giÃ¢y

  #https://docs.litespeedtech.com/lsws/cp/cpanel/antiddos/

  #softLimit lÃ  Khi má»™t IP Ä‘áº¡t Ä‘áº¿n 15 káº¿t ná»‘i Ä‘á»“ng thá»i, LiteSpeed sáº½ báº¯t Ä‘áº§u giáº£m Æ°u tiÃªn cá»§a nÃ³.
  #hardLimit lÃ  Khi má»™t IP Ä‘áº¡t Ä‘áº¿n 20 káº¿t ná»‘i Ä‘á»“ng thá»i, LiteSpeed sáº½ báº¯t Ä‘áº§u block cháº·n.
  cat >>"/usr/local/lsws/conf/httpd_config.conf" <<EOF
perClientConnLimit {
  staticReqPerSec         40
  dynReqPerSec            3
  outBandwidth            0
  inBandwidth             0
  softLimit               15
  hardLimit               20
  blockBadReq             1
  gracePeriod             15
  banPeriod               900
}
EOF

  echo 'lsrecaptcha  {
  enabled                 1
  type                    1

  botWhiteList  {

  }
}' >>/usr/local/lsws/conf/httpd_config.conf

  sed -i '/mod_chong_ddos/d' /etc/wptt/.wptt.conf
  echo 'mod_chong_ddos=1' >>/etc/wptt/.wptt.conf
  /usr/local/lsws/bin/lswsctrl restart >/dev/null 2>&1
  _rundone "Báº­t cháº¿ Ä‘á»™ chá»‘ng ddos tÃ´i Ä‘ang bá»‹ táº¥n cÃ´ng"
  echo "Khi cÆ¡n bÃ£o Ä‘Ã£ qua Ä‘i (háº¿t bá»‹ hacker sÆ¡ mÃºi) thÃ¬ hÃ£y táº¯t cháº¿ Ä‘á»™ nÃ y Ä‘á»ƒ Ä‘á»ƒ cho website hoáº¡t Ä‘á»™ng tá»‘t nháº¥t"
fi

if [[ $mod_chong_ddos ]]; then
  echo "XÃ¡c nháº­n báº¡n muá»‘n táº¯t cháº¿ Ä‘á»™ chá»‘ng ddos tÃ´i Ä‘ang bá»‹ táº¥n cÃ´ng"
  prompt="Nháº­p lá»±a chá»n cá»§a báº¡n [1-2]: "
  dongy="n"
  options=("Äá»“ng Ã½" "KhÃ´ng Ä‘á»“ng Ã½")
  PS3="$prompt"
  select opt in "${options[@]}"; do
    case "$REPLY" in
    1)
      dongy="y"
      break
      ;;

    2)
      dongy="n"
      break
      ;;

    $((${#options[@]} + 1)))
      printf "\nBáº¡n nháº­p sai há»‡ thá»‘ng sáº½ chá»n lÃ  khÃ´ng Ä‘á»“ng Ã½\n"
      break
      ;;
    *)
      printf "Báº¡n nháº­p sai há»‡ thá»‘ng sáº½ chá»n lÃ  khÃ´ng Ä‘á»“ng Ã½\n"
      break
      ;;
    esac
  done

  if [[ $dongy = 'n' ]]; then
    . /etc/wptt/wptt-bao-mat-main 1
  fi

  _runing "Táº¯t cháº¿ Ä‘á»™ chá»‘ng ddos tÃ´i Ä‘ang bá»‹ táº¥n cÃ´ng"

  work_cpucore='1024'
  cpucore=$(grep -c ^processor /proc/cpuinfo)

  # gáº¥p 4 láº§n so vá»›i hiá»‡n táº¡i: bÃ¬nh thÆ°á»ng nhÃ¢n 3
  max_client_max=$(expr $work_cpucore \* $cpucore \* 3)

  sed -i -e '/^tuning /,/^}$/d' /usr/local/lsws/conf/httpd_config.conf
  echo "tuning  {
  maxConnections          $max_client_max
  maxSSLConnections       $max_client_max
  connTimeout             300
  maxKeepAliveReq         1000
  keepAliveTimeout        10
  sndBufSize              0
  rcvBufSize              0
  maxReqURLLen            32768
  maxReqHeaderSize        65536
  maxReqBodySize          2047M
  maxDynRespHeaderSize    32768
  maxDynRespSize          2047M
  maxCachedFileSize       4096
  totalInMemCacheSize     20M
  maxMMapFileSize         256K
  totalMMapCacheSize      40M
  useSendfile             1
  fileETag                28
  enableGzipCompress      1
  compressibleTypes       default
  enableDynGzipCompress   1
  gzipCompressLevel       1
  gzipAutoUpdateStatic    1
  gzipStaticCompressLevel 6
  brStaticCompressLevel   6
  gzipMaxFileSize         10M
  gzipMinFileSize         300

  quicEnable              1
  quicShmDir              /dev/shm
} " >>/usr/local/lsws/conf/httpd_config.conf

  sed -i -e '/^perClientConnLimit /,/^}$/d' /usr/local/lsws/conf/httpd_config.conf
  sed -i -e '/^lsrecaptcha /,/^}$/d' /usr/local/lsws/conf/httpd_config.conf
  echo 'perClientConnLimit  {
  softLimit               100000
  hardLimit               150000
}' >>/usr/local/lsws/conf/httpd_config.conf
  sed -i '/mod_chong_ddos/d' /etc/wptt/.wptt.conf
  /usr/local/lsws/bin/lswsctrl restart >/dev/null 2>&1
  _rundone "Táº¯t cháº¿ Ä‘á»™ chá»‘ng ddos tÃ´i Ä‘ang bá»‹ táº¥n cÃ´ng"
fi

check_menu_wptangtoc_active=$1
if [[ $check_menu_wptangtoc_active = "98" ]]; then
  . /etc/wptt/wptt-bao-mat-main 1
fi
