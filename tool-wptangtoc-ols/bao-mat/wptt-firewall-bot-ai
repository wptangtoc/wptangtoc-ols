#!/bin/bash

function huong_dan() {
  Tính năng Block AI Crawlers:
  * Tiết kiệm tài nguyên: Các Bot AI quét dữ liệu rất hung hãn, gây tốn CPU và làm chậm website. Chặn chúng giúp server nhẹ gánh hơn.
  * Bảo vệ bản quyền: Ngăn chặn các công ty AI lấy bài viết chất xám của bạn để huấn luyện miễn phí.
  * Ưu tiên người dùng: Dành trọn băng thông cho khách truy cập thật và Google Bot [SEO].

  Đừng để AI xài chùa tài nguyên của bạn! Tính năng này sẽ đá bay các con bot của OpenAI, Anthropic,... ra khỏi server. Vừa đỡ tốn RAM, vừa không bị AI học lỏm nội dung web.
  Khuyên dùng nếu VPS cấu hình yếu.
}

. /etc/wptt/.wptt.conf
if [[ $ngon_ngu = '' ]]; then
  ngon_ngu='vi'
fi
. /etc/wptt/lang/$ngon_ngu.sh

echo ""
echo ""
echo ""
. /etc/wptt/echo-color
NAME=$1
if [[ $NAME = "98" ]]; then
  NAME=""
fi
if [[ $NAME = "" ]]; then
  echo ""
  echo ""
  echo ""
  echo "========================================================================="
  echo "|$bao_mat => $bat $tuong_lua Chặn BOT AI Crawlers                         |"
  echo "========================================================================="

  RED='\033[0;31m'
  NC='\033[0m'
  xanh='\033[0;32m'

  if [ "$(ls -A /etc/wptt/vhost | grep -v '^\.\.conf$' | sort -uV)" ]; then
    echo
    echo "Kiểm tra website kích hoạt tường lửa Chặn BOT AI Crawlers:"
    echo "========================================================================="
    for entry in $(ls -A /etc/wptt/vhost | grep -v '^\.\.conf$' | sort -uV); do
      domain=$(echo "$entry" | sed 's/^.//' | sed 's/.conf//')
      path="/usr/local/lsws/$domain/html/.htaccess"
      i=1
      if [[ -f "$path" ]]; then
        if [[ $(cat /usr/local/lsws/$domain/html/.htaccess | grep '#begin-tuong-lua-block-bot-ai') = '' ]]; then
          hoatdong="Đang được tắt"
          tuan_7g='1'
          echo -e "Hệ thống kiểm tra website $domain :${RED} $hoatdong${NC}"
        else
          hoatdong="Đang được bật"
          echo -e "Hệ thống kiểm tra website $domain :${xanh} $hoatdong${NC}"
        fi
      fi
    done
    echo "========================================================================="
    echo
  fi

  if [[ $tuan_7g = '' ]]; then
    . /etc/wptt/echo-color
    echoDo "Tất cả website được kích hoạt tường lửa Chặn BOT AI Crawlers hết rồi"
    check_menu_wptangtoc_active=$1
    if [[ $check_menu_wptangtoc_active = "98" ]]; then
      . /etc/wptt/wptt-bao-mat-main 1
    fi
    return 2>/dev/null
    exit
  fi

  . /etc/wptt/tenmien-them-lua-chon-tat-ca-website
  echo ""
  echo ""
  echo "$lua_chon_website_ban_muon $bat $tuong_lua Chặn BOT AI Crawlers: "
  echo ""
  lua_chon_NAME
fi

if [[ $NAME = 'Tất cả website' ]]; then
  if [ "$(ls -A /etc/wptt/vhost | grep -v '^\.\.conf$' | sort -uV)" ]; then
    for entry in $(ls -A /etc/wptt/vhost | grep -v '^\.\.conf$' | sort -uV); do
      domain=$(echo $entry | sed 's/^.//' | sed 's/.conf//')
      path_html="/usr/local/lsws/$domain/html"
      i=1
      if [ "$domain" != "${domain/./}" ] && [ "$domain" != '.' ]; then #điều kiện domain phải có dấu . và lỗi chỉ có only .
        if [[ -d "$path_html" ]]; then
          _runing "Thiết lập tường lửa Chặn BOT AI Crawlers website $domain"
          if [[ $(cat /usr/local/lsws/$domain/html/.htaccess | grep '#begin-tuong-lua-block-bot-ai') = '' ]]; then
            (/etc/wptt/bao-mat/wptt-firewall-bot-ai $domain >/dev/null 2>&1)
          fi
          _rundone "Thiết lập tường lửa Chặn BOT AI Crawlers website $domain"
        fi
      fi
    done
  fi

  check_menu_wptangtoc_active=$1
  if [[ $check_menu_wptangtoc_active = "98" ]]; then
    . /etc/wptt/wptt-bao-mat-main 1
  fi

  exit
fi

if [[ "$NAME" = "0" || "$NAME" = "" ]]; then
  . /etc/wptt/wptt-bao-mat-main 1
fi

pathcheck="/etc/wptt/vhost/.$NAME.conf"
if [[ ! -f "$pathcheck" ]]; then
  clear
  echoDo "Tên miền không tồn tại trên hệ thống này"
  sleep 3
  . /etc/wptt/wptt-bao-mat-main 1
  exit
fi

if [[ ! -f /usr/local/lsws/$NAME/html/.htaccess ]]; then
  echoDo "Không xác định được file .htaccess"
  exit
fi

echo "Thiết lập tường lửa Chặn BOT AI website $NAME: $(date '+%d-%m-%Y %H:%M')" >>/var/log/wptangtoc-ols.log

#nguyên tắc là cho biến quy tắc phải đưa lên trên cùng của file .htaccess trên quy tắc của lịnk wordpres thì mới hoạt động
quy_tac=$(cat /etc/wptt/bao-mat/firewall-bot-ai.txt)
htaccess_hien_tai=$(cat /usr/local/lsws/$NAME/html/.htaccess)

#kiểm tra đã kích hoạt trước đó chưa
if [[ $(echo $htaccess_hien_tai | grep '#begin-tuong-lua-block-bot-ai') ]]; then
  echoDo "website $NAME đã được kích hoạt tường lửa Chặn BOT AI trước đó rồi"
  . /etc/wptt/wptt-bao-mat-main 1
  exit
fi

echo "$quy_tac" >/usr/local/lsws/$NAME/html/.htaccess
echo "$htaccess_hien_tai" >>/usr/local/lsws/$NAME/html/.htaccess

#clear htaccess chuyen vhost
vhost_chuyen_htaccess=''
. /etc/wptt/vhost/.$NAME.conf
if [[ $vhost_chuyen_htaccess ]]; then
  . /etc/wptt/wptt-htaccess-tat-chuyen-doi-vhost $NAME >/dev/null 2>&1
fi

/usr/local/lsws/bin/lswsctrl restart >/dev/null 2>&1
echoDone "Hoàn tất kích hoạt tường lửa Chặn BOT AI Crawlers cho website $NAME"

check_menu_wptangtoc_active=$1
if [[ $check_menu_wptangtoc_active = "98" ]]; then
  . /etc/wptt/wptt-bao-mat-main 1
fi
