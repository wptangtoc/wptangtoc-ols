#!/bin/bash

function huong_dan(){
TÃ­nh nÄƒng Há»§y cÃ i Ä‘áº·t CSF [Uninstall CSF] trong WPTangToc OLS cho phÃ©p báº¡n gá»¡ bá» hoÃ n toÃ n ConfigServer Security & Firewall [CSF] vÃ  cÃ¡c thÃ nh pháº§n liÃªn quan [nhÆ° Login Failure Daemon - LFD] ra khá»i mÃ¡y chá»§ cá»§a mÃ¬nh.

ğŸ¯ Má»¥c Ä‘Ã­ch cá»§a viá»‡c há»§y cÃ i Ä‘áº·t CSF
NgÆ°á»i dÃ¹ng cÃ³ thá»ƒ muá»‘n gá»¡ bá» CSF vÃ¬ má»™t sá»‘ lÃ½ do:
 * Kháº¯c phá»¥c sá»± cá»‘: Náº¿u CSF bá»‹ nghi ngá» gÃ¢y ra xung Ä‘á»™t vá»›i cÃ¡c dá»‹ch vá»¥ khÃ¡c hoáº·c cháº·n nháº§m cÃ¡c truy cáº­p há»£p lá»‡ mÃ  khÃ³ cáº¥u hÃ¬nh láº¡i.
 * Chuyá»ƒn Ä‘á»•i giáº£i phÃ¡p tÆ°á»ng lá»­a: Quyáº¿t Ä‘á»‹nh sá»­ dá»¥ng má»™t pháº§n má»m tÆ°á»ng lá»­a khÃ¡c thay tháº¿ cho CSF.
 * ÄÆ¡n giáº£n hÃ³a há»‡ thá»‘ng: Náº¿u khÃ´ng cÃ²n nhu cáº§u sá»­ dá»¥ng cÃ¡c tÃ­nh nÄƒng nÃ¢ng cao cá»§a CSF hoáº·c cáº£m tháº¥y nÃ³ quÃ¡ phá»©c táº¡p Ä‘á»ƒ quáº£n lÃ½.
 * Dá»n dáº¹p trÆ°á»›c khi cÃ i Ä‘áº·t láº¡i: Muá»‘n gá»¡ bá» hoÃ n toÃ n phiÃªn báº£n hiá»‡n táº¡i Ä‘á»ƒ thá»±c hiá»‡n cÃ i Ä‘áº·t má»›i CSF.

TÃ³m láº¡i, tÃ­nh nÄƒng há»§y cÃ i Ä‘áº·t CSF trong WPTangToc OLS giÃºp báº¡n gá»¡ bá» CSF má»™t cÃ¡ch tÆ°Æ¡ng Ä‘á»‘i dá»… dÃ ng vÃ  sáº¡ch sáº½. Tuy nhiÃªn, Ä‘Ã¢y lÃ  má»™t hÃ nh Ä‘á»™ng cáº§n cÃ¢n nháº¯c ká»¹ lÆ°á»¡ng vá» máº·t an ninh.
}


echo "========================================================================="
echo "|Quáº£n lÃ½ báº£o máº­t => CSF => Há»§y CÃ i Äáº·t                                  |"
echo "========================================================================="

if [[ -f /etc/csf/csf.conf ]];then

echo "Huá»· cÃ i Ä‘áº·t CSF : $(date '+%d-%m-%Y %H:%M')" >> /var/log/wptangtoc-ols.log
systemctl stop csf
systemctl stop lfd
systemctl disable csf
systemctl stop lfd
. /etc/csf/uninstall.sh
yum install remove perl-libwww-perl.noarch perl-Time-HiRes -y
rm -rf /etc/csf
systemctl unmask firewalld
systemctl start firewalld
systemctl enable firewalld
firewall-cmd --zone=public --add-service=http --add-service=https --permanent
firewall-cmd --zone=public --add-port=443/udp --permanent
port_ssh=$(cat /etc/ssh/sshd_config | grep "Port " | grep -o '[0-9]\+$'|| echo 22)

firewall-cmd --zone=public --add-port=${port_ssh}/tcp --permanent

path_webgui="/usr/local/lsws/conf/disablewebconsole"
if [[ ! -f $path_webgui ]]; then
port_webgui_openlitespeed=$(cat /usr/local/lsws/admin/conf/admin_config.conf | grep "address" | grep -o '[0-9]\+$')
firewall-cmd --zone=public --add-port=${port_webgui_openlitespeed}/tcp --permanent
fi



#remote mariadb
if $(cat /etc/*release | grep -q "Ubuntu") ; then
	duong_dan_cau_hinh_mariadb="/etc/mysql/my.cnf"
else
	duong_dan_cau_hinh_mariadb="/etc/my.cnf.d/server.cnf"
fi

port_mariadb_remote=$(cat $duong_dan_cau_hinh_mariadb | grep 'port='| grep -o '[0-9]\+$')
if [[ $port_mariadb_remote ]];then
firewall-cmd --zone=public --add-port=${port_mariadb_remote}/tcp --permanent
fi


firewall-cmd --reload >/dev/null 2>&1

#tuong thich csf iptable vá»›i fail2ban
# sed -i 's/action = iptables-multiport\[name=wordpress, port="http,https", protocol=tcp\]/action = firewallcmd-allports/g' /etc/fail2ban/jail.local
# sed -i "s/banaction = iptables-multiport/banaction = firewallcmd-multiport/g" /etc/fail2ban/jail.local
# sed -i 's/banaction_allports = iptables-allports/banaction_allports = firewallcmd-allports/g' /etc/fail2ban/jail.local


sed -i '/%(action_)s/!s/^action = .*/action = firewallcmd-allports/'  /etc/fail2ban/jail.local
sed -i '/%(banaction_allports)s/!s/^banaction = .*/banaction = firewallcmd-allports/'  /etc/fail2ban/jail.local
sed -i "s/^banaction_allports = .*/banaction_allports = firewallcmd-allports/" /etc/fail2ban/jail.local


systemctl restart fail2ban

fail2ban-client reload >/dev/null 2>&1


echo "HoÃ n táº¥t XÃ³a cÃ i Ä‘áº·t CSF vÃ  Ä‘á»“ng thá»i báº­t láº¡i firewalld"
else
echo "Báº¡n chÆ°a Ä‘Ã£ cÃ i Ä‘áº·t CSF"
fi

check_menu_wptangtoc_active=$1
if [[ $check_menu_wptangtoc_active = "98" ]];then
. /etc/wptt/bao-mat/csf-main 1
fi

