#!/bin/bash

function huong_dan(){
TÃ­nh nÄƒng Thiáº¿t láº­p cháº·n háº¿t quá»‘c gia ngoáº¡i trá»« quá»‘c gia cá»¥ thá»ƒ Ä‘Æ°á»£c phÃ©p CSF trong WPTangToc OLS lÃ  má»™t cáº¥u hÃ¬nh báº£o máº­t ráº¥t nghiÃªm ngáº·t cá»§a tÆ°á»ng lá»­a ConfigServer Security & Firewall [CSF]. Thay vÃ¬ liá»‡t kÃª cÃ¡c quá»‘c gia bá»‹ cáº¥m, báº¡n sáº½ chá»‰ Ä‘á»‹nh má»™t danh sÃ¡ch cÃ¡c quá»‘c gia DUY NHáº¤T Ä‘Æ°á»£c phÃ©p truy cáº­p vÃ o mÃ¡y chá»§ cá»§a mÃ¬nh; táº¥t cáº£ cÃ¡c quá»‘c gia khÃ¡c sáº½ tá»± Ä‘á»™ng bá»‹ cháº·n.

ðŸŒ CÆ¡ cháº¿ hoáº¡t Ä‘á»™ng
CSF sáº½ chá»‰ cháº¥p nháº­n káº¿t ná»‘i tá»« cÃ¡c Ä‘á»‹a chá»‰ IP thuá»™c nhá»¯ng quá»‘c gia nÃ y vÃ  tá»« chá»‘i táº¥t cáº£ káº¿t ná»‘i tá»« cÃ¡c quá»‘c gia cÃ²n láº¡i.

ðŸŽ¯ Má»¥c Ä‘Ã­ch cá»§a viá»‡c Ã¡p dá»¥ng chÃ­nh sÃ¡ch chá»‰ cho phÃ©p
 * Báº£o máº­t Tá»‘i Ä‘a cho Äá»‘i tÆ°á»£ng Má»¥c tiÃªu Háº¹p: Ráº¥t lÃ½ tÆ°á»Ÿng náº¿u website hoáº·c dá»‹ch vá»¥ cá»§a báº¡n chá»‰ phá»¥c vá»¥ ngÆ°á»i dÃ¹ng á»Ÿ má»™t sá»‘ Ã­t quá»‘c gia cá»¥ thá»ƒ. Äiá»u nÃ y giáº£m thiá»ƒu Ä‘Ã¡ng ká»ƒ bá» máº·t táº¥n cÃ´ng tá»« cÃ¡c khu vá»±c khÃ´ng liÃªn quan.
 * Kiá»ƒm soÃ¡t Äá»‹a lÃ½ NghiÃªm ngáº·t: Äáº£m báº£o ráº±ng chá»‰ ngÆ°á»i dÃ¹ng tá»« cÃ¡c vÃ¹ng Ä‘á»‹a lÃ½ Ä‘Æ°á»£c á»§y quyá»n má»›i cÃ³ thá»ƒ truy cáº­p dá»‹ch vá»¥.
 * Giáº£m thiá»ƒu Tá»‘i Ä‘a LÆ°u lÆ°á»£ng RÃ¡c: Cháº·n Ä‘á»©ng pháº§n lá»›n lÆ°u lÆ°á»£ng truy cáº­p khÃ´ng mong muá»‘n, spam, bot tá»« cÃ¡c quá»‘c gia khÃ´ng náº±m trong danh sÃ¡ch cho phÃ©p.
 * ÄÆ¡n giáº£n hÃ³a khi Danh sÃ¡ch Cho phÃ©p Ngáº¯n: Náº¿u sá»‘ lÆ°á»£ng quá»‘c gia báº¡n muá»‘n cho phÃ©p Ã­t, viá»‡c quáº£n lÃ½ danh sÃ¡ch nÃ y cÃ³ thá»ƒ dá»… hÆ¡n lÃ  duy trÃ¬ má»™t danh sÃ¡ch dÃ i cÃ¡c quá»‘c gia bá»‹ cáº¥m.

Ghi chÃº: TÃ­nh nÄƒng nÃ y luÃ´n bypass nhá»¯ng ip cá»§a google, cloudflare, bing sáº½ khÃ´ng bao giá» bá»‹ cháº·n

TÃ­nh nÄƒng nÃ y cung cáº¥p má»©c Ä‘á»™ kiá»ƒm soÃ¡t truy cáº­p Ä‘á»‹a lÃ½ cao nháº¥t nhÆ°ng Ä‘Ã²i há»i sá»± hiá»ƒu biáº¿t vÃ  cáº©n trá»ng tá»‘i Ä‘a khi cáº¥u hÃ¬nh Ä‘á»ƒ trÃ¡nh lÃ m giÃ¡n Ä‘oáº¡n cÃ¡c truy cáº­p há»£p lá»‡ vÃ  cáº§n thiáº¿t.
}


echo "========================================================================="
echo "|Quáº£n lÃ½ báº£o máº­t => CSF => Chá»‰ cho Quá»‘c gia truy cáº­p                    |"
echo "========================================================================="

. /etc/wptt/echo-color
if [ ! -f /etc/csf/csf.conf ]; then
	echoDo "Báº¡n chÆ°a cÃ i Ä‘áº·t CSF"
	. /etc/wptt/bao-mat/csf-main 1
fi

countryblicklist=`grep "CC_ALLOW_FILTER =\ " /etc/csf/csf.conf | awk 'NR==1 {print $3}' | cut -d \" -f 2`
if [ "$countryblicklist" = "" ]; then
echo "========================================================================="
echo "Hien tai CSF Firewall khong block dat nuoc chÆ°a Ä‘Æ°á»£c thiáº¿t láº­p. "
echo "-------------------------------------------------------------------------"
fi

echo "Sá»­ dá»¥ng chá»©c nÄƒng nÃ y Ä‘á»ƒ block má»™t sá»‘ quá»‘c gia Ä‘Æ°á»£c truy cáº­p website trÃªn server."
echo "-------------------------------------------------------------------------" 
echo "Báº¡n cáº§n nháº­p mÃ£ quá»‘c gia gá»“m 2 chá»¯ cÃ¡i. Báº¡n cÃ³ thá»ƒ nháº­p nhiá»u Ä‘áº¥t nÆ°á»›c báº±ng cÃ¡ch"
echo "-------------------------------------------------------------------------" 
echo "cÃ¡ch sá»­ dá»¥ng dÃ¢u pháº£y [,] vÃ  khÃ´ng cÃ³ dáº¥u cÃ¡ch [space] giá»¯a cÃ¡c mÃ£ nÆ°á»›c. VD: PK,CN,RU,DE "
echo "-------------------------------------------------------------------------" 
echo "Äá»ƒ cháº·n quá»‘c gia Pakistan,China,Russia,Germany."
echo "-------------------------------------------------------------------------" 
echo "========================================================================="
read -p "Nháº­p mÃ£ nÆ°á»›c [0 = ThoÃ¡t] [99 = Xem mÃ£ quá»‘c gia]: " countrycode

if [[ $countrycode = '99' ]];then
cat /etc/wptt/bao-mat/csf/quoc-gia-ma-code-csf |sed 's/|$//g' | sed 's/|/==> /g'
echo -n "Nháº­p mÃ£ nÆ°á»›c [0 = ThoÃ¡t]: " 
read countrycode
fi


if [[ $countrycode = '' || $countrycode = '0' ]];then
. /etc/wptt/bao-mat/csf-main 1
fi

rm -f /tmp/wptangtoc_tmp_check_quoc_gia_block
rm -f /tmp/wptangtoc_ols_code_code_trung_nhau
rm -f /tmp/wptangtoc_ols_code_code_trung_nhau2
rm -f /tmp/wptangtoc_list_show_quoc_gia
rm -f /tmp/wptangtoc_ols_code_list_for


countrycode=$(echo $countrycode | tr '[a-z]' '[A-Z]')
countrycode=$(echo $countrycode | sed 's/\///' | sed 's/\///' | sed 's/\///')
echo "$countrycode" > /tmp/wptangtoc_tmp_check_quoc_gia_block
sed -i 's/,$//' /tmp/wptangtoc_tmp_check_quoc_gia_block

cat /tmp/wptangtoc_tmp_check_quoc_gia_block | awk -F, '{for (i=1;i<=NF;i++)print $i}' > /tmp/wptangtoc_ols_code_list_for

country_list=$(cat /tmp/wptangtoc_ols_code_list_for)

for manuoc in $country_list; do
 if [ ! ${#manuoc}  == "2" ]; then 
clear
echo "========================================================================= "
echo "Ma nuoc $manuoc khong ton tai."
echo "-------------------------------------------------------------------------"
echo "Ban hay nhap lai !"
. /etc/wptt/bao-mat/csf-main 1
exit
fi


if [ "$(grep "|${manuoc}|" /etc/wptt/bao-mat/csf/quoc-gia-ma-code-csf)" = "" ]; then
clear
echo "========================================================================= "
echo "Ma nuoc $manuoc khong ton tai."
echo "-------------------------------------------------------------------------"
echo "Ban hay nhap lai !"
. /etc/wptt/bao-mat/csf-main 1
exit
else
echo "$(grep "|${manuoc}|" /etc/wptt/bao-mat/csf/quoc-gia-ma-code-csf | sed "s/|${manuoc}|//")" >> /tmp/wptangtoc_list_show_quoc_gia
fi

echo "${manuoc}" >> /tmp/wptangtoc_ols_code_code_trung_nhau
grep "${manuoc}" /tmp/wptangtoc_ols_code_code_trung_nhau > /tmp/wptangtoc_ols_code_code_trung_nhau2
codetrungnhau=`cat /tmp/wptangtoc_ols_code_code_trung_nhau2`
if [ ! ${#codetrungnhau} = "2" ]; then 
clear
echo "========================================================================= "
echo "Ma nuoc $manuoc xuat hien nhieu hon 1 lan trong danh sach ban nhap."
echo "-------------------------------------------------------------------------"
echo "Ban hay nhap lai !"
. /etc/wptt/bao-mat/csf-main 1
exit
fi

done

sonuoc=`cat /tmp/wptangtoc_list_show_quoc_gia | wc -l`
if [ ! "$sonuoc" = 1 ]; then
nuoc=countries
hoithoai1=`echo "Danh sach cac nuoc Ä‘Æ°á»£c phÃ©p truy cáº­p bá»Ÿi CSF Firewall:"`
hoithoai2=`echo "Ban muon block toÃ n bá»™ cÃ¡c nÆ°á»›c chá»‰ cho phÃ©p $sonuoc nuoc trong danh sach ?"`
else
nuoc=country
hoithoai1=`echo "Báº¡n muá»‘n cháº·n táº¥t cáº£ cÃ¡c nÆ°á»›c chá»‰ cho phÃ©p quá»‘c gia nÃ y truy cáº­p bá»Ÿi CSF Firewall:"`
hoithoai2=`echo "Báº¡n muá»‘n cháº·nt táº¥t cáº£ cÃ¡c quá»‘c gia ngoáº¡i trá»« quá»‘c gia nÃ y?"`
fi
echo "========================================================================="
echo "$hoithoai1"
echo "-------------------------------------------------------------------------"
cat /tmp/wptangtoc_list_show_quoc_gia | pr -2 -t
echo "========================================================================="
echo "$hoithoai2 ?"
prompt="Nháº­p lá»±a chá»n cá»§a báº¡n [1-2]: "
dongy="n"
options=("Äá»“ng Ã½" "KhÃ´ng Ä‘á»“ng Ã½")
PS3="$prompt"
select opt in "${options[@]}"; do
	case "$REPLY" in
		1)
			dongy="y"
			break
			;;

		2)
			dongy="n"
			break
			;;

		$((${#options[@]} + 1)))
			printf "\nBáº¡n nháº­p sai há»‡ thá»‘ng sáº½ chá»n lÃ  khÃ´ng Ä‘á»“ng Ã½\n"
			break
			;;
		*)
			printf "Báº¡n nháº­p sai há»‡ thá»‘ng sáº½ chá»n lÃ  khÃ´ng Ä‘á»“ng Ã½\n"
			break
			;;
	esac
done

if [[ $dongy = 'y' ]];then
_runing "Cháº·n toÃ n bá»™ quá»‘c giÃ¡ chá»‰ cho phÃ©p cÃ¡c quá»‘c gia truy cáº­p: $(cat /tmp/wptangtoc_tmp_check_quoc_gia_block)"
sed -i 's/,$//' /tmp/wptangtoc_tmp_check_quoc_gia_block
sed -i "s/.*CC_ALLOW_FILTER\ =.*/CC_ALLOW_FILTER = \"$(cat /tmp/wptangtoc_tmp_check_quoc_gia_block)\"/g" /etc/csf/csf.conf
_rundone "Cháº·n toÃ n bá»™ quá»‘c giÃ¡ chá»‰ cho phÃ©p cÃ¡c quá»‘c gia truy cáº­p: $(cat /tmp/wptangtoc_tmp_check_quoc_gia_block)"
rm -f /tmp/wptangtoc_tmp_check_quoc_gia_block
rm -f /tmp/wptangtoc_ols_code_code_trung_nhau
rm -f /tmp/wptangtoc_ols_code_code_trung_nhau2
rm -f /tmp/wptangtoc_list_show_quoc_gia
rm -f /tmp/wptangtoc_ols_code_list_for

#bypass qua ly cloudflare
for i in `curl https://www.cloudflare.com/ips-v4`; do csf -a $i; done


if [[ $(which jq) = '' ]];then
	yum install jq -y
fi

#bypass qua ip google bot update má»›i nháº¥t
for i in `curl -s https://developers.google.com/static/search/apis/ipranges/googlebot.json | jq '.prefixes| .[]|.ipv4Prefix' | sed '/null/d'| sed '/^$/d'| sed 's/"//g'`; do csf -a $i; done

#bypass qua ip bing bot má»›i nháº¥t
for i in `curl -s https://www.bing.com/toolbox/bingbot.json | jq '.prefixes| .[]|.ipv4Prefix' | sed '/null/d' | sed '/^$/d'| sed 's/"//g'`; do csf -a $i; done


#bypass gmail smtp 
csf -a 74.125.0.0/16


csf -x >/dev/null 2>&1
csf -e >/dev/null 2>&1
systemctl restart csf
systemctl restart lfd


fi




check_menu_wptangtoc_active=$1
if [[ $check_menu_wptangtoc_active = "98" ]];then
. /etc/wptt/bao-mat/csf-main 1
fi

