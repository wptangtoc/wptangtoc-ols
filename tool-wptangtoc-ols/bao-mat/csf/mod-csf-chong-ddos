#!/bin/bash

function huong_dan(){
TÃ­nh nÄƒng CÃ i Ä‘áº·t chá»‘ng DDoS CSF trong WPTangToc OLS lÃ  bÆ°á»›c tiáº¿p theo sau khi báº¡n Ä‘Ã£ cÃ i Ä‘áº·t tÆ°á»ng lá»­a CSF. NÃ³ táº­p trung vÃ o viá»‡c tinh chá»‰nh vÃ  kÃ­ch hoáº¡t cÃ¡c cáº¥u hÃ¬nh chuyÃªn biá»‡t bÃªn trong CSF Ä‘á»ƒ giÃºp mÃ¡y chá»§ cá»§a báº¡n phÃ²ng chá»‘ng cÃ¡c cuá»™c táº¥n cÃ´ng tá»« chá»‘i dá»‹ch vá»¥ phÃ¢n tÃ¡n [DDoS] á»Ÿ má»©c Ä‘á»™ cÆ¡ báº£n Ä‘áº¿n trung bÃ¬nh.

ðŸ›¡ï¸ CSF vÃ  kháº£ nÄƒng chá»‘ng DDoS
Báº£n thÃ¢n ConfigServer Security & Firewall [CSF] Ä‘Ã£ tÃ­ch há»£p sáºµn nhiá»u cÆ¡ cháº¿ Ä‘á»ƒ giáº£m thiá»ƒu tÃ¡c Ä‘á»™ng cá»§a cÃ¡c cuá»™c táº¥n cÃ´ng DDoS nhá» vÃ  vá»«a, vÃ­ dá»¥:

SYN Flood Protection: Báº£o vá»‡ chá»‘ng láº¡i táº¥n cÃ´ng SYN flood.
Connection Limiting: Giá»›i háº¡n sá»‘ lÆ°á»£ng káº¿t ná»‘i Ä‘á»“ng thá»i tá»« má»™t Ä‘á»‹a chá»‰ IP Ä‘áº¿n cÃ¡c cá»•ng dá»‹ch vá»¥.
Port Flood Protection: Chá»‘ng láº¡i viá»‡c má»™t IP cá»‘ gáº¯ng má»Ÿ quÃ¡ nhiá»u káº¿t ná»‘i Ä‘áº¿n má»™t cá»•ng cá»¥ thá»ƒ.
Packet Filtering: Lá»c cÃ¡c gÃ³i tin Ä‘Ã¡ng ngá»

âœ¨ Lá»£i Ã­ch
Tiáº¿t kiá»‡m thá»i gian vÃ  cÃ´ng sá»©c: KhÃ´ng cáº§n pháº£i nghiÃªn cá»©u sÃ¢u vá» tá»«ng tÃ¹y chá»n cá»§a CSF.
Giáº£m thiá»ƒu rá»§i ro cáº¥u hÃ¬nh sai: Script Ã¡p dá»¥ng cÃ¡c thiáº¿t láº­p Ä‘Ã£ Ä‘Æ°á»£c kiá»ƒm nghiá»‡m hoáº·c khuyáº¿n nghá»‹.
NÃ¢ng cao kháº£ nÄƒng phÃ²ng thá»§ cÆ¡ báº£n: GiÃºp mÃ¡y chá»§ cá»©ng cÃ¡p hÆ¡n trÆ°á»›c cÃ¡c hÃ¬nh thá»©c táº¥n cÃ´ng DDoS phá»• biáº¿n.
LÆ°u Ã½ quan trá»ng: TÃ­nh nÄƒng nÃ y giÃºp cáº¥u hÃ¬nh cÃ¡c biá»‡n phÃ¡p báº£o vá»‡ sáºµn cÃ³ trong CSF. Äá»‘i vá»›i cÃ¡c cuá»™c táº¥n cÃ´ng DDoS quy mÃ´ lá»›n vÃ  phá»©c táº¡p, báº¡n váº«n cáº§n cÃ¡c giáº£i phÃ¡p chá»‘ng DDoS chuyÃªn nghiá»‡p hÆ¡n hoáº·c tá»« nhÃ  cung cáº¥p dá»‹ch vá»¥.

TÃ³m láº¡i, tÃ­nh nÄƒng CÃ i Ä‘áº·t chá»‘ng DDoS CSF trong WPTangToc OLS giÃºp báº¡n dá»… dÃ ng kÃ­ch hoáº¡t vÃ  tá»‘i Æ°u hÃ³a cÃ¡c lá»›p phÃ²ng thá»§ tÃ­ch há»£p sáºµn trong tÆ°á»ng lá»­a CSF Ä‘á»ƒ Ä‘á»‘i phÃ³ hiá»‡u quáº£ hÆ¡n vá»›i cÃ¡c má»‘i Ä‘e dá»a DDoS á»Ÿ má»©c Ä‘á»™ nháº¥t Ä‘á»‹nh.
}


echo "========================================================================="
echo "|Quáº£n lÃ½ báº£o máº­t => CSF => Chá»‘ng DDOS cháº¿ Ä‘á»™                            |"
echo "========================================================================="
. /etc/wptt/echo-color
if [ ! -f /etc/csf/csf.conf ]; then
	echoDo "Báº¡n chÆ°a cÃ i Ä‘áº·t CSF"
	echoDo "Náº¿u báº¡n muá»‘n sá»­ dá»¥ng tÃ­nh nÄƒng nÃ y vui lÃ²ng cÃ i Ä‘áº·t CSF trÆ°á»›c"
	. /etc/wptt/bao-mat/csf-main 1
fi

_runing "Thiáº¿t láº­p chá»‘ng ddos báº±ng CSF"

# support ping flood attack
# support syn flood
# support udp flood
# suport http flood

#CT_LIMIT cÃ³ thá»ƒ giáº£m xuá»‘ng tháº¥p hÆ¡n vá» cÆ¡ báº£n khÃ´ng nÃªn dÆ°á»›i 100
sed -i "/^CT_LIMIT/s/\"[^\"]*\"/\"150\"/1" /etc/csf/csf.conf
sed -i "/^CT_EMAIL_ALERT/s/\"[^\"]*\"/\"0\"/1" /etc/csf/csf.conf

#port 80 vÃ  443 má»›i cáº§n limit mÃ  thÃ´i
sed -i "/^CT_PORTS/s/\"[^\"]*\"/\"80,443\"/1" /etc/csf/csf.conf


#set thá»i gian cháº·n bá»‹ block náº¿u vi pháº¡m CT LIMIT lÃ  2 tiáº¿ng
sed -i "/^CT_BLOCK_TIME/s/\"[^\"]*\"/\"7200\"/1" /etc/csf/csf.conf


sed -i "/^SYNFLOOD/s/\"[^\"]*\"/\"1\"/1" /etc/csf/csf.conf

#chong UDPFLOOD
sed -i "/^UDPFLOOD /s/\"[^\"]*\"/\"1\"/1" /etc/csf/csf.conf
sed -i "/^UDPFLOOD_LIMIT/s/\"[^\"]*\"/\"25\/s\"/1" /etc/csf/csf.conf
sed -i "/^UDPFLOOD_BURST/s/\"[^\"]*\"/\"50\"/1" /etc/csf/csf.conf


#giá»›i háº¡n sá»‘ lÆ°á»£ng ip cá»§a thá»ƒ bá»‹ block, náº¿u háº¿t nÃ³ sáº½ tá»± Ä‘á»™ng xoay vÃ²ng, ram cÃ ng nhiá»u thÃ¬ Ä‘áº©y con sá»‘ nÃ y cÃ ng cao

  CSFTOTALMEM=$(awk '/MemTotal/ {print $2}' /proc/meminfo)
  if [[ "$CSFTOTALMEM" -ge '65000001' ]]; then
	  sed -i 's/^DENY_IP_LIMIT = .*/DENY_IP_LIMIT = \"120000\"/' /etc/csf/csf.conf
	  sed -i 's/^DENY_TEMP_IP_LIMIT = .*/DENY_TEMP_IP_LIMIT = \"130000\"/' /etc/csf/csf.conf
  elif [[ "$CSFTOTALMEM" -gt '32500001' && "$CSFTOTALMEM" -le '65000000' ]]; then
	  sed -i 's/^DENY_IP_LIMIT = .*/DENY_IP_LIMIT = \"60000\"/' /etc/csf/csf.conf
	  sed -i 's/^DENY_TEMP_IP_LIMIT = .*/DENY_TEMP_IP_LIMIT = \"80000\"/' /etc/csf/csf.conf
  elif [[ "$CSFTOTALMEM" -gt '16250001' && "$CSFTOTALMEM" -le '32500000' ]]; then
	  sed -i 's/^DENY_IP_LIMIT = .*/DENY_IP_LIMIT = \"30000\"/' /etc/csf/csf.conf
	  sed -i 's/^DENY_TEMP_IP_LIMIT = .*/DENY_TEMP_IP_LIMIT = \"45000\"/' /etc/csf/csf.conf
  elif [[ "$CSFTOTALMEM" -gt '8125001' && "$CSFTOTALMEM" -le '16250000' ]]; then
	  sed -i 's/^DENY_IP_LIMIT = .*/DENY_IP_LIMIT = \"16000\"/' /etc/csf/csf.conf
	  sed -i 's/^DENY_TEMP_IP_LIMIT = .*/DENY_TEMP_IP_LIMIT = \"20000\"/' /etc/csf/csf.conf
  elif [[ "$CSFTOTALMEM" -gt '4062501' && "$CSFTOTALMEM" -le '8125000' ]]; then
	  sed -i 's/^DENY_IP_LIMIT = .*/DENY_IP_LIMIT = \"6000\"/' /etc/csf/csf.conf
	  sed -i 's/^DENY_TEMP_IP_LIMIT = .*/DENY_TEMP_IP_LIMIT = \"8000\"/' /etc/csf/csf.conf
  elif [[ "$CSFTOTALMEM" -gt '2045001' && "$CSFTOTALMEM" -le '4062500' ]]; then
	  sed -i 's/^DENY_IP_LIMIT = .*/DENY_IP_LIMIT = \"4000\"/' /etc/csf/csf.conf
	  sed -i 's/^DENY_TEMP_IP_LIMIT = .*/DENY_TEMP_IP_LIMIT = \"5000\"/' /etc/csf/csf.conf
  elif [[ "$CSFTOTALMEM" -gt '1022501' && "$CSFTOTALMEM" -le '2045000' ]]; then
	  sed -i 's/^DENY_IP_LIMIT = .*/DENY_IP_LIMIT = \"1500\"/' /etc/csf/csf.conf
	  sed -i 's/^DENY_TEMP_IP_LIMIT = .*/DENY_TEMP_IP_LIMIT = \"3000\"/' /etc/csf/csf.conf
  elif [[ "$CSFTOTALMEM" -le '1022500' ]]; then
	  sed -i 's/^DENY_IP_LIMIT = .*/DENY_IP_LIMIT = \"1000\"/' /etc/csf/csf.conf
	  sed -i 's/^DENY_TEMP_IP_LIMIT = .*/DENY_TEMP_IP_LIMIT = \"2000\"/' /etc/csf/csf.conf
  fi

#sed -i "/^DENY_IP_LIMIT/s/\"[^\"]*\"/\"1000\"/1" /etc/csf/csf.conf



#cá»•ng 80 vÆ°á»£t quÃ¡ 100 trong (5) giÃ¢y , táº¥t cáº£ cÃ¡c káº¿t ná»‘i má»›i sáº½ bá»‹ cháº·n.
#cá»•ng 443 vÆ°á»£t quÃ¡ 100 trong (5) giÃ¢y , táº¥t cáº£ cÃ¡c káº¿t ná»‘i má»›i sáº½ bá»‹ cháº·n.

#sed -i "/^PORTFLOOD/s/\"[^\"]*\"/\"80;tcp;100;5,443;tcp;100;5\"/1" /etc/csf/csf.conf

#PORTFLOOD = 80;tcp;100;5,443;tcp;100;5


#CONNLIMIT lÃ  giá»›i háº¡n káº¿t ná»‘i cá»§a tá»« ip: port;sá»‘ lÆ°á»£ng káº¿t ná»‘i cá»§a ip
# config nÃ y lÃ  port 1 ip tá»‘i Ä‘a 20 káº¿t ná»‘i, port 443 1 ip tá»‘i Ä‘a 30 káº¿t ná»‘i
sed -i "/^CONNLIMIT /s/\"[^\"]*\"/\"80;20,443;30\"/1" /etc/csf/csf.conf


#smtp
if [[ $(cat /etc/csf/csf.conf | grep '^TCP_OUT' | grep "465,") = '' ]];then
	sed -i "s/^TCP_OUT = \"/TCP_OUT = \"465,/g" /etc/csf/csf.conf
	csf -x >/dev/null 2>&1
	csf -e >/dev/null 2>&1
fi


csf -x >/dev/null 2>&1
csf -e >/dev/null 2>&1
systemctl restart csf
systemctl restart lfd
_rundone "Thiáº¿t láº­p chá»‘ng ddos báº±ng CSF"

echo "Báº­t CSF chá»‘ng ddos : $(date '+%d-%m-%Y %H:%M')" >> /var/log/wptangtoc-ols.log

check_menu_wptangtoc_active=$1
if [[ $check_menu_wptangtoc_active = "98" ]];then
. /etc/wptt/bao-mat/csf-main 1
fi

