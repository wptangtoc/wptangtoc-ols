#!/bin/bash

function huong_dan(){
TÃ­nh nÄƒng Há»§y thiáº¿t láº­p cháº·n quá»‘c gia CSF trong WPTangToc OLS cho phÃ©p báº¡n gá»¡ bá» hoáº·c vÃ´ hiá»‡u hÃ³a cÃ¡c quy táº¯c cháº·n [hoáº·c chá»‰ cho phÃ©p] truy cáº­p tá»« cÃ¡c quá»‘c gia cá»¥ thá»ƒ Ä‘Ã£ Ä‘Æ°á»£c cáº¥u hÃ¬nh trÆ°á»›c Ä‘Ã³ trong tÆ°á»ng lá»­a ConfigServer Security & Firewall [CSF].

ðŸŽ¯ Má»¥c Ä‘Ã­ch cá»§a viá»‡c há»§y thiáº¿t láº­p cháº·n quá»‘c gia
 * Kháº¯c phá»¥c sá»± cá»‘ truy cáº­p: Náº¿u viá»‡c cháº·n quá»‘c gia Ä‘ang vÃ´ tÃ¬nh ngÄƒn cáº£n ngÆ°á»i dÃ¹ng há»£p lá»‡ hoáº·c cÃ¡c dá»‹ch vá»¥ cáº§n thiáº¿t truy cáº­p vÃ o mÃ¡y chá»§ cá»§a báº¡n.
 * Thay Ä‘á»•i chÃ­nh sÃ¡ch truy cáº­p: Khi báº¡n khÃ´ng cÃ²n muá»‘n giá»›i háº¡n truy cáº­p dá»±a trÃªn vá»‹ trÃ­ Ä‘á»‹a lÃ½ ná»¯a hoáº·c muá»‘n má»Ÿ rá»™ng pháº¡m vi truy cáº­p cho website/dá»‹ch vá»¥.
 * ÄÆ¡n giáº£n hÃ³a cáº¥u hÃ¬nh tÆ°á»ng lá»­a: Loáº¡i bá» cÃ¡c quy táº¯c cháº·n theo quá»‘c gia náº¿u chÃºng khÃ´ng cÃ²n cáº§n thiáº¿t hoáº·c Ä‘á»ƒ giáº£m Ä‘á»™ phá»©c táº¡p trong quáº£n lÃ½ CSF.
 * Thá»­ nghiá»‡m hoáº·c chuyá»ƒn Ä‘á»•i chiáº¿n lÆ°á»£c: Muá»‘n táº¡m thá»i vÃ´ hiá»‡u hÃ³a Ä‘á»ƒ kiá»ƒm tra hoáº·c thay Ä‘á»•i sang má»™t phÆ°Æ¡ng phÃ¡p kiá»ƒm soÃ¡t truy cáº­p khÃ¡c.

TÃ³m láº¡i, tÃ­nh nÄƒng Há»§y thiáº¿t láº­p cháº·n quá»‘c gia CSF trong WPTangToc OLS giÃºp báº¡n dá»… dÃ ng gá»¡ bá» cÃ¡c rÃ o cáº£n truy cáº­p dá»±a trÃªn vá»‹ trÃ­ Ä‘á»‹a lÃ½ Ä‘Ã£ Ä‘áº·t ra trÆ°á»›c Ä‘Ã³ trong CSF, cho phÃ©p mÃ¡y chá»§ cá»§a báº¡n nháº­n truy cáº­p tá»« má»i quá»‘c gia [trá»« khi cÃ³ cÃ¡c quy táº¯c cháº·n IP cá»¥ thá»ƒ khÃ¡c].
}


echo "========================================================================="
echo "|Quáº£n lÃ½ báº£o máº­t => CSF => Cháº·n Quá»‘c gia                               |"
echo "========================================================================="

. /etc/wptt/echo-color
if [ ! -f /etc/csf/csf.conf ]; then
	echoDo "Báº¡n chÆ°a cÃ i Ä‘áº·t CSF"
	. /etc/wptt/bao-mat/csf-main 1
fi

countryblicklist=`grep "CC_DENY =\ " /etc/csf/csf.conf | awk 'NR==1 {print $3}' | cut -d \" -f 2`
if [ "$countryblicklist" = "" ]; then
echo "========================================================================="
echo "Hiá»‡n táº¡i CSF Firewall khÃ´ng cháº·n quá»‘c gia nÃ o. "
echo "-------------------------------------------------------------------------"
fi

echo "Sá»­ dá»¥ng chá»©c nÄƒng nÃ y Ä‘á»ƒ block má»™t sá»‘ quá»‘c gia truy cáº­p website trÃªn server."
echo "-------------------------------------------------------------------------" 
echo "Báº¡n cáº§n nháº­p mÃ£ quá»‘c gia gá»“m 2 chá»¯ cÃ¡i. Báº¡n cÃ³ thá»ƒ nháº­p nhiá»u Ä‘áº¥t nÆ°á»›c báº±ng cÃ¡ch"
echo "-------------------------------------------------------------------------" 
echo "cÃ¡ch sá»­ dá»¥ng dÃ¢u pháº£y [,] vÃ  khÃ´ng cÃ³ dáº¥u cÃ¡ch [space] giá»¯a cÃ¡c mÃ£ nÆ°á»›c. VD: PK,CN,RU,DE "
echo "-------------------------------------------------------------------------" 
echo "Äá»ƒ cháº·n quá»‘c gia Pakistan,China,Russia,Germany."
echo "-------------------------------------------------------------------------" 
echo "========================================================================="
read -p "Nháº­p mÃ£ nÆ°á»›c [0 = ThoÃ¡t] [99 = Xem mÃ£ quá»‘c gia]: " countrycode

if [[ $countrycode = '99' ]];then
cat /etc/wptt/bao-mat/csf/quoc-gia-ma-code-csf |sed 's/|$//g' | sed 's/|/==> /g'
echo -n "Nháº­p mÃ£ nÆ°á»›c [0 = ThoÃ¡t]: " 
read countrycode
fi


if [[ $countrycode = '' || $countrycode = '0' ]];then
. /etc/wptt/bao-mat/csf-main 1
fi

rm -f /tmp/wptangtoc_tmp_check_quoc_gia_block
rm -f /tmp/wptangtoc_ols_code_code_trung_nhau
rm -f /tmp/wptangtoc_ols_code_code_trung_nhau2
rm -f /tmp/wptangtoc_list_show_quoc_gia
rm -f /tmp/wptangtoc_ols_code_list_for


countrycode=$(echo $countrycode | tr '[a-z]' '[A-Z]')
countrycode=$(echo $countrycode | sed 's/\///' | sed 's/\///' | sed 's/\///')
echo "$countrycode" > /tmp/wptangtoc_tmp_check_quoc_gia_block
sed -i 's/,$//' /tmp/wptangtoc_tmp_check_quoc_gia_block

cat /tmp/wptangtoc_tmp_check_quoc_gia_block | awk -F, '{for (i=1;i<=NF;i++)print $i}' > /tmp/wptangtoc_ols_code_list_for

country_list=$(cat /tmp/wptangtoc_ols_code_list_for)

for manuoc in $country_list; do
 if [ ! ${#manuoc}  == "2" ]; then 
clear
echo "========================================================================= "
echo "Ma nuoc $manuoc khong ton tai."
echo "-------------------------------------------------------------------------"
echo "Ban hay nhap lai !"
. /etc/wptt/bao-mat/csf-main 1
exit
fi


if [ "$(grep "|${manuoc}|" /etc/wptt/bao-mat/csf/quoc-gia-ma-code-csf)" = "" ]; then
clear
echo "========================================================================= "
echo "Ma nuoc $manuoc khong ton tai."
echo "-------------------------------------------------------------------------"
echo "Ban hay nhap lai !"
. /etc/wptt/bao-mat/csf-main 1
exit
else
echo "$(grep "|${manuoc}|" /etc/wptt/bao-mat/csf/quoc-gia-ma-code-csf | sed "s/|${manuoc}|//")" >> /tmp/wptangtoc_list_show_quoc_gia
fi

echo "${manuoc}" >> /tmp/wptangtoc_ols_code_code_trung_nhau
grep "${manuoc}" /tmp/wptangtoc_ols_code_code_trung_nhau > /tmp/wptangtoc_ols_code_code_trung_nhau2
codetrungnhau=`cat /tmp/wptangtoc_ols_code_code_trung_nhau2`
if [ ! ${#codetrungnhau} = "2" ]; then 
clear
echo "========================================================================= "
echo "Ma nuoc $manuoc xuat hien nhieu hon 1 lan trong danh sach ban nhap."
echo "-------------------------------------------------------------------------"
echo "Ban hay nhap lai !"
. /etc/wptt/bao-mat/csf-main 1
exit
fi

done

sonuoc=`cat /tmp/wptangtoc_list_show_quoc_gia | wc -l`
if [ ! "$sonuoc" = 1 ]; then
nuoc=countries
hoithoai1=`echo "Danh sach cac nuoc ban muon block boi CSF Firewall:"`
hoithoai2=`echo "Ban muon block $sonuoc nuoc trong danh sach ?"`
else
nuoc=country
hoithoai1=`echo "Nuoc ban muon block boi CSF Firewall:"`
hoithoai2=`echo "Ban muon block dat nuoc nay ?"`
fi
echo "========================================================================="
echo "$hoithoai1"
echo "-------------------------------------------------------------------------"
cat /tmp/wptangtoc_list_show_quoc_gia | pr -2 -t
echo "========================================================================="
echo "$hoithoai2 ?"
prompt="Nháº­p lá»±a chá»n cá»§a báº¡n [1-2]: "
dongy="n"
options=("Äá»“ng Ã½" "KhÃ´ng Ä‘á»“ng Ã½")
PS3="$prompt"
select opt in "${options[@]}"; do
	case "$REPLY" in
		1)
			dongy="y"
			break
			;;

		2)
			dongy="n"
			break
			;;

		$((${#options[@]} + 1)))
			printf "\nBáº¡n nháº­p sai há»‡ thá»‘ng sáº½ chá»n lÃ  khÃ´ng Ä‘á»“ng Ã½\n"
			break
			;;
		*)
			printf "Báº¡n nháº­p sai há»‡ thá»‘ng sáº½ chá»n lÃ  khÃ´ng Ä‘á»“ng Ã½\n"
			break
			;;
	esac
done

if [[ $dongy = 'y' ]];then
_runing "Cháº·n cÃ¡c quá»‘c gia truy cáº­p: $(cat /tmp/wptangtoc_tmp_check_quoc_gia_block)"
sed -i 's/,$//' /tmp/wptangtoc_tmp_check_quoc_gia_block
sed -i "s/.*CC_DENY\ =.*/CC_DENY = \"$(cat /tmp/wptangtoc_tmp_check_quoc_gia_block)\"/g" /etc/csf/csf.conf
_rundone "HoÃ n táº¥t cháº·n cÃ¡c quá»‘c gia truy cáº­p: $(cat /tmp/wptangtoc_tmp_check_quoc_gia_block)"
rm -f /tmp/wptangtoc_tmp_check_quoc_gia_block
rm -f /tmp/wptangtoc_ols_code_code_trung_nhau
rm -f /tmp/wptangtoc_ols_code_code_trung_nhau2
rm -f /tmp/wptangtoc_list_show_quoc_gia
rm -f /tmp/wptangtoc_ols_code_list_for

csf -x >/dev/null 2>&1
csf -e >/dev/null 2>&1
systemctl restart csf
systemctl restart lfd
fi

check_menu_wptangtoc_active=$1
if [[ $check_menu_wptangtoc_active = "98" ]];then
. /etc/wptt/bao-mat/csf-main 1
fi

