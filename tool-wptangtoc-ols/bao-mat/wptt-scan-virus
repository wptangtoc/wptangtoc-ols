#!/bin/bash
# WPTangToc OLS - Malware Scanner (Gia Tuấn)

function huong_dan() {
  Quét virus ClamAV là một công cụ quét virus mã nguồn mở, miễn phí và rất phổ biến trên các hệ điều hành Linux. Tính năng chính của nó là giúp phát hiện và loại bỏ các phần mềm độc hại như virus, trojans, worms, và các mối đe dọa khác.

  Giới thiệu ngắn gọn về tính năng quét virus của ClamAV trên Linux:

  * Phát hiện đa dạng mã độc: ClamAV sử dụng một cơ sở dữ liệu chữ ký virus [virus signatures] được cập nhật thường xuyên để nhận diện hàng triệu loại phần mềm độc hại khác nhau.
  * Quét theo yêu cầu: Bạn có thể sử dụng lệnh clamscan từ dòng lệnh để quét các tệp tin, thư mục cụ thể hoặc toàn bộ hệ thống theo cách thủ công bất cứ khi nào bạn muốn.
  * Quét tự động [Daemon]: ClamAV cung cấp clamd, một tiến trình nền [daemon] có thể thực hiện quét theo thời gian thực [on-access scanning] đối với các tệp tin khi chúng được truy cập, hoặc tích hợp với các dịch vụ khác như máy chủ mail để quét email.
  * Cập nhật cơ sở dữ liệu tự động: Công cụ freshclam giúp tự động tải về các bản cập nhật chữ ký virus mới nhất, đảm bảo khả năng phát hiện các mối đe dọa mới.
  * Linh hoạt và tích hợp: ClamAV có thể được tích hợp vào các ứng dụng khác, ví dụ như máy chủ email [để quét tệp đính kèm] hoặc máy chủ tập tin [để quét các tệp được tải lên/tải xuống].
  * Miễn phí và mã nguồn mở: Là một giải pháp không tốn chi phí bản quyền và được cộng đồng phát triển, kiểm tra liên tục.
  Mặc dù Linux ít bị ảnh hưởng bởi virus truyền thống nhắm vào máy tính để bàn hơn Windows, ClamAV vẫn đóng vai trò quan trọng trong việc bảo vệ máy chủ Linux khỏi việc lưu trữ hoặc phát tán mã độc sang các hệ thống khác [ví dụ: trong vai trò máy chủ mail hoặc file server], cũng như phát hiện các rootkit hoặc mã độc nhắm vào chính Linux.
}

# --- DINH DANG MAU SAC ---
RED='\033[1;31m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
CYAN='\033[1;36m'
NC='\033[0m' # No Color

echo ""
echo "========================================================================="
echo "|Bảo mật => Scan quét virus website    	                              |"
echo "========================================================================="
echo ""

# ==================================================================
# PHAN 1: KIEM TRA HE DIEU HANH
# ==================================================================
if [ -f /etc/redhat-release ]; then
  OS_TYPE="rhel" # CentOS, AlmaLinux, Rocky
elif [ -f /etc/debian_version ]; then
  OS_TYPE="debian" # Ubuntu, Debian
else
  echo -e "${RED}Loi: He dieu hanh khong duoc ho tro!${NC}"
  exit 1
fi

# ==================================================================
# PHAN 2: CAI DAT & CAU HINH TU DONG
# ==================================================================
IS_INSTALLED=0
if [[ "$OS_TYPE" == "rhel" && -f "/etc/clamd.d/scan.conf" ]]; then IS_INSTALLED=1; fi
if [[ "$OS_TYPE" == "debian" && -f "/etc/clamav/clamd.conf" ]]; then IS_INSTALLED=1; fi

if [[ $IS_INSTALLED -eq 0 ]] || [[ ! -f "/usr/local/maldetect/conf.maldet" ]]; then
  echo -e "${YELLOW}Đang tiến hành cài đặt ClamAV va Maldetect...${NC}"

  # --- A. CAI DAT GOI ---
  if [[ "$OS_TYPE" == "rhel" ]]; then
    yum install epel-release -y -q
    yum install clamav-server clamav-update clamav-filesystem clamav clamav-scanner-systemd clamav-devel clamav-lib clamav-server-systemd pv -y -q

    # Cau hinh RHEL
    # setsebool -P antivirus_can_scan_system 1 2>/dev/null
    # setsebool -P clamd_use_jit 1 2>/dev/null

    CLAM_CONF="/etc/clamd.d/scan.conf"
    FRESH_CONF="/etc/freshclam.conf"

    # Fix config mac dinh
    if [[ -f "$CLAM_CONF" ]]; then
      sed -i 's/^Example/#Example/' "$CLAM_CONF"
      sed -i 's/#LocalSocket /LocalSocket /' "$CLAM_CONF"
    fi
    if [[ -f "$FRESH_CONF" ]]; then sed -i 's/^Example/#Example/' "$FRESH_CONF"; fi

  elif [[ "$OS_TYPE" == "debian" ]]; then
    apt-get update -y -q
    apt-get install clamav clamav-daemon libclamav-dev pv -y -q

    CLAM_CONF="/etc/clamav/clamd.conf"
    FRESH_CONF="/etc/clamav/freshclam.conf"

    # Stop service de tranh loi khoa DB khi update sau nay
    systemctl stop clamav-freshclam 2>/dev/null
  fi

  # --- B. THEM DATABASE CHUYEN DUNG (Malware Expert) ---
  if [[ -f "$FRESH_CONF" ]] && ! grep -q "malware.expert" "$FRESH_CONF"; then
    echo " -> Them Database Malware Expert..."
    {
      echo "DatabaseCustomURL http://cdn.malware.expert/malware.expert.ndb"
      echo "DatabaseCustomURL http://cdn.malware.expert/malware.expert.hdb"
      echo "DatabaseCustomURL http://cdn.malware.expert/malware.expert.ldb"
      echo "DatabaseCustomURL http://cdn.malware.expert/malware.expert.fp"
    } >>"$FRESH_CONF"
  fi

  # --- C. CAI DAT MALDET (Source) ---
  if [ ! -d "/usr/local/maldetect" ]; then
    echo " -> Đang cài đặt Maldet..."
    cd /usr/src
    wget -q http://www.rfxn.com/downloads/maldetect-current.tar.gz
    tar -xzf maldetect-current.tar.gz
    maldet_folder=$(ls | grep "maldetect-" | head -1)
    cd "$maldet_folder" && bash install.sh >/dev/null 2>&1
    cd /usr/src && rm -rf maldetect-current.tar.gz "$maldet_folder"
  fi

  # --- D. LIEN KET MALDET VA CLAMAV ---
  conf_maldet="/usr/local/maldetect/conf.maldet"
  if [[ -f "$conf_maldet" ]] && ! grep -q "clam_av=1" "$conf_maldet"; then
    sed -i 's/quar_hits=0/quar_hits=1/' "$conf_maldet"
    sed -i 's/quar_clean=0/quar_clean=1/' "$conf_maldet"
    sed -i 's/clam_av=0/clam_av=1/' "$conf_maldet"
    # Fix cho Ubuntu (user root)
    if [[ "$OS_TYPE" == "debian" ]]; then sed -i 's/scan_ignore_root=1/scan_ignore_root=0/' "$conf_maldet"; fi
  fi

  echo -e "${GREEN}Hoàn tất cài đặt ClamAV va Maldetect!${NC}"
  sleep 2
fi

# ==================================================================
# PHAN 3: LUA CHON WEBSITE
# ==================================================================
NAME=$1
if [[ $NAME = "98" ]]; then NAME=""; fi

# Neu khong truyen tham so, hien menu chon
if [[ "$NAME" = "" ]]; then
  if [[ -f "/etc/wptt/tenmien-them-lua-chon-tat-ca-website" ]]; then
    . /etc/wptt/tenmien-them-lua-chon-tat-ca-website
    echo ""
    echo "Lựa chọn website bạn muốn quét virus: "
    echo ""
    lua_chon_NAME
  else
    echo "Loi: Khong tim thay thu vien chon ten mien."
    exit 1
  fi
fi

# --- XU LY QUET "TAT CA WEBSITE" ---
if [[ $NAME = 'Tất cả website' ]]; then
  if [ "$(ls -A /etc/wptt/vhost | grep -v '^\.\.conf$' | sort -uV)" ]; then
    for entry in $(ls -A /etc/wptt/vhost | grep -v '^\.\.conf$' | sort -uV); do
      domain=$(echo $entry | sed 's/^.//' | sed 's/.conf//')
      path_html="/usr/local/lsws/$domain/html"
      if [ "$domain" != "${domain/./}" ] && [ "$domain" != '.' ]; then
        if [[ -d "$path_html" ]]; then
          # Goi lai chinh script nay mot cach de quy cho tung domain
          $0 $domain
        fi
      fi
    done
  fi

  # Quay ve menu chinh
  check_menu_wptangtoc_active=$1
  if [[ $check_menu_wptangtoc_active = "98" ]] && [[ -f "/etc/wptt/wptt-bao-mat-main" ]]; then
    . /etc/wptt/wptt-bao-mat-main 1
  fi
  exit
fi

# --- KIEM TRA INPUT HOP LE ---
if [[ "$NAME" = "0" || "$NAME" = "" ]]; then
  if [[ -f "/etc/wptt/wptt-bao-mat-main" ]]; then . /etc/wptt/wptt-bao-mat-main 1; fi
  exit
fi

pathcheck="/etc/wptt/vhost/.$NAME.conf"
if [[ ! -f "$pathcheck" ]]; then
  clear
  echo -e "${RED}Loi: Khong tim thay cau hinh cho website $NAME${NC}"
  if [[ -f "/etc/wptt/wptt-bao-mat-main" ]]; then . /etc/wptt/wptt-bao-mat-main 1; fi
  exit
fi

# ==================================================================
# PHAN 4: CAP NHAT DATABASE (SAFE UPDATE)
# ==================================================================
echo -e "${CYAN}Dang kiem tra va cap nhat co so du lieu Virus...${NC}"

# Stop service freshclam de tranh loi "Database Locked"
if [[ "$OS_TYPE" == "debian" ]]; then systemctl stop clamav-freshclam 2>/dev/null; fi
if [[ "$OS_TYPE" == "rhel" ]]; then systemctl stop clamav-freshclam 2>/dev/null; fi

# Update va giau output neu khong co loi
freshclam >/dev/null 2>&1

clear
echo "========================================================"
echo -e "ĐANG QUÉT VIRUS WEBSITE: ${GREEN}$NAME${NC}"
echo "Thư mục: /usr/local/lsws/$NAME/html"
echo "========================================================"

# ==================================================================
# PHAN 5: THUC THI QUET (UX + SAFE MODE)
# ==================================================================

# A. Tinh toan dung luong (Hien thi cho chuyen nghiep)
echo -n "Đang tính toán dữ liệu... "
DIR_SIZE=$(du -sh "/usr/local/lsws/$NAME/html" | cut -f1)
echo -e "Tổng dung lượng: ${YELLOW}$DIR_SIZE${NC}"

# B. Chuan bi file tam va ham Don dep (TRAP)
TEMP_OUT=$(mktemp)

cleanup_process() {
  echo -e "\n\n${RED}[!] Thấy tín hiệu dừng (Ctrl+C)...${NC}"
  # Giet tien trinh Maldet
  if [[ -n "$MALDET_PID" ]]; then
    kill -9 "$MALDET_PID" 2>/dev/null
    echo " -> Đã dừng tiến trình quét virus."
  fi
  rm -f "$TEMP_OUT"
  tput cnorm # Hien lai con tro chuot
  exit 1
}
# Bat tin hieu Ctrl+C (SIGINT) va Kill (SIGTERM)
trap cleanup_process SIGINT SIGTERM

# C. Chay Maldet ngam (Background)
echo "Đang khởi chạy Maldetect..."
maldet --scan-all "/usr/local/lsws/$NAME/html" >"$TEMP_OUT" 2>&1 &
MALDET_PID=$! # Luu PID

# D. Hien thi thanh tien trinh (PV Timer)
if command -v pv &>/dev/null; then
  # Vong lap gui tin hieu cho pv moi giay
  (while kill -0 $MALDET_PID 2>/dev/null; do
    sleep 1
    echo "x"
  done) | pv -t -N "Thời gian quét" -w 80 >/dev/null
else
  # Fallback neu khong co pv
  echo -n "Đang quét (Vui lòng đợi)..."
  while kill -0 $MALDET_PID 2>/dev/null; do
    echo -n "."
    sleep 2
  done
  echo ""
fi

# E. Tat Trap sau khi chay xong
trap - SIGINT SIGTERM

# F. Doc ket qua
scan_output=$(cat "$TEMP_OUT")
rm -f "$TEMP_OUT"

# Hien thi output raw (de user thay duoc thong tin chi tiet)
echo "$scan_output"

# ==================================================================
# PHAN 6: BAO CAO KET QUA
# ==================================================================
# Lay SCAN ID tu output
SCAN_ID=$(echo "$scan_output" | grep "scan ID" | awk '{print $3}')

echo "--------------------------------------------------------"
if [[ -n "$SCAN_ID" ]]; then
  echo -e "Hoàn tất Scan. SCAN ID: ${CYAN}$SCAN_ID${NC}"
else
  echo "Hoàn tất Scan."
fi

# Logic xac dinh ket qua
KETQUA=0
if [[ -z "$SCAN_ID" ]]; then
  # Fallback: Tim file moi tao trong quarantine (60 phut gan day)
  cachly=$(find /usr/local/maldetect/quarantine/ -type f -mmin -60)
  if [[ -n "$cachly" ]]; then KETQUA=1; fi
else
  # Check hits trong report chinh thuc
  hits=$(maldet --report "$SCAN_ID" | grep "hits:" | awk '{print $2}')
  if [[ "$hits" -gt 0 ]]; then KETQUA=1; fi
fi

if [[ "$KETQUA" -eq 0 ]]; then
  echo ""
  echo -e "${GREEN}[OK] Xác nhận hệ thống KHÔNG phát hiện virus trên website $NAME.${NC}"
  echo ""
else
  echo ""
  echo -e "${RED}[CẢNH BÁO] Phát hiện và cách ly mã độc!${NC}"
  echo "Danh sách các file bị nhiễm mã độc:"
  echo "----------------------------"
  if [[ -n "$SCAN_ID" ]]; then
    maldet --report "$SCAN_ID" | grep "FILE HIT"
  else
    ls -lh /usr/local/maldetect/quarantine/ | head -n 10
  fi
  echo "----------------------------"
  echo "Vui lòng kiểm tra thư mục: /usr/local/maldetect/quarantine"
fi

# Quay ve menu
check_menu_wptangtoc_active=$1
if [[ $check_menu_wptangtoc_active = "98" ]] && [[ -f "/etc/wptt/wptt-bao-mat-main" ]]; then
  . /etc/wptt/wptt-bao-mat-main 1
fi
