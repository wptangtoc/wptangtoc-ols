#!/bin/bash
export LC_ALL=en_US.UTF-8
export LANG=en_US.UTF-8
stty iutf8 #từ latin1 sang utf8, nhiều khi anh em dùng bộ gõ tiếng việt: dùng à â nó thêm \xc3 hay \xa9 ... tương thích với bộ gõ tiếng việt telex khi nhập domain

#update ghi đè
. /etc/wptt/.wptt.conf
if [[ $Website_chinh != 'wptangtoc-ols.com' ]]; then #chỉ hoạt động khi domain chính đang là wptangtoc ols
  return 2>/dev/null
  exit
fi

version_wptangtoc_ols=$(cat /tmp/wptangtoc-ols-version-main)
wptangtocols_version=$(curl -s https://wptangtoc.com/share/version-wptangtoc-ols.txt | head -1 | grep '\.')
if [[ $wptangtocols_version = "" ]]; then
  wptangtocols_version=$(curl -s https://raw.githubusercontent.com/wptangtoc/wptangtoc-ols/refs/heads/main/version-wptangtoc-ols.txt)
fi

if [[ "$wptangtocols_version" != "$version_wptangtoc_ols" ]]; then
  . /etc/wptt/wptt-update2
fi
clear
echo "-------------------------------------------------------------------------"
echo "Chào mừng bạn đến với WPTangToc OLS"
echo "-------------------------------------------------------------------------"
echo ""

RED='\033[1;31m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# 1. Hàm xử lý khi người dùng cố tình ấn Ctrl+C
function block_ctrl_c() {
  echo ""
  echo -e "${RED}[!] BẮT BUỘC: Bạn phải nhập tên miền để cấu hình hệ thống.${NC}"
  echo -e "${YELLOW}>> Không thể thoát bằng Ctrl+C. Vui lòng nhập domain hợp lệ.${NC}"
  # In lại dấu nhắc nhập liệu (tùy chọn, để thẩm mỹ)
  echo -ne "${GREEN}Nhập domain của bạn: ${NC}"
}

# 2. Kích hoạt bẫy tín hiệu (Trap)
trap block_ctrl_c SIGINT

# 3. Vòng lặp vĩnh cửu bắt nhập Domain
while true; do
  echo -ne "${GREEN}Nhập domain hoặc subdomain (ví dụ: wptangtoc.com): ${NC}"
  read NAME

  # --- Xử lý & Làm sạch dữ liệu đầu vào ---
  # Chuyển thành chữ thường
  NAME=$(echo "$NAME" | tr '[:upper:]' '[:lower:]')
  # Loại bỏ http:// hoặc https://
  NAME=$(echo "$NAME" | sed -E 's/^\s*.*:\/\///g')
  # Loại bỏ www. ở đầu
  NAME=$(echo "$NAME" | sed 's/^www\.//g')
  # Loại bỏ khoảng trắng thừa đầu đuôi
  NAME=$(echo "$NAME" | xargs)
  # Loại bỏ ký tự / cuối cùng nếu có
  NAME=${NAME%/}

  # --- Validate (Kiểm tra tính hợp lệ) ---

  # Check 1: Rỗng hoặc bằng 0
  if [[ -z "$NAME" ]] || [[ "$NAME" == "0" ]]; then
    echo -e "${RED}[Lỗi] Domain không được để trống. Vui lòng nhập lại.${NC}"
    continue # Quay lại đầu vòng lặp
  fi

  # Check 2: Không có dấu chấm (không phải domain)
  if [[ "$NAME" == "${NAME/./}" ]]; then
    echo -e "${RED}[Lỗi] Domain không đúng định dạng (thiếu dấu chấm). Ví dụ: wptangtoc.com${NC}"
    continue
  fi

  # Check 3: Có khoảng trắng ở giữa (VD: "wptangtoc com")
  if [[ "$NAME" =~ [[:space:]] ]]; then
    echo -e "${RED}[Lỗi] Domain không được chứa khoảng trắng.${NC}"
    continue
  fi

  # Check 4: Ký tự đặc biệt (chỉ cho phép chữ, số, dấu chấm, dấu gạch ngang)
  if [[ ! "$NAME" =~ ^[a-z0-9.-]+$ ]]; then
    echo -e "${RED}[Lỗi] Domain chứa ký tự không hợp lệ. Chỉ cho phép a-z, 0-9, dấu chấm và gạch ngang.${NC}"
    continue
  fi

  # Nếu vượt qua tất cả bài test -> Hợp lệ -> Thoát vòng lặp
  echo -e "${GREEN}>> Domain hợp lệ: $NAME${NC}"
  break
done

sed -i "/keyFile/d" /usr/local/lsws/conf/httpd_config.conf
sed -i "/certFile/d" /usr/local/lsws/conf/httpd_config.conf
sed -i "/CACertFile/d" /usr/local/lsws/conf/httpd_config.conf
sed -i "/https/a keyFile              \/etc\/wptt-ssl-tu-ky\/$NAME\/$NAME.key" /usr/local/lsws/conf/httpd_config.conf
sed -i "/https/a certFile             \/etc\/wptt-ssl-tu-ky\/$NAME\/cert.crt" /usr/local/lsws/conf/httpd_config.conf

sed -i "/Website_chinh/d" /etc/wptt/.wptt.conf
echo "Website_chinh=$NAME" >>/etc/wptt/.wptt.conf

sed -i -e '/^virtualhost wptangtoc-ols.com/,/^}$/d' /usr/local/lsws/conf/httpd_config.conf
sed -i "/wptangtoc-ols.com wptangtoc-ols.com/d" /usr/local/lsws/conf/httpd_config.conf

database_admin_password=$(
  date +%s | sha256sum | base64 | head -c 32
  echo
)

mariadb <<EOF
use mysql;
FLUSH PRIVILEGES;
CREATE USER 'wordpressadmin'@'localhost' IDENTIFIED BY '$database_admin_password';
GRANT ALL PRIVILEGES ON *.* TO 'wordpressadmin'@'localhost' WITH GRANT OPTION;
DROP USER 'root'@'localhost';
FLUSH PRIVILEGES;
EOF

sed -i '/database_admin_password/d' /etc/wptt/.wptt.conf
echo "database_admin_password=$database_admin_password" >>/etc/wptt/.wptt.conf

sed -i '/wptt-thay-domain-chinh-wptangtoc-ols-com/d' /root/.bashrc
# source /root/.bashrc
# clear
(/etc/wptt/domain/wptt-themwebsite $NAME) #đóng () để không bị chèn biến

rm -rf /usr/local/lsws/conf/vhosts/wptangtoc-ols.com >/dev/null 2>&1
rm -rf /usr/local/lsws/wptangtoc-ols.com >/dev/null 2>&1
rm -rf /etc/wptt-ssl-tu-ky/wptangtoc-ols.com >/dev/null 2>&1
rm -f /etc/wptt/vhost/.wptangtoc-ols.com.conf
pkill -u wptangtocwpolswpcom >/dev/null 2>&1

#-f la force băt buộc
userdel -f wptangtocwpolswpcom >/dev/null 2>&1
rm -rf wptangtocwpolswpcom >/dev/null 2>&1
rm -rf /home/wptangtoc-ols.com >/dev/null 2>&1
rm -rf /usr/local/backup-website/wptangtoc-ols.com >/dev/null 2>&1
rm -rf /wptangtoc-ols/wptangtoc-ols.com >/dev/null 2>&1

#Làm mới sạch sẽ (Clean Refresh): Nó hủy bỏ phiên làm việc hiện tại và tải lại .bashrc từ đầu. Các biến môi trường cũ, hàm cũ, alias cũ sẽ bị xóa sạch.
exec bash

# source /root/.bashrc
# . /etc/wptt/wptt-status2 #trả về wptt status
# echo "-------------------------------------------------------------------------"
# echo "Chào mừng bạn đến với WPTangToc OLS"
# echo "Phần mềm phát triển bởi Gia Tuấn (wptangtoc.com)"
# echo '-------------------------------------------------------------------------'
# echo "Nhập lệnh phím 1 để vào menu quản trị"
# echo '-------------------------------------------------------------------------'
