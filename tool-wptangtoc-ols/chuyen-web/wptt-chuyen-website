#!/bin/bash
# @author: Gia Tu·∫•n
# @website: https://wptangtoc.com
# @email: giatuan@wptangtoc.com
# @since: 2025

function huong_dan() {
  T√≠nh nƒÉng n√†y chuy·ªÉn website ngo√†i [Cpanel,plesk,Cyperpanel, AApanel, Larpvs,HocVPs,VPSSim... h·ªá th·ªëng c≈© c√≥ terminal l√† ƒë∆∞·ª£c] chuy·ªÉn v·ªÅ wptangtoc ols

  T√≠nh nƒÉng Qu·∫£n l√Ω Chuy·ªÉn Website [Website Migration] trong WPTangToc OLS l√† m·ªôt t·∫≠p h·ª£p c√°c c√¥ng c·ª• v√† quy tr√¨nh ƒë∆∞·ª£c thi·∫øt k·∫ø ƒë·ªÉ gi√∫p b·∫°n di chuy·ªÉn website [ƒë·∫∑c bi·ªát l√† WordPress] t·ª´ m·ªôt n∆°i n√†y sang n∆°i kh√°c m·ªôt c√°ch d·ªÖ d√†ng v√† √≠t l·ªói h∆°n. üööüí®

  Gi·ªõi thi·ªáu ng·∫Øn g·ªçn:
  M·ª•c ƒë√≠ch: ƒê∆°n gi·∫£n h√≥a qu√° tr√¨nh chuy·ªÉn website gi·ªØa c√°c m√°y ch·ªß, t·ª´ nh√† cung c·∫•p n√†y sang nh√† cung c·∫•p kh√°c, ho·∫∑c t·ª´ m√¥i tr∆∞·ªùng ph√°t tri·ªÉn [staging] l√™n m√°y ch·ªß ch√≠nh [production] v√† ng∆∞·ª£c l·∫°i.

  L·ª£i √≠ch:
  * Gi·∫£m thi·ªÉu l·ªói th·ªß c√¥ng: T·ª± ƒë·ªông h√≥a nhi·ªÅu b∆∞·ªõc ph·ª©c t·∫°p trong qu√° tr√¨nh di chuy·ªÉn.
  * Ti·∫øt ki·ªám th·ªùi gian: TƒÉng t·ªëc ƒë·ªô di chuy·ªÉn website so v·ªõi vi·ªác l√†m th·ªß c√¥ng ho√†n to√†n.
  * ƒê·∫£m b·∫£o t√≠nh to√†n v·∫πn: Gi√∫p di chuy·ªÉn ƒë·∫ßy ƒë·ªß c·∫£ t·ªáp tin v√† c∆° s·ªü d·ªØ li·ªáu m·ªôt c√°ch nh·∫•t qu√°n.
  * Thu·∫≠n ti·ªán: Cung c·∫•p m·ªôt quy tr√¨nh t√≠ch h·ª£p ngay trong c√¥ng c·ª• qu·∫£n l√Ω m√°y ch·ªß quen thu·ªôc.
  T√≠nh nƒÉng n√†y gi√∫p qu√° tr√¨nh chuy·ªÉn nh√† cho website c·ªßa b·∫°n tr·ªü n√™n m∆∞·ª£t m√† v√† √≠t cƒÉng th·∫≥ng h∆°n, ƒë·∫£m b·∫£o website ho·∫°t ƒë·ªông ·ªïn ƒë·ªãnh tr√™n m√¥i tr∆∞·ªùng m·ªõi.

}

echo ""
echo ""
echo ""
echo "========================================================================="
echo "|Chuy·ªÉn website v·ªÅ WPTangToc OLS						                  |"
echo "========================================================================="
. /etc/wptt/.wptt.conf
NAME=$1
all_for=$2

if [[ $NAME = "98" ]]; then
  NAME=""
fi

if [[ $NAME = "" ]]; then
  . /etc/wptt/tenmien
  echo ""
  echo ""
  echo "L·ª±a ch·ªçn website b·∫°n mu·ªën chuy·ªÉn v·ªÅ: "
  echo ""
  lua_chon_NAME
fi

if [[ "$NAME" = "0" || "$NAME" = "" ]]; then
  return 2>/dev/null
  exit
fi

pathcheck="/etc/wptt/vhost/.$NAME.conf"
if [[ ! -f "$pathcheck" ]]; then
  clear
  echoDo "T√™n mi·ªÅn kh√¥ng t·ªìn t·∫°i tr√™n h·ªá th·ªëng n√†y"
  sleep 3
  return 2>/dev/null
  exit
  exit
fi

checkdns=$(host $NAME | grep -Eo -m 1 '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}')
if [[ "$checkdns" = "" ]]; then
  checkdns=$(nslookup $NAME | grep Address | cut -f5 | grep -Eo -m 1 '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}')
fi

ip=$(curl -skf --connect-timeout 5 --max-time 10 https://ipv4.icanhazip.com | grep -E -o '(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)' || curl -skf --connect-timeout 5 --max-time 10 https://checkip.amazonaws.com | grep -E -o '(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)')

if [[ "$checkdns" = "$ip" ]]; then
  echo "B·∫°n ƒë√£ tr·ªè DNS v·ªÅ webserver n√†y r·ªìi"
  return 2>/dev/null
  exit
fi

if [[ "$checkdns" = "" ]]; then
  echo "website $NAME hi·ªán t·∫°i kh√¥ng t·ªìn t·∫°i tr√™n h·ªá th·ªëng internet"
  return 2>/dev/null
  exit
fi

if [[ $all_for = "" ]]; then
  echo "Y√™u c·∫ßu webserver c≈© c·ªßa b·∫°n ph·∫£i c√≥ h·ªó tr·ª£ terminal"
  echo "T√≠nh nƒÉng n√†y ch·ªâ h·ªó tr·ª£ m√£ ngu·ªìn website WordPress"
  echo "H∆∞·ªõng d·∫´n: "
  echo "B∆∞·ªõc 1: h√£y cd ƒëi v√†o th∆∞ m·ª•c m√£ ngu·ªìn website c·ªßa b·∫°n mu·ªën chuy·ªÉn r·ªìi"
  echo "B∆∞·ªõc 2: D√°n paste ƒëo·∫°n l·ªánh n√†y v√†o terminal webserver c≈© c·ªßa b·∫°n: "
  echo "l·ªánh: curl -sO https://wptangtoc.com/share/wptt && bash wptt"
  echo ""
  echo "B√™n webserver c≈© th·ª±c thi ch·∫°y xong th√¨ h√£y quay l·∫°i v·ªÅ x√°c nh·∫≠n l√†m b∆∞·ªõc ti·∫øp theo"
  echo "X√°c nh·∫≠n ƒë√£ ho√†n t·∫•t ch·∫°y l·ªánh tr√™n ho√†n t·∫•t sao l∆∞u d·ªØ li·ªáu webserver c≈© v√† ti·∫øp t·ª•c b∆∞·ªõc ti·∫øp theo:"
  prompt="Nh·∫≠p l·ª±a ch·ªçn c·ªßa b·∫°n [1-2]: "
  dongy="n"
  options=("ƒê·ªìng √Ω, ti·∫øp t·ª•c" "Kh√¥ng ƒë·ªìng √Ω, quay tr·ªü v·ªÅ")
  PS3="$prompt"
  select opt in "${options[@]}"; do
    case "$REPLY" in
    1)
      dongy="y"
      break
      ;;

    2)
      dongy="n"
      break
      ;;

    $((${#options[@]} + 1)))
      printf "\nB·∫°n nh·∫≠p sai h·ªá th·ªëng s·∫Ω ch·ªçn l√† kh√¥ng ƒë·ªìng √Ω\n"
      break
      ;;
    *)
      printf "B·∫°n nh·∫≠p sai h·ªá th·ªëng s·∫Ω ch·ªçn l√† kh√¥ng ƒë·ªìng √Ω\n"
      break
      ;;
    esac
  done

fi

if [[ "$dongy" = "y" || "$all_for" = "1" ]]; then
  rm -f /usr/local/backup-website/$NAME/giatuan-wptangtoc.zip
  rm -f /usr/local/backup-website/$NAME/giatuan-wptangtoc.sql
  wget -P /usr/local/backup-website/$NAME http://$NAME/giatuan-wptangtoc.sql --no-check-certificate
  wget -P /usr/local/backup-website/$NAME http://$NAME/giatuan-wptangtoc.zip --no-check-certificate
else
  return 2>/dev/null
  exit
fi

if [[ -f /usr/local/backup-website/$NAME/giatuan-wptangtoc.zip ]]; then
  duong_dan_thu_muc="/usr/local/backup-website/$NAME/giatuan-wptangtoc.zip"
else
  echo "Ch∆∞a download ƒë∆∞·ª£c file m√£ ngu·ªìn"
  echo "Chuy·ªÉn website kh√¥ng th√†nh c√¥ng"
  return 2>/dev/null
  exit
fi

if [[ -f /usr/local/backup-website/$NAME/giatuan-wptangtoc.sql ]]; then
  duong_dan_thu_muc_sql="/usr/local/backup-website/$NAME/giatuan-wptangtoc.sql"
else
  echo "Ch∆∞a download ƒë∆∞·ª£c file sql"
  echo "Chuy·ªÉn website kh√¥ng th√†nh c√¥ng"
  return 2>/dev/null
  exit
fi

. /etc/wptt/vhost/.$NAME.conf

echo "ƒêang ti·∫øn h√†nh nh·∫≠p d·ªØ li·ªáu database website $NAME ..."
mariadb -u "$database_admin_username" -p"$database_admin_password" -e "DROP DATABASE IF EXISTS ${DB_Name_web}"
mariadb -u "$database_admin_username" -p"$database_admin_password" -e "CREATE DATABASE IF NOT EXISTS ${DB_Name_web}"
mariadb -u "$database_admin_username" -p"$database_admin_password" -e "DROP USER IF EXISTS '${DB_User_web}'@'localhost'"
mariadb -u "$database_admin_username" -p"$database_admin_password" -e "CREATE USER IF NOT EXISTS '${DB_User_web}'@'localhost' IDENTIFIED BY '${DB_Password_web}'"
mariadb -u "$database_admin_username" -p"$database_admin_password" -e "GRANT ALL PRIVILEGES ON ${DB_Name_web}.* TO '${DB_User_web}'@'localhost' WITH GRANT OPTION"
mariadb -u "$database_admin_username" -p"$database_admin_password" -e "FLUSH PRIVILEGES"
clear
mariadb -u "$DB_User_web" -p"$DB_Password_web" "$DB_Name_web" --force <$duong_dan_thu_muc_sql
echo "Nh·∫≠p d·ªØ li·ªáu database th√†nh c√¥ng"
rm -rf /usr/local/lsws/"$NAME"/html/*

if [[ "$all_for" = "" ]]; then
  echo "ƒêang ti·∫øn h√†nh gi·∫£i n√©n m√£ ngu·ªìn c·ªßa website $NAME: "
  unzip -n "$duong_dan_thu_muc" -d /usr/local/lsws/"$NAME"/html/ -x "wptt"
else
  echo "ƒêang ti·∫øn h√†nh gi·∫£i n√©n m√£ ngu·ªìn c·ªßa website $NAME: "
  unzip -n "$duong_dan_thu_muc" -d /usr/local/lsws/"$NAME"/html/
fi

rm -rf /usr/local/lsws/"$NAME"/luucache/*

#xo√° file index.html
if [[ -f /usr/local/lsws/$NAME/html/index.html ]]; then
  rm -f /usr/local/lsws/$NAME/html/index.html
fi

chown -R "$User_name_vhost":"$User_name_vhost" /usr/local/lsws/"$NAME"/html
find /usr/local/lsws/"$NAME"/html -type d -exec chmod 755 {} \;
find /usr/local/lsws/"$NAME"/html -type f -exec chmod 644 {} \;

if [[ -f /usr/local/lsws/$NAME/html/wp-config.php ]]; then
  sed -i "/DB_HOST/s/'[^']*'/'localhost'/2" "/usr/local/lsws/$NAME/html/wp-config.php"
  sed -i "/DB_NAME/s/'[^']*'/'$DB_Name_web'/2" "/usr/local/lsws/$NAME/html/wp-config.php"
  sed -i "/DB_USER/s/'[^']*'/'$DB_User_web'/2" "/usr/local/lsws/$NAME/html/wp-config.php"
  sed -i "/DB_PASSWORD/s/'[^']*'/'$DB_Password_web'/2" "/usr/local/lsws/$NAME/html/wp-config.php"
  wp rewrite flush --allow-root --path=/usr/local/lsws/"$NAME"/html >/dev/null 2>&1
else
  echo "Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c file wp-config.php"
  echo "C√≥ v·∫ª nh∆∞ ƒë·∫≠y kh√¥ng ph·∫£i m√£ ngu·ªìn website WordPress"
fi
/usr/local/lsws/bin/lswsctrl restart >/dev/null 2>&1

rm -f /usr/local/backup-website/$NAME/giatuan-wptangtoc.zip
rm -f /usr/local/backup-website/$NAME/giatuan-wptangtoc.sql

#ho tro check wordpress multisite
if [[ -f /usr/local/lsws/$NAME/html/wp-config.php ]]; then
  check_mulsite_dang_su_dung=$(cat /usr/local/lsws/$NAME/html/wp-config.php | grep MULTISITE)
  if [[ $check_mulsite_dang_su_dung ]]; then
    . /etc/wptt/wordpress/wordpress-multisite $NAME 1
  fi
fi

RED='\033[0;31m'
NC='\033[0m'
echo -e "${RED}
     .:..........................             
      .::::::::::::::::::::::::::::..         
        ..:::::::::::::::::::::::::::::.      
                             ...:::::::::.    
                                  .:::::::.   
          .:::::::.         .       .:::::::  
         .::::::::::::::::::::..      ::::::: 
         ::::::::::::::::::::::::.     ::::::.
        .::::::::::::::::::::::::::.   .:::::.
        .::::::::::::::::::::::::::::  .:::::.
        .::::::::::::::::::::::::::.   .:::::.
         ::::::::::::::::::::::::.     ::::::.
.::::::  .:::::::::::::::::::::.      ::::::. 
          .:::::::.                 .:::::::  
       ::::::::::::.              .:::::::.   
       ......:::::::::...    ...:::::::::.    
               .:::::::::::::::::::::::.      
   ..............::::::::::::::::::..         
  .:::::::::::::................. ${NC}"

echo "==================================================================="
echo "        Chuy·ªÉn website $NAME v·ªÅ h·ªá th·ªëng th√†nh c√¥ng                "
echo "==================================================================="

if [[ "$all_for" = "" ]]; then
  checkdns=$(host $NAME | grep -Eo -m 1 '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}')
  if [[ "$checkdns" = "" ]]; then
    checkdns=$(nslookup $NAME | grep Address | cut -f5 | grep -Eo -m 1 '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}')
  fi

  ip=$(curl -skf --connect-timeout 5 --max-time 10 https://ipv4.icanhazip.com | grep -E -o '(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)' || curl -skf --connect-timeout 5 --max-time 10 https://checkip.amazonaws.com | grep -E -o '(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)')

  if [[ "$checkdns" != "$ip" ]]; then
    if [[ "$checkdns" = "" ]]; then
      echo "Ten mien $NAME chua duoc tro IP gia tri IP cua $NAME la khong co gia tri nao, ban vui long tro IP ve $ip de tan huong thanh qua"
    else
      echo "Hay tro DNS domain $NAME: $checkdns thanh $ip va cai them SSL de tan huong thanh qua"
    fi
  fi

  echo "==================================================================="
  echo "                                                                   "
  echo "Disk : $(df -BG | awk '$NF=="/"{printf "%d/%dGB (%s)\n", $3,$2,$5}')                        "
  echo "                                                                   "
  echo "                                                                   "
  echo "Duong dan luu tru backup	: /usr/local/backup-website/$NAME         "
  echo "duong dan thu muc website	: /usr/local/lsws/$NAME/html              "
  echo "==================================================================="
  echo "Cong cu phat trien boi		: Gia Tuan"
  echo "Yeu Cau Ho tro			: https://wptangtoc.com/lien-he"
  echo "Ho tro phat trien		: https://wptangtoc.com/donate"
  echo "==================================================================="
fi
