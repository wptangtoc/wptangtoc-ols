#!/bin/bash
function huong_dan() {
  T√≠nh nƒÉng n√†y s·∫Ω th·ª±c hi·ªán kh·ªüi ƒë·ªông l·∫°i [Reboot] to√†n b·ªô VPS/Server.
  üí° Khi n√†o n√™n s·ª≠ d·ª•ng?
  1. Khi h·ªá th·ªëng b·ªã treo, gi·∫≠t lag n·∫∑ng ho·∫∑c RAM b·ªã r√≤ r·ªâ [Memory Leak].
  2. Sau khi c·∫≠p nh·∫≠t nh√¢n h·ªá ƒëi·ªÅu h√†nh [Kernel] ho·∫∑c c√°c g√≥i ph·∫ßn m·ªÅm l√µi.
  3. Khi Database ho·∫∑c Web Server g·∫∑p l·ªói kh√¥ng th·ªÉ kh·ªüi ƒë·ªông l·∫°i b·∫±ng l·ªánh th∆∞·ªùng.

  ‚ö†Ô∏è C·∫¢NH B√ÅO QUAN TR·ªåNG:
  - To√†n b·ªô website tr√™n m√°y ch·ªß s·∫Ω b·ªã gi√°n ƒëo·∫°n truy c·∫≠p t·ª´ 1 ƒë·∫øn 5 ph√∫t
  t√πy thu·ªôc v√†o t·ªëc ƒë·ªô kh·ªüi ƒë·ªông c·ªßa nh√† cung c·∫•p VPS.
  - H√£y ƒë·∫£m b·∫£o kh√¥ng c√≥ ti·∫øn tr√¨nh n√†o [nh∆∞ Backup] ƒëang ch·∫°y d·ªü dang.
}

check_tu_menu_tuong_tac=$1

. /etc/wptt/.wptt.conf
if [[ $ngon_ngu = '' ]]; then
  ngon_ngu='vi'
fi
. /etc/wptt/lang/$ngon_ngu.sh

. /etc/wptt/echo-color

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m'
function khoi_dong_lai() {
  echo -e "${RED}C·∫¢NH B√ÅO: M√°y ch·ªß s·∫Ω kh·ªüi ƒë·ªông l·∫°i ngay l·∫≠p t·ª©c!${NC}"
  echo -e "To√†n b·ªô website s·∫Ω kh√¥ng th·ªÉ truy c·∫≠p trong v√†i ph√∫t."
  echo ""

  # H·ªèi x√°c nh·∫≠n ng∆∞·ªùi d√πng
  if [[ $check_tu_menu_tuong_tac = '98' ]]; then #n·∫øu g√µ th·∫≥ng: /etc/wptt/service/reboot-server th√¨ kh√¥ng c·∫ßn ph·∫£i x√°c nh·∫≠n l·∫°i
    echo -e "$xac_nhan reboot server?: "
    prompt="$nhap_lua_chon_cua_ban [1-2]: "
    dongy="n"
    options=("$dong_y" "$khong_dong_y")
    PS3="$prompt"
    select opt in "${options[@]}"; do
      case "$REPLY" in
      1)
        xac_nhan="y"
        break
        ;;

      2)
        xac_nhan="n"
        break
        ;;

      $((${#options[@]} + 1)))
        printf "\n$ban_nhap_sai_he_thong_se_chon_khong_dong_y\n"
        break
        ;;
      *)
        printf "$ban_nhap_sai_he_thong_se_chon_khong_dong_y\n"
        break
        ;;
      esac
    done
  else
    xac_nhan='y'
  fi

  if [[ "$xac_nhan" == "y" || "$xac_nhan" == "Y" ]]; then
    echo -e "${YELLOW}ƒêang ti·∫øn h√†nh l∆∞u d·ªØ li·ªáu ƒë·ªám (sync)...${NC}"
    # L·ªánh sync r·∫•t quan tr·ªçng: Gi√∫p ghi to√†n b·ªô d·ªØ li·ªáu ƒëang n·∫±m tr√™n RAM xu·ªëng ·ªï c·ª©ng
    # ƒë·ªÉ tr√°nh l·ªói h·ªèng Database (MariaDB/MySQL) khi s·∫≠p ngu·ªìn ƒë·ªôt ng·ªôt.
    #nh·ªØng d·ªØ li·ªáu ƒëang "l∆° l·ª≠ng" tr√™n RAM ch∆∞a k·ªãp ghi xu·ªëng ·ªï c·ª©ng s·∫Ω b·ªã m·∫•t vƒ©nh vi·ªÖn,H·∫≠u qu·∫£: G√¢y ra l·ªói corrupt (h·ªèng) file. ƒê·∫∑c bi·ªát v·ªõi MariaDB/MySQL, vi·ªác t·∫Øt ngang khi d·ªØ li·ªáu ch∆∞a ghi xong l√† nguy√™n nh√¢n s·ªë 1 g√¢y ra l·ªói Database Corruption (h·ªèng b·∫£ng d·ªØ li·ªáu, kh√¥ng th·ªÉ kh·ªüi ƒë·ªông l·∫°i DB).
    /usr/bin/sync
    sleep 1
    echo -e "${GREEN}M√°y ch·ªß ƒëang kh·ªüi ƒë·ªông l·∫°i. Vui l√≤ng k·∫øt n·ªëi l·∫°i sau √≠t ph√∫t!${NC}"

    # L·ªánh kh·ªüi ƒë·ªông l·∫°i
    /sbin/reboot
  else
    echo -e "${GREEN}ƒê√£ h·ªßy thao t√°c kh·ªüi ƒë·ªông l·∫°i.${NC}"
    echo -e "ƒêang quay l·∫°i menu ..."
    sleep 1

    # D√πng b√†i h·ªçc exec ƒë·ªÉ quay l·∫°i menu ch√≠nh m∆∞·ª£t m√†, kh√¥ng vƒÉng SSH
    if [ -f "/etc/wptt/wptt-service-main" ]; then
      exec /etc/wptt/wptt-service-main 98
    else
      exit 0
    fi
  fi
}

khoi_dong_lai
