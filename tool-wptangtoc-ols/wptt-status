#!/bin/bash

. /etc/wptt/.wptt.conf
if [[ $ngon_ngu = '' ]]; then ngon_ngu='vi'; fi
. /etc/wptt/lang/$ngon_ngu.sh
clear

export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8

RED='\033[0;31m'
NC='\033[0m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
box_inner_width=71

# --- BACKGROUND ALERTS ---
if [[ "$thong_bao_login_ssh" = "1" ]]; then
  (
    client_ip=$(echo $SSH_CLIENT | awk '{ print $1}')
    vps_ip=$(curl -sf --connect-timeout 5 https://ipv4.icanhazip.com || echo "unknown")
    date="$(date "+%d-%m-%Y %H:%M")"
    info_ip=https://ipinfo.io/${client_ip}

    domains=""
    for entry in $(ls -A /etc/wptt/vhost 2>/dev/null | grep -v '^\.\.conf$' | sort -uV); do
      domain=$(echo $entry | sed 's/^.//' | sed 's/.conf//')
      path="/usr/local/lsws/$domain/html"
      if [[ -d "$path" ]]; then domains+="$domain, "; fi
    done

    text="
Cảnh báo đăng nhập SSH - ${vps_ip}
-------------------------------------
IP đăng nhập: *${client_ip}* - [Chi tiết](${info_ip})
Thời điểm: ${date}
Website: ${domains}
-------------------------------------
WPTangToc OLS: $version_wptangtoc_ols
"
    url_tele="https://worker-soft-shape-e788.hoangtuan0137.workers.dev/bot${telegram_api}/sendMessage"
    curl -s -d "chat_id=$telegram_id&text=${text}&disable_web_page_preview=true&parse_mode=markdown" $url_tele >/dev/null
  ) &
  disown
fi

# --- LOGIC KIỂM TRA CẬP NHẬT ---
SHOW_UPDATE=0
NEW_VERSION=""

if [[ -f /tmp/wptangtoc-ols-version ]]; then
  wptangtocols_version=$(cat /tmp/wptangtoc-ols-version)
fi
if [[ $wptangtocols_version = "" ]]; then
  wptangtocols_version=$(curl -sf --connect-timeout 2 --max-time 5 https://wptangtoc.com/share/version-wptangtoc-ols.txt | head -1 | grep '\.' || curl -sf --connect-timeout 2 --max-time 5 https://raw.githubusercontent.com/wptangtoc/wptangtoc-ols/refs/heads/main/version-wptangtoc-ols.txt)
fi
if [[ "$wptangtocols_version" != "" && "$wptangtocols_version" != "$version_wptangtoc_ols" ]]; then
  SHOW_UPDATE=1
  NEW_VERSION="$wptangtocols_version"
fi

# --- CÁC HÀM HỖ TRỢ ---
draw_bar() {
  local percent=$1
  local length=15
  local fill=$(((percent * length) / 100))
  local empty=$((length - fill))
  local color=$GREEN
  if [ "$percent" -ge 80 ]; then
    color=$RED
  elif [ "$percent" -ge 60 ]; then
    color=$YELLOW
  fi
  printf "${NC}[${color}"
  printf "%0.s|" $(seq 1 $fill)
  printf "${NC}"
  printf "%0.s." $(seq 1 $empty)
  printf "${NC}]"
}

center_text() {
  local text="$1"
  local clean_text=$(echo -e "$text" | sed "s/\x1B\[[0-9;]*[a-zA-Z]//g")
  local text_len=${#clean_text}
  if ((text_len >= box_inner_width)); then
    printf "${RED}|${NC} %s ${RED}|${NC}\n" "$text"
    return
  fi
  local total_padding=$((box_inner_width - text_len))
  local pad_left=$((total_padding / 2))
  local pad_right=$((total_padding - pad_left))
  printf "${RED}|${NC}%*s%s%*s${RED}|${NC}\n" $pad_left "" "$text" $pad_right ""
}

# --- HEADER ---
echo -e "${RED}+-----------------------------------------------------------------------+${NC}"
center_text ""
center_text "WPTANGTOC OLS $phien_ban: $version_wptangtoc_ols"
center_text "$phat_trien_boi_gia_tuan"

if [[ $wptangtoc_ols_giatuan = "1" && $key_activate ]]; then
  center_text "WPTangToc OLS enterprise + premium"
else
  if [[ $wptangtoc_ols_giatuan = "1" ]]; then center_text "WPTangToc OLS enterprise"; fi
  if [[ $key_activate ]]; then center_text "WPTangToc OLS premium"; fi
fi

if [[ $beta_wptangtoc_ols = "1" ]]; then center_text "WPTangToc OLS beta"; fi
center_text ""
echo -e "${RED}+-----------------------------------------------------------------------+${NC}"

# Lời chào
thoi_gian=$(date +'%H' | sed 's/^0//g')
if (($thoi_gian < 10)); then
  thoi_diem='Chúc bạn có buổi sáng tuyệt vời'
elif (($thoi_gian < 14)); then
  thoi_diem='Chúc bạn có buổi trưa tuyệt vời'
elif (($thoi_gian < 18)); then
  thoi_diem='Chúc bạn có buổi chiều tuyệt vời'
else
  thoi_diem='Chúc bạn có buổi tối tuyệt vời'
fi

if [[ $wptangtoc_ols_giatuan = "1" ]]; then
  echo "$thoi_diem - WPTangToc OLS Premium $san_sang_phuc_vu              "
else
  echo "$thoi_diem - $chao_mung_ban_den_voi_wptangtoc_ols              "
fi

# --- INIT VARS (MAIN LOOP STATE) ---
# [TỐI ƯU 1] Lấy OS Name 1 lần duy nhất, không chạy lại trong vòng lặp
OS_NAME_STATIC=$(hostnamectl | grep System | cut -f2 -d':' | sed 's/^ //g' | cut -f1 -d '(' | head -1)

read -r cpu a b c idle rest </proc/stat
prev_total=$((a + b + c + idle))
prev_idle=$idle
cpu_display_val=0
read rx_prev tx_prev <<<$(awk 'NR>2 && $1 != "lo:" {rx+=$2; tx+=$10} END {print rx, tx}' /proc/net/dev)

# --- DISPLAY FUNCTION ---
# Hàm này nhận tham số trạng thái service thay vì tự kiểm tra
print_dashboard() {
  local rx_rate_in=$1
  local tx_rate_in=$2
  local cpu_usage_in=$3
  local ols_status_in=$4
  local db_status_in=$5

  # RAM
  ram_stats=$(free -m | awk 'NR==2{printf "%s %s %.0f", $3, $2, $3*100/$2 }')
  read -r ram_used ram_total ram_percent <<<"$ram_stats"

  # DISK
  disk_stats=$(df -BG / | awk 'NR==2 {print $3, $2, $5}' | sed 's/G//g' | sed 's/%//g')
  read -r disk_used disk_total disk_percent <<<"$disk_stats"

  # NETWORK COLOR
  net_in_display="${rx_rate_in} KB/s"
  net_out_display="${tx_rate_in} KB/s"
  if [ "$rx_rate_in" -gt 5120 ]; then net_in_display="${RED}${rx_rate_in} KB/s${NC}"; fi
  if [ "$tx_rate_in" -gt 5120 ]; then net_out_display="${RED}${tx_rate_in} KB/s${NC}"; fi

  # LOAD & UPTIME
  load_avg=$(cat /proc/loadavg | awk '{print $1", " $2", " $3}')
  up_seconds=$(cat /proc/uptime | awk '{print $1}' | cut -d. -f1)
  d=$((up_seconds / 86400))
  h=$(((up_seconds % 86400) / 3600))
  m=$(((up_seconds % 3600) / 60))
  s=$((up_seconds % 60))
  uptime_display="${d}d ${h}h ${m}m ${s}s"

  # PRINT LAYOUT
  echo "-------------------------------------------------------------------------"
  printf "CPU : %3s%% %s  Load: %s\n" "$cpu_usage_in" "$(draw_bar $cpu_usage_in)" "$load_avg"
  printf "RAM : %3s%% %s  Used: %s/%s MB\n" "$ram_percent" "$(draw_bar $ram_percent)" "$ram_used" "$ram_total"
  printf "Disk: %3s%% %s  Used: %s/%s GB\n" "$disk_percent" "$(draw_bar $disk_percent)" "$disk_used" "$disk_total"
  echo "-------------------------------------------------------------------------"
  # Hiển thị trạng thái đã được cache
  printf "Net In : %-15b |  OpenLiteSpeed 	: %b\n" "$net_in_display" "$ols_status"
  printf "Net Out: %-15b |  MariaDB		: %b\n" "$net_out_display" "$db_status_in"
  printf "Uptime : %-15s |  OS 			: %s\n" "$uptime_display" "$OS_NAME_STATIC"

  # MENU CENTERED
  echo '-------------------------------------------------------------------------'
  menu_str="[ENTER] Menu  |  [2] Menu nhanh"
  if [[ "$SHOW_UPDATE" == "1" ]]; then
    menu_str="${menu_str}  |  ${YELLOW}[9] Cập nhật ($NEW_VERSION)${GREEN}"
  fi
  menu_str="${menu_str}  |  [0] Thoát"

  clean_menu_str=$(echo -e "$menu_str" | sed "s/\x1B\[[0-9;]*[a-zA-Z]//g")
  width=73
  pad=$(((width - ${#clean_menu_str}) / 2))
  if [ $pad -lt 0 ]; then pad=0; fi
  printf "%${pad}s" ""
  echo -e "${GREEN}${menu_str}${NC}"
  echo '-------------------------------------------------------------------------'

  if [ "$ram_percent" -gt 85 ]; then echo -e "${RED}Cảnh báo: RAM đang quá tải!${NC}"; fi
  if [ "$disk_percent" -gt 90 ]; then echo -e "${RED}Cảnh báo: Ổ cứng sắp đầy!${NC}"; fi
}

# --- VÒNG LẶP CHÍNH (MAIN LOOP) ---
tput civis
ACTION="menu"

# [TỐI ƯU 2] Khởi tạo biến đếm và cache
counter=0
cached_ols_status="${YELLOW}Đang kiểm tra...${NC}"
cached_db_status="${YELLOW}Đang kiểm tra...${NC}"

while true; do
  # NETWORK
  read rx_now tx_now <<<$(awk 'NR>2 && $1 != "lo:" {rx+=$2; tx+=$10} END {print rx, tx}' /proc/net/dev)
  if ((rx_now < rx_prev)); then rx_rate=0; else rx_rate=$(((rx_now - rx_prev) / 1024)); fi
  if ((tx_now < tx_prev)); then tx_rate=0; else tx_rate=$(((tx_now - tx_prev) / 1024)); fi
  rx_prev=$rx_now
  tx_prev=$tx_now

  # CPU (SMOOTHING)
  read -r cpu a b c idle rest </proc/stat
  total=$((a + b + c + idle))
  diff_idle=$((idle - prev_idle))
  diff_total=$((total - prev_total))

  prev_total=$total
  prev_idle=$idle

  if [ $diff_total -eq 0 ]; then
    cpu_now=0
  else
    cpu_now=$((100 * (diff_total - diff_idle) / diff_total))
  fi

  # LÀM MƯỢT: (Old + New) / 2
  cpu_display_val=$(((cpu_display_val + cpu_now) / 2))

  # [TỐI ƯU 3] CHỈ CHECK SERVICE MỖI 5 GIÂY
  # Dùng phép chia lấy dư: 0, 5, 10, 15... thì mới chạy lệnh nặng
  if ((counter % 5 == 0)); then
    # Check OLS
    if /usr/local/lsws/bin/lswsctrl status | grep -q 'litespeed is running'; then
      cached_ols_status="${GREEN}Hoạt động${NC}"
    else
      cached_ols_status="${RED}Tạm dừng${NC}"
    fi

    # Check MariaDB
    if systemctl is-active mariadb.service >/dev/null 2>&1; then
      cached_db_status="${GREEN}Hoạt động${NC}"
    else
      cached_db_status="${RED}Tạm dừng${NC}"
    fi
  fi
  # Tăng biến đếm
  ((counter++))

  # HIỂN THỊ (Truyền thêm 2 biến status đã cache)
  buffer=$(print_dashboard "$rx_rate" "$tx_rate" "$cpu_display_val" "$cached_ols_status" "$cached_db_status")
  echo -e "$buffer"
  lines=$(echo "$buffer" | wc -l)

  # HANDLE INPUT
  read -t 1 -n 1 -s key_input
  if [ $? -eq 0 ]; then
    if [[ "$key_input" == "0" ]]; then
      ACTION="exit"
    elif [[ "$key_input" == "2" ]]; then
      ACTION="search"
    elif [[ "$key_input" == "9" && "$SHOW_UPDATE" == "1" ]]; then
      ACTION="update"
    else ACTION="menu"; fi
    break
  fi
  tput cuu "$lines"
done

# Gỡ bỏ Trap để không ảnh hưởng các lệnh sau (nếu có)
trap - SIGINT
tput cnorm

# --- EXECUTE ACTION ---
echo ""
case $ACTION in
"exit") echo -e "Đã thoát ra WPTangToc OLS. Nhập lệnh ${GREEN}1${NC} hoặc ${GREEN}wptangtoc${NC} để quay lại menu." ;;
"search")
  if [ -f "/etc/wptt/search-wptangtoc" ]; then
    /etc/wptt/search-wptangtoc
  else echo "Lỗi file search"; fi
  ;;
"update")
  if [ -f "/etc/wptt/wptt-update" ]; then
    echo -e "${YELLOW}Đang tiến hành cập nhật hệ thống...${NC}"
    /etc/wptt/wptt-update
  else echo "Lỗi: Không tìm thấy file cập nhật"; fi
  ;;
*)
  if [ -f "/usr/bin/wptangtoc" ]; then
    exec /usr/bin/wptangtoc
  else echo "Lỗi file wptangtoc"; fi
  ;;
esac
