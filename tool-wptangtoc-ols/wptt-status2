#!/bin/bash
# =========================================================================
# WPTangToc OLS - Ultimate Dashboard (Centered Menu + Perfect Align)
# =========================================================================

. /etc/wptt/.wptt.conf
if [[ $ngon_ngu = '' ]]; then ngon_ngu='vi'; fi
. /etc/wptt/lang/$ngon_ngu.sh
clear

export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8

RED='\033[0;31m'
NC='\033[0m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
box_inner_width=71

# --- HÀM VẼ THANH TIẾN TRÌNH ---
draw_bar() {
  local percent=$1
  local length=15
  local fill=$(((percent * length) / 100))
  local empty=$((length - fill))
  local color=$GREEN
  if [ "$percent" -ge 80 ]; then
    color=$RED
  elif [ "$percent" -ge 60 ]; then
    color=$YELLOW
  fi
  printf "${NC}[${color}"
  printf "%0.s|" $(seq 1 $fill)
  printf "${NC}"
  printf "%0.s." $(seq 1 $empty)
  printf "${NC}]"
}

# --- HÀM CĂN GIỮA (CHO HEADER CÓ KHUNG) ---
center_text() {
  local text="$1"
  local clean_text=$(echo -e "$text" | sed "s/\x1B\[[0-9;]*[a-zA-Z]//g")
  local text_len=${#clean_text}
  if ((text_len >= box_inner_width)); then
    printf "${RED}|${NC} %s ${RED}|${NC}\n" "$text"
    return
  fi
  local total_padding=$((box_inner_width - text_len))
  local pad_left=$((total_padding / 2))
  local pad_right=$((total_padding - pad_left))
  printf "${RED}|${NC}%*s%s%*s${RED}|${NC}\n" $pad_left "" "$text" $pad_right ""
}

# --- HEADER TĨNH ---
echo -e "${RED}+-----------------------------------------------------------------------+${NC}"
center_text ""
center_text "WPTANGTOC OLS $phien_ban: $version_wptangtoc_ols"
center_text "$phat_trien_boi_gia_tuan"

if [[ $wptangtoc_ols_giatuan = "1" && $key_activate ]]; then
  center_text "WPTangToc OLS enterprise + premium"
else
  if [[ $wptangtoc_ols_giatuan = "1" ]]; then center_text "WPTangToc OLS enterprise"; fi
  if [[ $key_activate ]]; then center_text "WPTangToc OLS premium"; fi
fi

if [[ $beta_wptangtoc_ols = "1" ]]; then center_text "WPTangToc OLS beta"; fi
center_text ""
echo -e "${RED}+-----------------------------------------------------------------------+${NC}"

# Lời chào
thoi_gian=$(date +'%H' | sed 's/^0//g')
if (($thoi_gian < 10)); then
  thoi_diem='Chúc bạn có buổi sáng tuyệt vời'
elif (($thoi_gian < 14)); then
  thoi_diem='Chúc bạn có buổi trưa tuyệt vời'
elif (($thoi_gian < 18)); then
  thoi_diem='Chúc bạn có buổi chiều tuyệt vời'
else
  thoi_diem='Chúc bạn có buổi tối tuyệt vời'
fi

if [[ $wptangtoc_ols_giatuan = "1" ]]; then
  echo "$thoi_diem - WPTangToc OLS Premium $san_sang_phuc_vu             "
else
  echo "$thoi_diem - $chao_mung_ban_den_voi_wptangtoc_ols             "
fi

# --- KHỞI TẠO BIẾN LẦN ĐẦU ---
read -r cpu a b c idle rest </proc/stat
prev_total=$((a + b + c + idle))
prev_idle=$idle

# NETWORK INITIAL
read rx_prev tx_prev <<<$(awk 'NR>2 && $1 != "lo:" {rx+=$2; tx+=$10} END {print rx, tx}' /proc/net/dev)

# --- HÀM TÍNH TOÁN VÀ HIỂN THỊ ---
calculate_and_print() {
  local rx_rate_in=$1
  local tx_rate_in=$2

  # 1. CPU
  read -r cpu a b c idle rest </proc/stat
  total=$((a + b + c + idle))
  diff_idle=$((idle - prev_idle))
  diff_total=$((total - prev_total))

  prev_total=$total
  prev_idle=$idle

  if [ $diff_total -eq 0 ]; then
    cpu_usage=0
  else cpu_usage=$(((1000 * (diff_total - diff_idle) / diff_total + 5) / 10)); fi

  # 2. RAM
  ram_stats=$(free -m | awk 'NR==2{printf "%s %s %.0f", $3, $2, $3*100/$2 }')
  read -r ram_used ram_total ram_percent <<<"$ram_stats"

  # 3. DISK
  disk_stats=$(df -BG / | awk 'NR==2 {print $3, $2, $5}' | sed 's/G//g' | sed 's/%//g')
  read -r disk_used disk_total disk_percent <<<"$disk_stats"

  # 4. NETWORK FORMAT
  net_in_display="${rx_rate_in} KB/s"
  net_out_display="${tx_rate_in} KB/s"
  if [ "$rx_rate_in" -gt 5120 ]; then net_in_display="${RED}${rx_rate_in} KB/s${NC}"; fi
  if [ "$tx_rate_in" -gt 5120 ]; then net_out_display="${RED}${tx_rate_in} KB/s${NC}"; fi

  # 5. LOAD AVERAGE
  load_avg=$(cat /proc/loadavg | awk '{print $1", " $2", " $3}')

  # 6. UPTIME
  up_seconds=$(cat /proc/uptime | awk '{print $1}' | cut -d. -f1)
  d=$((up_seconds / 86400))
  h=$(((up_seconds % 86400) / 3600))
  m=$(((up_seconds % 3600) / 60))
  s=$((up_seconds % 60))
  uptime_display="${d}d ${h}h ${m}m ${s}s"

  # 7. SERVICE STATUS
  if /usr/local/lsws/bin/lswsctrl status | grep -q 'litespeed is running'; then
    ols_status="${GREEN}Hoạt động${NC}"
  else
    ols_status="${RED}Tạm dừng${NC}"
  fi
  if systemctl is-active mariadb.service >/dev/null 2>&1; then
    db_status="${GREEN}Hoạt động${NC}"
  else
    db_status="${RED}Tạm dừng${NC}"
  fi

  # Lấy tên OS
  os_name=$(hostnamectl | grep System | cut -f2 -d':' | sed 's/^ //g' | cut -f1 -d '(' | head -1)

  # --- IN RA MÀN HÌNH ---
  echo "-------------------------------------------------------------------------"
  printf "CPU : %3s%% %s  Load: %s\n" "$cpu_usage" "$(draw_bar $cpu_usage)" "$load_avg"
  printf "RAM : %3s%% %s  Used: %s/%s MB\n" "$ram_percent" "$(draw_bar $ram_percent)" "$ram_used" "$ram_total"
  printf "Disk: %3s%% %s  Used: %s/%s GB\n" "$disk_percent" "$(draw_bar $disk_percent)" "$disk_used" "$disk_total"

  echo "-------------------------------------------------------------------------"

  printf "Net In : %-15b |  OpenLiteSpeed : %b\n" "$net_in_display" "$ols_status"
  printf "Net Out: %-15b |  MariaDB       : %b\n" "$net_out_display" "$db_status"
  printf "Uptime : %-15s |  OS            : %s\n" "$uptime_display" "$os_name"

  echo '-------------------------------------------------------------------------'

  # --- CĂN GIỮA DÒNG MENU ---
  menu_visible="[ENTER] Menu  |  [2] Tìm kiếm nhanh  |  [0] Thoát"
  width=73 # Độ rộng của đường kẻ ngang (đếm thực tế)
  pad=$(((width - ${#menu_visible}) / 2))
  printf "%${pad}s" ""
  echo -e "${GREEN}${menu_visible}${NC}"

  echo '-------------------------------------------------------------------------'

  # CẢNH BÁO
  if [ "$ram_percent" -gt 85 ]; then echo -e "${RED}Cảnh báo: RAM đang quá tải!${NC}"; fi
  if [ "$disk_percent" -gt 90 ]; then echo -e "${RED}Cảnh báo: Ổ cứng sắp đầy!${NC}"; fi
}

# --- VÒNG LẶP CHÍNH ---
tput civis
ACTION="menu"

while true; do
  # TÍNH TOÁN NETWORK (Main Shell)
  read rx_now tx_now <<<$(awk 'NR>2 && $1 != "lo:" {rx+=$2; tx+=$10} END {print rx, tx}' /proc/net/dev)

  if ((rx_now < rx_prev)); then rx_rate=0; else rx_rate=$(((rx_now - rx_prev) / 1024)); fi
  if ((tx_now < tx_prev)); then tx_rate=0; else tx_rate=$(((tx_now - tx_prev) / 1024)); fi

  rx_prev=$rx_now
  tx_prev=$tx_now

  # TÍNH TOÁN CPU (Main Shell)
  read -r cpu a b c idle rest </proc/stat
  prev_total=$((a + b + c + idle))
  prev_idle=$idle

  # HIỂN THỊ
  buffer=$(calculate_and_print "$rx_rate" "$tx_rate")
  echo -e "$buffer"
  lines=$(echo "$buffer" | wc -l)

  read -t 1 -n 1 -s key_input
  if [ $? -eq 0 ]; then
    if [[ "$key_input" == "0" ]]; then
      ACTION="exit"
    elif [[ "$key_input" == "2" ]]; then
      ACTION="search"
    else ACTION="menu"; fi
    break
  fi
  tput cuu "$lines"
done

tput cnorm

# --- XỬ LÝ ---
echo ""
case $ACTION in
"exit") echo -e "\033[1;33mĐã thoát ra WPTangToc OLS. Gõ 1 để quay lại menu.\033[0m" ;;
"search")
  if [ -f "/etc/wptt/search-wptangtoc" ]; then
    /etc/wptt/search-wptangtoc
  else echo "Lỗi file search"; fi
  ;;
*)
  if [ -f "/usr/bin/wptangtoc" ]; then
    /usr/bin/wptangtoc
  else echo "Lỗi file wptangtoc"; fi
  ;;
esac
