#!/bin/bash

function huong_dan() {
  T√≠nh nƒÉng ngƒÉn ch·∫∑n truy tr·ª±c ti·∫øp http://IP ƒë·ªãa ch·ªâ ip c·ªßa b·∫°n
  üéØ M·ª•c ƒë√≠ch ch√≠nh TƒÉng c∆∞·ªùng B·∫£o m·∫≠t v√† ti·∫øt ki·ªám t√†i nguy√™n m√°y ch·ªß
  Vi·ªác n√†y th∆∞·ªùng h·ªØu √≠ch khi:
  * Ch·ªëng Bot d√≤ qu√©t t·ª± ƒë·ªông: R·∫•t nhi·ªÅu bot ƒë·ªôc h·∫°i ho·∫°t ƒë·ªông b·∫±ng c√°ch qu√©t to√†n b·ªô c√°c d·∫£i ƒë·ªãa ch·ªâ IP tr√™n Internet ƒë·ªÉ t√¨m ki·∫øm c√°c m√°y ch·ªß c√≥ l·ªó h·ªïng b·∫£o m·∫≠t. Khi b·∫°n ch·∫∑n truy c·∫≠p qua IP, m√°y ch·ªß c·ªßa b·∫°n s·∫Ω kh√¥ng ph·∫£n h·ªìi v·ªõi m·ªôt trang web c·ª• th·ªÉ. ƒêi·ªÅu n√†y khi·∫øn m√°y ch·ªß c·ªßa b·∫°n tr·ªü n√™n v√¥ h√¨nh tr∆∞·ªõc c√°c cu·ªôc t·∫•n c√¥ng t·ª± ƒë·ªông ·ªü m·ª©c ƒë·ªô c∆° b·∫£n, l√†m gi·∫£m ƒë√°ng k·ªÉ b·ªÅ m·∫∑t t·∫•n c√¥ng.
  * NgƒÉn ch·∫∑n t·∫•n c√¥ng Host Header Injection: ƒê√¢y l√† m·ªôt k·ªπ thu·∫≠t t·∫•n c√¥ng m√† k·∫ª x·∫•u g·ª≠i y√™u c·∫ßu ƒë·∫øn IP c·ªßa b·∫°n nh∆∞ng l·∫°i gi·∫£ m·∫°o th√¥ng tin t√™n mi·ªÅn [Host header]. B·∫±ng c√°ch thi·∫øt l·∫≠p m·ªôt quy t·∫Øc m·∫∑c ƒë·ªãnh ƒë·ªÉ t·ª´ ch·ªëi t·∫•t c·∫£ c√°c truy c·∫≠p kh√¥ng c√≥ t√™n mi·ªÅn h·ª£p l·ªá, b·∫°n c√≥ th·ªÉ v√¥ hi·ªáu h√≥a ki·ªÉu t·∫•n c√¥ng n√†y.
  * B·∫£o v·ªá c√°c trang web ƒëang ph√°t tri·ªÉn: Khi b·∫°n ƒëang x√¢y d·ª±ng m·ªôt trang web m·ªõi tr√™n m√°y ch·ªß nh∆∞ng ch∆∞a tr·ªè t√™n mi·ªÅn ch√≠nh th·ª©c, vi·ªác ch·∫∑n truy c·∫≠p IP s·∫Ω ngƒÉn ng∆∞·ªùi ngo√†i xem ho·∫∑c truy c·∫≠p v√†o trang web c√≤n dang d·ªü c·ªßa b·∫°n.
}

if [[ $2 = 'premium' ]]; then
  unset key_activate
  . /etc/wptt/.wptt.conf
  if [[ -z $key_activate ]]; then
    echo "T√≠nh nƒÉng n√†y l√† t√≠nh nƒÉng Premium b·∫°n ph·∫£i mua Active key m·ªõi c√≥ th·ªÉ s·ª≠ d·ª•ng ƒë∆∞·ª£c"
    echo "B·∫°n h√£y activate key th√¨ s·∫Ω ƒë∆∞·ª£c s·ª≠ d·ª•ng t·∫•t c·∫£ c√°c t√≠nh nƒÉng trong add ons"
    check_menu_wptangtoc_active=$1
    if [[ $check_menu_wptangtoc_active = "98" ]]; then
      . /etc/wptt/wptt-add-one-main 1
    fi
    exit
  fi
fi

PATH='/root/.local/bin:/root/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin' #bien moi truong full day du
ip=$(curl -sf --connect-timeout 5 --max-time 10 https://ipv4.icanhazip.com | grep -E -o '(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)' || curl -sf --connect-timeout 5 --max-time 10 https://checkip.amazonaws.com | grep -E -o '(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)')

. /etc/wptt/.wptt.conf
if [[ $ip_domain ]]; then
  echo "ƒê√£ setup ip domain tr∆∞·ªõc ƒë√≥ r·ªìi"
  exit
fi

if [[ -d /usr/local/lsws/$ip/html ]]; then
  echo "ƒê√£ setup ip tr∆∞·ªõc ƒë√≥ r·ªìi"
  exit
fi

. /etc/wptt/domain/wptt-themwebsite "$ip" >/dev/null 2>&1

echo '<IfModule mod_rewrite.c>
RewriteCond %{REQUEST_URI} ^(.*)$
RewriteRule .* - [E=blockbot:1,L]
</ifModule>
' >/usr/local/lsws/$ip/html/.htaccess
chattr +i /usr/local/lsws/$ip/html/.htaccess

if [[ -f /usr/local/lsws/logs/access.log ]]; then #xoa access log server
  truncate -s 0 /usr/local/lsws/logs/access.log >/dev/null 2>&1
  rm -f /usr/local/lsws/logs/access.log.* #access xo√° log c≈©
fi

if $(cat /etc/*release | grep -q "Ubuntu"); then
  tuong_thich_nhom_litespeed="nogroup"
else
  tuong_thich_nhom_litespeed="nobody"
fi

mkdir -p /usr/local/lsws/logs
chown root:$tuong_thich_nhom_litespeed /usr/local/lsws/logs
/usr/local/lsws/bin/lswsctrl restart >/dev/null 2>&1

chown root:root /usr/local/lsws #c·∫£i ti√™n ph√¢n quy·ªÅn chown root:root th∆∞ m·ª•c :/usr/local/lsws ƒë·ªÉ n√¢ng cao b·∫£o m·∫≠t

rm -f /etc/wptt/vhost/.$ip.conf

echo "Ho√†n t·∫•t k√≠ch ho·∫°t ip $ip scan block"
