#!/bin/bash
# @author: Gia Tuấn
# @website: https://wptangtoc.com
# @email: giatuan@wptangtoc.com
# @since: 2026

function huong_dan() {
  REPAIR TABLE: Công Cụ Sửa Chữa Bảng Dữ Liệu Bị Hỏng
  OPTIMIZE TABLE: Giải Pháp Tối Ưu Hóa Không Gian và Hiệu Suất Cơ Sở Dữ Liệu
  Mục đích chính của sửa chữa database:

  * Kiểm tra tệp dữ liệu và tệp chỉ mục [index] của bảng: Nó sẽ tìm kiếm các lỗi và sự không nhất quán trong cấu trúc lưu trữ của bảng.
  * Sửa chữa các lỗi tìm thấy: Tùy thuộc vào loại lỗi và mức độ hỏng hóc, DBMS sẽ cố gắng sửa chữa các khối dữ liệu bị hỏng, xây dựng lại các chỉ mục, hoặc loại bỏ các phần không thể khôi phục.
}

. /etc/wptt/.wptt.conf
. /etc/wptt/echo-color

# --- BẮT ĐẦU ĐOẠN SỬA LỖI DATABASE (REPAIR ONLY) ---
echo "Đang kiểm tra và sửa lỗi Database ..."
# 1. Xác định lệnh chuẩn
if command -v mariadb-check &>/dev/null; then
  DB_CHECK_CMD="mariadb-check"
else
  DB_CHECK_CMD="mysqlcheck"
fi

# 2. Tạo file cấu hình tạm (Bảo mật)
TEMP_CNF_ROOT=$(mktemp)
chmod 600 "$TEMP_CNF_ROOT"

cat >"$TEMP_CNF_ROOT" <<EOF
[client]
user=${database_admin_username}
password=${database_admin_password}
host=localhost
EOF

trap "rm -f $TEMP_CNF_ROOT" EXIT

# 3. Thực thi SỬA CHỮA (Repair)
# --check: Kiểm tra lỗi bảng
# --auto-repair: Nếu phát hiện lỗi thì tự động sửa (nếu không lỗi thì thôi)

$DB_CHECK_CMD --defaults-extra-file="$TEMP_CNF_ROOT" --check --auto-repair --all-databases \
  --skip-database="information_schema" \
  --skip-database="performance_schema" \
  --skip-database="mysql"

# Kiểm tra kết quả
if [[ $? -eq 0 ]]; then
  echo "---------------------------------------------------"
  echo "✅ Quá trình kiểm tra và sửa lỗi hoàn tất."
else
  echo "---------------------------------------------------"
  echo "⚠️ Có cảnh báo (Thường là do bảng InnoDB không hỗ trợ repair kiểu cũ, nhưng dữ liệu vẫn an toàn)."
fi

rm -f "$TEMP_CNF_ROOT"

echo "Sửa chữa ALL database : $(date '+%d-%m-%Y %H:%M')" >>/var/log/wptangtoc-ols.log

check_menu_wptangtoc_active=$1
if [[ $check_menu_wptangtoc_active = "98" ]]; then
  . /etc/wptt/wptt-db-main 1
fi
