#!/bin/bash
# @author: Gia Tuáº¥n
# @website: https://wptangtoc.com
# @since: 2025

function huong_dan() {
  1. TÃ­nh NÄƒng CÃ i Äáº·t Memcached [Install Memcached]
  CÃ i Ä‘áº·t Memcached lÃ  quÃ¡ trÃ¬nh thiáº¿t láº­p vÃ  cháº¡y pháº§n má»m mÃ¡y chá»§ Memcached trÃªn má»™t há»‡ thá»‘ng [thÆ°á»ng lÃ  mÃ¡y chá»§ Linux] Ä‘á»ƒ cÃ¡c á»©ng dá»¥ng cÃ³ thá»ƒ káº¿t ná»‘i vÃ  sá»­ dá»¥ng nÃ³ lÃ m má»™t há»‡ thá»‘ng lÆ°u trá»¯ Ä‘á»‘i tÆ°á»£ng trong bá»™ nhá»› [in-memory object caching system] hiá»‡u suáº¥t cao. ðŸš€

  Memcached lÃ  má»™t cÃ´ng cá»¥ mÃ£ nguá»“n má»Ÿ, Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ tÄƒng tá»‘c cÃ¡c á»©ng dá»¥ng web Ä‘á»™ng báº±ng cÃ¡ch giáº£m táº£i cho cÆ¡ sá»Ÿ dá»¯ liá»‡u. NÃ³ lÆ°u trá»¯ cÃ¡c cáº·p key-value [khÃ³a-giÃ¡ trá»‹] trong RAM, giÃºp truy xuáº¥t dá»¯ liá»‡u cá»±c ká»³ nhanh.

  Má»¥c Ä‘Ã­ch chÃ­nh:
  * Caching dá»¯ liá»‡u: LÆ°u káº¿t quáº£ cá»§a cÃ¡c truy váº¥n database tá»‘n kÃ©m, cÃ¡c lá»‡nh gá»i API, hoáº·c cÃ¡c Ä‘oáº¡n HTML Ä‘Ã£ Ä‘Æ°á»£c render Ä‘á»ƒ tÄƒng tá»‘c Ä‘á»™ pháº£n há»“i cá»§a website.
  * Giáº£m táº£i cho database: Giáº£m sá»‘ lÆ°á»£ng truy váº¥n Ä‘á»c trá»±c tiáº¿p Ä‘áº¿n database.
  * Cáº£i thiá»‡n hiá»‡u suáº¥t á»©ng dá»¥ng: GiÃºp website/á»©ng dá»¥ng táº£i nhanh hÆ¡n vÃ  Ä‘Ã¡p á»©ng tá»‘t hÆ¡n.
  Káº¿t quáº£: Sau khi cÃ i Ä‘áº·t, báº¡n sáº½ cÃ³ má»™t mÃ¡y chá»§ Memcached Ä‘ang cháº¡y, láº¯ng nghe trÃªn cá»•ng unix stocket path: /var/run/memcached/memcached.sock, sáºµn sÃ ng Ä‘á»ƒ cÃ¡c á»©ng dá»¥ng káº¿t ná»‘i vÃ  sá»­ dá»¥ng cho viá»‡c caching.

  2. TÃ­nh NÄƒng Há»§y CÃ i Äáº·t Memcached [Uninstall Memcached]
  Há»§y cÃ i Ä‘áº·t Memcached lÃ  quÃ¡ trÃ¬nh gá»¡ bá» pháº§n má»m mÃ¡y chá»§ Memcached vÃ  cÃ³ thá»ƒ cáº£ cÃ¡c tá»‡p cáº¥u hÃ¬nh cá»§a nÃ³ khá»i má»™t há»‡ thá»‘ng. ðŸ—‘ï¸

  Má»¥c Ä‘Ã­ch chÃ­nh:
  * KhÃ´ng cÃ²n nhu cáº§u sá»­ dá»¥ng: Khi khÃ´ng cÃ²n á»©ng dá»¥ng nÃ o cáº§n Ä‘áº¿n Memcached hoáº·c chuyá»ƒn sang giáº£i phÃ¡p caching khÃ¡c.
  * Giáº£i phÃ³ng tÃ i nguyÃªn: Thu há»“i bá»™ nhá»› RAM [vÃ¬ Memcached chá»§ yáº¿u dÃ¹ng RAM] vÃ  má»™t Ã­t khÃ´ng gian Ä‘Ä©a.
  * Cáº¥u hÃ¬nh láº¡i hoáº·c dá»n dáº¹p há»‡ thá»‘ng: Khi ngá»«ng hoáº¡t Ä‘á»™ng mÃ¡y chá»§ hoáº·c thá»±c hiá»‡n thay Ä‘á»•i lá»›n.
  Káº¿t quáº£: Pháº§n má»m Memcached sáº½ Ä‘Æ°á»£c gá»¡ bá» khá»i há»‡ thá»‘ng, dá»‹ch vá»¥ cá»§a nÃ³ sáº½ khÃ´ng cÃ²n cháº¡y vÃ  cÃ¡c á»©ng dá»¥ng sáº½ khÃ´ng thá»ƒ sá»­ dá»¥ng nÃ³ Ä‘á»ƒ caching ná»¯a.
}

. /etc/wptt/.wptt.conf
if [[ $ngon_ngu = '' ]]; then
  ngon_ngu='vi'
fi
. /etc/wptt/lang/$ngon_ngu.sh

echo "========================================================================="
echo "|$quan_ly_cache => $bat_tat_memcached                          |"
echo "========================================================================="

. /etc/wptt/echo-color

# duong_path_memcached_config=$(systemctl cat memcached | grep 'ExecStart' | sed -n 's#^.* \(/.*\.conf\).*#\1#p')
if $(cat /etc/*release | grep -q "Ubuntu"); then
  duong_path_memcached_config="/etc/memcached.conf"
else
  duong_path_memcached_config="/etc/sysconfig/memcached"
fi

if [[ ! -f $duong_path_memcached_config ]]; then
  tong_ram_byte=$(awk '/MemTotal/ {print $2}' /proc/meminfo)
  rong_ram_mb=$(echo "scale=0;${tong_ram_byte}/1024" | bc)
  if [[ "$rong_ram_mb" = "" ]]; then
    rong_ram_mb="2048"
  fi
  if (($rong_ram_mb < 1024)); then
    echo "$chi_nen_su_dung_object_cache_toi_thieu_2gb_ram"
    . /etc/wptt/wptt-cache-main 1
  fi

  if [[ -f $duong_path_memcached_config ]]; then
    echoDo "$ban_da_kich_hoat memcached $truoc_do_roi"
    . /etc/wptt/wptt-cache-main 1
  fi

  echo "$xac_nhan $ban_co_muon $cai memcached?"
  prompt="$nhap_lua_chon_cua_ban [1-2]: "
  dongy="n"
  options=("$dong_y" "$khong_dong_y")

  PS3="$prompt"
  select opt in "${options[@]}"; do
    case "$REPLY" in
    1)
      dongy="y"
      break
      ;;

    2)
      dongy="n"
      break
      ;;

    $((${#options[@]} + 1)))
      printf "\n$ban_nhap_sai_he_thong_se_chon_khong_dong_y\n"
      break
      ;;
    *)
      printf "$ban_nhap_sai_he_thong_se_chon_khong_dong_y\n"
      break
      ;;
    esac
  done

  if [[ $dongy != 'y' ]]; then
    . /etc/wptt/wptt-cache-main 1
    exit
  fi

  . /etc/wptt/echo-color
  _runing "$cai memcached"

  yum install memcached -y >/dev/null 2>&1

  if $(cat /etc/*release | grep -q "Ubuntu"); then
    yum install memcached -y >/dev/null 2>&1
    lsphp=($(ls -A /usr/local/lsws | grep -oP '^lsphp\K[0-9]+$'))
    for phpmemcached in ${lsphp[@]}; do
      yum install lsphp${phpmemcached}-memcached -y >/dev/null 2>&1
    done
  else
    yum install memcached -y --disablerepo="mariadb" >/dev/null 2>&1
    lsphp=($(ls -A /usr/local/lsws | grep -oP '^lsphp\K[0-9]+$'))
    (/etc/wptt/php/kho-luu-tru-litespeed) #subshell trÃ¡nh Ä‘Ã¨ biáº¿n

    for phpmemcached in ${lsphp[@]}; do
      if [[ $(dnf list available 2>/dev/null | grep "lsphp${phpmemcached}-pecl-memcached") ]]; then #Ä‘iá»u kiá»‡n PHP Ä‘ang Ä‘Æ°á»£c há»— trá»£
        yum install lsphp${phpmemcached}-pecl-memcached -y --nogpgcheck --disablerepo="mariadb" 2>/dev/null
      else
        url_repo_litespeed=$(
          cat /tmp/php_extension_call_eol | grep lsphp${phpmemcached} | grep -oP 'href="\K[^"]+' | grep -v 'debuginfo\|-devel\|-debugsource' | awk '
BEGIN { FS = "/" }
{
    filename = $NF
    split(filename, parts, "-")

    pkg_name = ""
    version = ""

    if (parts[2] == "pecl") {
        # TRÆ¯á»œNG Há»¢P 1: GÃ³i PECL (vÃ­ dá»¥: lsphp74-pecl-memcached-...)
        pkg_name = parts[1] "-" parts[2] "-" parts[3]
        version = parts[4]
    } else if (parts[2] ~ /^[0-9]+\.[0-9]+/) {
        # TRÆ¯á»œNG Há»¢P 2 (Má»šI): GÃ³i lsphp gá»‘c (vÃ­ dá»¥: lsphp74-7.4.28-...)
        pkg_name = parts[1]
        version = parts[2]
    } else {
        # TRÆ¯á»œNG Há»¢P 3: GÃ³i extension thÃ´ng thÆ°á»ng (vÃ­ dá»¥: lsphp74-pgsql-...)
        pkg_name = parts[1] "-" parts[2]
        version = parts[3]
    }

    # Logic so sÃ¡nh phiÃªn báº£n vÃ  lÆ°u trá»¯ váº«n nhÆ° cÅ©
    if (version > versions[pkg_name]) {
        versions[pkg_name] = version
        latest_lines[pkg_name] = $0
    }
}
END {
    PROCINFO["sorted_in"] = "@ind_str_asc"
    for (pkg in latest_lines) {
        print latest_lines[pkg]
    }
}'
        )
        extensions_memcached=(pecl-igbinary
          pecl-msgpack
          pecl-memcached)
        for extension in ${extensions_memcached[@]}; do
          if [[ $(printf "%s\n" "${url_repo_litespeed[@]}" | grep "lsphp${phpmemcached}-${extension}-") ]]; then #kiá»ƒm tra extension Ä‘Ã³ cÃ³ tá»“n táº¡i khÃ´ng
            dnf install http://rpms.litespeedtech.com$(printf "%s\n" "${url_repo_litespeed[@]}" | grep "lsphp${phpmemcached}-${extension}-") -y
            if [[ -z $(rpm -aq | grep "lsphp${phpmemcached}-${extension}-") ]]; then #kiá»ƒm tra Ä‘Ã£ cÃ i Ä‘Æ°á»£c chÆ°a, náº¿u chÆ°a cÃ i Ä‘Æ°á»£c thÃ¬ sáº½ return cÃ i láº¡i extension chá»— Ä‘Ã³
              sed -i '/rpms.litespeedtech.com/d' /etc/hosts
              echo $'\n52.55.120.73 rpms.litespeedtech.com\n' >>/etc/hosts
              dnf install http://rpms.litespeedtech.com$(printf "%s\n" "${url_repo_litespeed[@]}" | grep "lsphp${phpmemcached}-${extension}-") -y
              su_dung_repo_du_phong=1
            fi
          fi
        done
      fi
    done
    rm -f /tmp/php_extension_call_eol
  fi

  # mkdir -p /tmp/memcached
  # chown -R memcached:memcached /tmp/memcached

  mkdir -p /var/run/memcached

  if $(cat /etc/*release | grep -q "Ubuntu"); then
    chown -R memcache:memcache /var/run/memcached
    echo '-d
logfile /var/log/memcached.log
-m 128
-u memcache
-s /var/run/memcached/memcached.sock
-a 0766
-c 10240
-P /var/run/memcached/memcached.pid' >$duong_path_memcached_config
  else
    chown -R memcached:memcached /var/run/memcached
    #config memcached unix socket
    echo "USER=\"memcached\"
MAXCONN=\"10240\"
CACHESIZE=\"128\"
OPTIONS=\"-s '/var/run/memcached/memcached.sock' -a 0766\"" >>$duong_path_memcached_config
    semanage permissive -a memcached_t
  fi

  if $(cat /etc/*release | grep -q "Ubuntu"); then
    dnf install nc -y >/dev/null 2>&1
  else
    dnf install nc -y --disablerepo=mariadb >/dev/null 2>&1
  fi

  _rundone "$cai memcached"
  systemctl enable memcached.service >/dev/null 2>&1
  systemctl start memcached.service >/dev/null 2>&1
  systemctl restart lsws >/dev/null 2>&1
  echo "========================================================================="
  echo "unix stocket path: /var/run/memcached/memcached.sock"
  echo "========================================================================="
else

  echo "$xac_nhan $ban_co_muon $xoa Memcached?"
  prompt="$nhap_lua_chon_cua_ban [1-2]: "
  dongy="n"
  options=("$dong_y" "$khong_dong_y")

  PS3="$prompt"
  select opt in "${options[@]}"; do
    case "$REPLY" in
    1)
      dongy="y"
      break
      ;;

    2)
      dongy="n"
      break
      ;;

    $((${#options[@]} + 1)))
      printf "\n$ban_nhap_sai_he_thong_se_chon_khong_dong_y\n"
      break
      ;;
    *)
      printf "$ban_nhap_sai_he_thong_se_chon_khong_dong_y\n"
      break
      ;;
    esac
  done

  if [[ $dongy != 'y' ]]; then
    . /etc/wptt/wptt-cache-main 1
    exit
  fi
  _runing "$xoa memcached"
  systemctl stop memcached.service >/dev/null 2>&1
  systemctl disable memcached.service >/dev/null 2>&1
  yum remove memcached -y >/dev/null 2>&1

  if [[ ! -d /usr/local/lsmcd ]]; then
    lsphp=($(ls /usr/local/lsws | grep 'lsphp' | sed 's/^lsphp//g'))
    for phpmemcached in ${lsphp[@]}; do
      yum remove lsphp${phpmemcached}-pecl-memcached -y >/dev/null 2>&1
      yum remove lsphp${phpmemcached}-memcached -y >/dev/null 2>&1
    done
  fi

  rm -rf /usr/local/lsws/memcached
  rm -f $duong_path_memcached_config
  systemctl restart lsws >/dev/null 2>&1
  _rundone "$xoa memcached"
fi

check_menu_wptangtoc_active=$1
if [[ $check_menu_wptangtoc_active = "98" ]]; then
  . /etc/wptt/wptt-cache-main 1
fi
