#!/bin/bash
# @author: Gia Tuáº¥n
# @website: https://wptangtoc.com
# @since: 2025

function huong_dan() {
  1. TÃ­nh NÄƒng CÃ i Äáº·t Memcached [Install Memcached]
  CÃ i Ä‘áº·t Memcached lÃ  quÃ¡ trÃ¬nh thiáº¿t láº­p vÃ  cháº¡y pháº§n má»m mÃ¡y chá»§ Memcached trÃªn má»™t há»‡ thá»‘ng [thÆ°á»ng lÃ  mÃ¡y chá»§ Linux] Ä‘á»ƒ cÃ¡c á»©ng dá»¥ng cÃ³ thá»ƒ káº¿t ná»‘i vÃ  sá»­ dá»¥ng nÃ³ lÃ m má»™t há»‡ thá»‘ng lÆ°u trá»¯ Ä‘á»‘i tÆ°á»£ng trong bá»™ nhá»› [in-memory object caching system] hiá»‡u suáº¥t cao. ðŸš€

  Memcached lÃ  má»™t cÃ´ng cá»¥ mÃ£ nguá»“n má»Ÿ, Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ tÄƒng tá»‘c cÃ¡c á»©ng dá»¥ng web Ä‘á»™ng báº±ng cÃ¡ch giáº£m táº£i cho cÆ¡ sá»Ÿ dá»¯ liá»‡u. NÃ³ lÆ°u trá»¯ cÃ¡c cáº·p key-value [khÃ³a-giÃ¡ trá»‹] trong RAM, giÃºp truy xuáº¥t dá»¯ liá»‡u cá»±c ká»³ nhanh.

  Má»¥c Ä‘Ã­ch chÃ­nh:
  * Caching dá»¯ liá»‡u: LÆ°u káº¿t quáº£ cá»§a cÃ¡c truy váº¥n database tá»‘n kÃ©m, cÃ¡c lá»‡nh gá»i API, hoáº·c cÃ¡c Ä‘oáº¡n HTML Ä‘Ã£ Ä‘Æ°á»£c render Ä‘á»ƒ tÄƒng tá»‘c Ä‘á»™ pháº£n há»“i cá»§a website.
  * Giáº£m táº£i cho database: Giáº£m sá»‘ lÆ°á»£ng truy váº¥n Ä‘á»c trá»±c tiáº¿p Ä‘áº¿n database.
  * Cáº£i thiá»‡n hiá»‡u suáº¥t á»©ng dá»¥ng: GiÃºp website/á»©ng dá»¥ng táº£i nhanh hÆ¡n vÃ  Ä‘Ã¡p á»©ng tá»‘t hÆ¡n.
  Káº¿t quáº£: Sau khi cÃ i Ä‘áº·t, báº¡n sáº½ cÃ³ má»™t mÃ¡y chá»§ Memcached Ä‘ang cháº¡y, láº¯ng nghe trÃªn cá»•ng unix stocket path: /var/run/memcached/memcached.sock, sáºµn sÃ ng Ä‘á»ƒ cÃ¡c á»©ng dá»¥ng káº¿t ná»‘i vÃ  sá»­ dá»¥ng cho viá»‡c caching.

  2. TÃ­nh NÄƒng Há»§y CÃ i Äáº·t Memcached [Uninstall Memcached]
  Há»§y cÃ i Ä‘áº·t Memcached lÃ  quÃ¡ trÃ¬nh gá»¡ bá» pháº§n má»m mÃ¡y chá»§ Memcached vÃ  cÃ³ thá»ƒ cáº£ cÃ¡c tá»‡p cáº¥u hÃ¬nh cá»§a nÃ³ khá»i má»™t há»‡ thá»‘ng. ðŸ—‘ï¸

  Má»¥c Ä‘Ã­ch chÃ­nh:
  * KhÃ´ng cÃ²n nhu cáº§u sá»­ dá»¥ng: Khi khÃ´ng cÃ²n á»©ng dá»¥ng nÃ o cáº§n Ä‘áº¿n Memcached hoáº·c chuyá»ƒn sang giáº£i phÃ¡p caching khÃ¡c.
  * Giáº£i phÃ³ng tÃ i nguyÃªn: Thu há»“i bá»™ nhá»› RAM [vÃ¬ Memcached chá»§ yáº¿u dÃ¹ng RAM] vÃ  má»™t Ã­t khÃ´ng gian Ä‘Ä©a.
  * Cáº¥u hÃ¬nh láº¡i hoáº·c dá»n dáº¹p há»‡ thá»‘ng: Khi ngá»«ng hoáº¡t Ä‘á»™ng mÃ¡y chá»§ hoáº·c thá»±c hiá»‡n thay Ä‘á»•i lá»›n.
  Káº¿t quáº£: Pháº§n má»m Memcached sáº½ Ä‘Æ°á»£c gá»¡ bá» khá»i há»‡ thá»‘ng, dá»‹ch vá»¥ cá»§a nÃ³ sáº½ khÃ´ng cÃ²n cháº¡y vÃ  cÃ¡c á»©ng dá»¥ng sáº½ khÃ´ng thá»ƒ sá»­ dá»¥ng nÃ³ Ä‘á»ƒ caching ná»¯a.
}

. /etc/wptt/.wptt.conf
if [[ $ngon_ngu = '' ]]; then
  ngon_ngu='vi'
fi
. /etc/wptt/lang/$ngon_ngu.sh

echo "========================================================================="
echo "|$quan_ly_cache => $bat_tat_memcached                          |"
echo "========================================================================="

. /etc/wptt/echo-color

if $(cat /etc/*release | grep -q "Ubuntu"); then
  duong_path_memcached_config="/etc/memcached.conf"
else
  duong_path_memcached_config="/etc/sysconfig/memcached"
fi

if [[ ! -f $duong_path_memcached_config ]]; then
  tong_ram_byte=$(awk '/MemTotal/ {print $2}' /proc/meminfo)
  rong_ram_mb=$(echo "scale=0;${tong_ram_byte}/1024" | bc)
  if [[ "$rong_ram_mb" = "" ]]; then
    rong_ram_mb="2048"
  fi
  if (($rong_ram_mb < 1024)); then
    echo "$chi_nen_su_dung_object_cache_toi_thieu_2gb_ram"
    . /etc/wptt/wptt-cache-main 1
  fi

  if [[ -f $duong_path_memcached_config ]]; then
    echoDo "$ban_da_kich_hoat memcached $truoc_do_roi"
    . /etc/wptt/wptt-cache-main 1
  fi

  echo "$xac_nhan $ban_co_muon $cai memcached?"
  prompt="$nhap_lua_chon_cua_ban [1-2]: "
  dongy="n"
  options=("$dong_y" "$khong_dong_y")

  PS3="$prompt"
  select opt in "${options[@]}"; do
    case "$REPLY" in
    1)
      dongy="y"
      break
      ;;

    2)
      dongy="n"
      break
      ;;

    $((${#options[@]} + 1)))
      printf "\n$ban_nhap_sai_he_thong_se_chon_khong_dong_y\n"
      break
      ;;
    *)
      printf "$ban_nhap_sai_he_thong_se_chon_khong_dong_y\n"
      break
      ;;
    esac
  done

  if [[ $dongy != 'y' ]]; then
    . /etc/wptt/wptt-cache-main 1
    exit
  fi

  . /etc/wptt/echo-color
  _runing "$cai memcached"

  yum install memcached -y >/dev/null 2>&1

  if $(cat /etc/*release | grep -q "Ubuntu"); then
    lsphp=($(ls /usr/local/lsws | grep 'lsphp' | sed 's/^lsphp//g'))
    for phpmemcached in ${lsphp[@]}; do
      yum install lsphp${phpmemcached}-memcached -y >/dev/null 2>&1
    done
  else
    lsphp=($(ls /usr/local/lsws | grep 'lsphp' | sed 's/^lsphp//g'))
    for phpmemcached in ${lsphp[@]}; do
      yum install lsphp${phpmemcached}-pecl-memcached -y --nogpgcheck --disablerepo="mariadb" >/dev/null 2>&1

      if [[ $phpmemcached = '74' && $(cat /etc/*release | grep 'el8') && $(uname -m | grep 'x86_64') ]]; then # tÆ°Æ¡ng thÃ­ch ngÆ°á»£c vá»›i php7.4
        dnf install https://rpms.litespeedtech.com/centos/8/x86_64/RPMS/lsphp74-pecl-igbinary-3.0.1-1.el8.7.4.x86_64.rpm -y >/dev/null 2>&1
        dnf install https://rpms.litespeedtech.com/centos/8/x86_64/RPMS/lsphp74-pecl-memcached-3.1.5-1.el8.7.4.x86_64.rpm -y >/dev/null 2>&1
      fi

      if [[ $phpmemcached = '74' && $(cat /etc/*release | grep 'el9') && $(uname -m | grep 'x86_64') ]]; then # tÆ°Æ¡ng thÃ­ch ngÆ°á»£c vá»›i php7.4
        dnf install https://rpms.litespeedtech.com/centos/9/update/x86_64/RPMS/lsphp74-pecl-igbinary-3.2.12-4.el9.7.4.x86_64.rpm -y >/dev/null 2>&1
        dnf install https://rpms.litespeedtech.com/centos/9/update/x86_64/RPMS/lsphp74-pecl-memcached-3.2.0-4.el9.7.4.x86_64.rpm -y >/dev/null 2>&1
      fi

      if [[ $phpmemcached = '74' && $(cat /etc/*release | grep 'el9') && $(uname -m | grep 'aarch64') ]]; then # tÆ°Æ¡ng thÃ­ch ngÆ°á»£c vá»›i php7.4 cÃ¹ng cpu arm cÃ¹ng redhat9
        dnf install https://rpms.litespeedtech.com/centos/9/aarch64/RPMS/lsphp74-pecl-igbinary-3.2.14-1.el9.7.4.aarch64.rpm -y >/dev/null 2>&1
        dnf install https://rpms.litespeedtech.com/centos/9/aarch64/RPMS/lsphp74-pecl-memcached-3.2.0-1.el9.7.4.aarch64.rpm -y >/dev/null 2>&1
      fi

    done
  fi

  # mkdir -p /tmp/memcached
  # chown -R memcached:memcached /tmp/memcached

  mkdir -p /var/run/memcached

  if $(cat /etc/*release | grep -q "Ubuntu"); then
    chown -R memcache:memcache /var/run/memcached
    echo '-d
logfile /var/log/memcached.log
-m 128
-u memcache
-s /var/run/memcached/memcached.sock
-a 0766
-c 10240
-P /var/run/memcached/memcached.pid' >$duong_path_memcached_config
  else
    chown -R memcached:memcached /var/run/memcached
    #config memcached unix socket
    echo "USER=\"memcached\"
MAXCONN=\"10240\"
CACHESIZE=\"128\"
OPTIONS=\"-s '/var/run/memcached/memcached.sock' -a 0766\"" >>$duong_path_memcached_config
    semanage permissive -a memcached_t
  fi

  if $(cat /etc/*release | grep -q "Ubuntu"); then
    dnf install nc -y >/dev/null 2>&1
  else
    dnf install nc -y --disablerepo=mariadb >/dev/null 2>&1
  fi

  _rundone "$cai memcached"
  systemctl enable memcached.service >/dev/null 2>&1
  systemctl start memcached.service >/dev/null 2>&1
  systemctl restart lsws >/dev/null 2>&1
  echo "========================================================================="
  echo "unix stocket path: /var/run/memcached/memcached.sock"
  echo "========================================================================="
else

  echo "$xac_nhan $ban_co_muon $xoa Memcached?"
  prompt="$nhap_lua_chon_cua_ban [1-2]: "
  dongy="n"
  options=("$dong_y" "$khong_dong_y")

  PS3="$prompt"
  select opt in "${options[@]}"; do
    case "$REPLY" in
    1)
      dongy="y"
      break
      ;;

    2)
      dongy="n"
      break
      ;;

    $((${#options[@]} + 1)))
      printf "\n$ban_nhap_sai_he_thong_se_chon_khong_dong_y\n"
      break
      ;;
    *)
      printf "$ban_nhap_sai_he_thong_se_chon_khong_dong_y\n"
      break
      ;;
    esac
  done

  if [[ $dongy != 'y' ]]; then
    . /etc/wptt/wptt-cache-main 1
    exit
  fi
  _runing "$xoa memcached"
  systemctl stop memcached.service >/dev/null 2>&1
  systemctl disable memcached.service >/dev/null 2>&1
  yum remove memcached -y >/dev/null 2>&1

  if [[ ! -d /usr/local/lsmcd ]]; then
    lsphp=($(ls /usr/local/lsws | grep 'lsphp' | sed 's/^lsphp//g'))
    for phpmemcached in ${lsphp[@]}; do
      yum remove lsphp${phpmemcached}-pecl-memcached -y >/dev/null 2>&1
      yum remove lsphp${phpmemcached}-memcached -y >/dev/null 2>&1
    done
  fi

  rm -rf /usr/local/lsws/memcached
  rm -f $duong_path_memcached_config
  systemctl restart lsws >/dev/null 2>&1
  _rundone "$xoa memcached"
fi

check_menu_wptangtoc_active=$1
if [[ $check_menu_wptangtoc_active = "98" ]]; then
  . /etc/wptt/wptt-cache-main 1
fi
