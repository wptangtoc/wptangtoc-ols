#!/bin/bash
# @author: Gia Tuấn
# @website: https://wptangtoc.com
# @since: 2025

function huong_dan() {
  1. Tính Năng Cài Đặt Redis [Install Redis]
  Cài đặt Redis là quá trình thiết lập và chạy phần mềm máy chủ Redis trên hệ thống để các ứng dụng có thể kết nối và sử dụng nó.

  Redis là một kho lưu trữ cấu trúc dữ liệu trong bộ nhớ [in-memory], mã nguồn mở, rất nhanh và đa năng. Nó thường được dùng làm:
  * Cơ sở dữ liệu, bộ nhớ đệm [Cache]: Tăng tốc website, ứng dụng.
  * Message Broker: Trung gian truyền tin nhắn.
  * Quản lý phiên [Session Management], hàng đợi tác vụ [Job Queues], và nhiều ứng dụng thời gian thực khác.

  Kết quả: Sau khi cài đặt, bạn sẽ có một máy chủ Redis đang chạy, lắng nghe trên cổng unix stocket path: /var/run/redis/redis.sock sẵn sàng để các ứng dụng kết nối và sử dụng cho việc caching.

  2. Tính Năng Hủy Cài Đặt Redis [Uninstall Redis]
  Hủy cài đặt Redis là quá trình gỡ bỏ phần mềm máy chủ Redis, các tệp cấu hình và có thể cả dữ liệu của nó khỏi một hệ thống.

  Mục đích chính:
  * Không còn nhu cầu sử dụng.
  * Giải phóng tài nguyên [RAM, dung lượng đĩa].
  * Cấu hình lại hoặc dọn dẹp hệ thống.

  Kết quả: Phần mềm Redis sẽ được gỡ bỏ, dịch vụ sẽ dừng và không còn khả dụng cho ứng dụng.
}

. /etc/wptt/.wptt.conf
if [[ $ngon_ngu = '' ]]; then
  ngon_ngu='vi'
fi
. /etc/wptt/lang/$ngon_ngu.sh

echo "========================================================================="
echo "|$quan_ly_cache => $bat_tat_object_cache_redis                          |"
echo "========================================================================="

. /etc/wptt/echo-color

if $(cat /etc/*release | grep -q "Ubuntu\|AlmaLinux 9"); then
  duong_dan_config_redis="/etc/redis/redis.conf"
else
  duong_dan_config_redis="/etc/redis.conf"
fi

# duong_dan_config_redis=$(systemctl cat redis | grep 'ExecStart' | sed -n 's#^.* \(/.*\.conf\).*#\1#p')
if [[ ! -f "$duong_dan_config_redis" ]]; then
  echo "$xac_nhan $ban_co_muon $cai redis?"

  prompt="$nhap_lua_chon_cua_ban [1-2]: "
  bien=$1
  dongyconfig='n'
  options=("$dong_y" "$khong_dong_y")

  PS3="$prompt"
  select opt in "${options[@]}"; do
    case "$REPLY" in
    1)
      dongyconfig="y"
      break
      ;;

    2)
      dongyconfig="n"
      break
      ;;

    $((${#options[@]} + 1)))
      printf "\n$ban_nhap_sai_he_thong_se_chon_khong_dong_y\n"
      break
      ;;
    *)
      printf "$ban_nhap_sai_he_thong_se_chon_khong_dong_y\n"
      break
      ;;
    esac
  done

  if [[ "$dongyconfig" != "y" ]]; then
    check_menu_wptangtoc_active=$1
    if [[ $check_menu_wptangtoc_active = "98" ]]; then
      . /etc/wptt/wptt-cache-main 1
    fi
    exit
  fi

  tong_ram_byte=$(awk '/MemTotal/ {print $2}' /proc/meminfo)
  rong_ram_mb=$(echo "scale=0;${tong_ram_byte}/1024" | bc)
  if [[ "$rong_ram_mb" = "" ]]; then
    rong_ram_mb="2048"
  fi
  if (($rong_ram_mb < 1024)); then
    echo "$chi_nen_su_dung_object_cache_toi_thieu_2gb_ram"
    . /etc/wptt/wptt-cache-main 1
  fi

  . /etc/wptt/echo-color
  if [[ -f $duong_dan_config_redis ]]; then
    echoDo "$ban_da_kich_hoat redis $truoc_do_roi"
    . /etc/wptt/wptt-cache-main 1
    exit
  fi

  _runing "$cai redis"
  echo "kích hoạt redis: $(date '+%d-%m-%Y %H:%M')" >>/var/log/wptangtoc-ols.log

  if $(cat /etc/*release | grep -q "Ubuntu"); then
    yum install redis -y >/dev/null 2>&1
    yum install redis-server -y >/dev/null 2>&1
    lsphp=($(ls -A /usr/local/lsws | grep -oP '^lsphp\K[0-9]+$'))
    for phpredis in ${lsphp[@]}; do
      yum install lsphp${phpredis}-redis -y >/dev/null 2>&1
    done
  else
    yum install redis -y --disablerepo="mariadb" >/dev/null 2>&1
    lsphp=($(ls -A /usr/local/lsws | grep -oP '^lsphp\K[0-9]+$'))
    (/etc/wptt/php/kho-luu-tru-litespeed) #subshell tránh đè biến

    for phpredis in ${lsphp[@]}; do
      if [[ $(dnf list available 2>/dev/null | grep "lsphp${phpredis}-pecl-redis") ]]; then #điều kiện PHP đang được hỗ trợ
        yum install lsphp${phpredis}-pecl-redis -y --nogpgcheck --disablerepo="mariadb" 2>/dev/null
      else
        url_repo_litespeed=$(
          cat /tmp/php_extension_call_eol | grep lsphp${phpredis} | grep -oP 'href="\K[^"]+' | grep -v 'debuginfo\|-devel\|-debugsource' | awk '
BEGIN { FS = "/" }
{
    filename = $NF
    split(filename, parts, "-")

    pkg_name = ""
    version = ""

    if (parts[2] == "pecl") {
        # TRƯỜNG HỢP 1: Gói PECL (ví dụ: lsphp74-pecl-redis-...)
        pkg_name = parts[1] "-" parts[2] "-" parts[3]
        version = parts[4]
    } else if (parts[2] ~ /^[0-9]+\.[0-9]+/) {
        # TRƯỜNG HỢP 2 (MỚI): Gói lsphp gốc (ví dụ: lsphp74-7.4.28-...)
        pkg_name = parts[1]
        version = parts[2]
    } else {
        # TRƯỜNG HỢP 3: Gói extension thông thường (ví dụ: lsphp74-pgsql-...)
        pkg_name = parts[1] "-" parts[2]
        version = parts[3]
    }

    # Logic so sánh phiên bản và lưu trữ vẫn như cũ
    if (version > versions[pkg_name]) {
        versions[pkg_name] = version
        latest_lines[pkg_name] = $0
    }
}
END {
    PROCINFO["sorted_in"] = "@ind_str_asc"
    for (pkg in latest_lines) {
        print latest_lines[pkg]
    }
}'
        )
        extensions_redis=(pecl-igbinary
          pecl-redis)
        for extension in ${extensions_redis[@]}; do
          if [[ $(printf "%s\n" "${url_repo_litespeed[@]}" | grep "lsphp${phpredis}-${extension}-") ]]; then #kiểm tra extension đó có tồn tại không
            dnf install http://rpms.litespeedtech.com$(printf "%s\n" "${url_repo_litespeed[@]}" | grep "lsphp${phpredis}-${extension}-") -y
            if [[ -z $(rpm -aq | grep "lsphp${phpredis}-${extension}-") ]]; then #kiểm tra đã cài được chưa, nếu chưa cài được thì sẽ return cài lại extension chỗ đó
              sed -i '/rpms.litespeedtech.com/d' /etc/hosts
              echo $'\n52.55.120.73 rpms.litespeedtech.com\n' >>/etc/hosts
              dnf install http://rpms.litespeedtech.com$(printf "%s\n" "${url_repo_litespeed[@]}" | grep "lsphp${phpredis}-${extension}-") -y
              su_dung_repo_du_phong=1
            fi
          fi
        done
      fi
    done
    rm -f /tmp/php_extension_call_eol
  fi

  _rundone "$cai redis"

  _runing "$thiet_lap redis"

  echo "unixsocket /var/run/redis/redis.sock
unixsocketperm 777
maxmemory 128mb
maxmemory-policy allkeys-lru
save \"\"" >>$duong_dan_config_redis

  sed -i 's/tcp-keepalive 300/tcp-keepalive 0/g' $duong_dan_config_redis
  sed -i 's/rdbcompression yes/rdbcompression no/g' $duong_dan_config_redis
  sed -i 's/rdbchecksum yes/rdbchecksum no/g' $duong_dan_config_redis
  mkdir -p /var/run/redie
  chmod 700 /var/lib/redis
  chown redis:redis /var/run/redis 2>/dev/null
  chown redis:redis $duong_dan_config_redis 2>/dev/null
  chmod 600 $duong_dan_config_redis
  systemctl enable redis.service >/dev/null 2>&1
  systemctl start redis.service >/dev/null 2>&1

  systemctl start redis.service >/dev/null 2>&1
  systemctl enable redis.service >/dev/null 2>&1

  systemctl enable redis-server.service >/dev/null 2>&1
  systemctl start redis-server.service >/dev/null 2>&1

  systemctl restart lsws >/dev/null 2>&1
  _rundone "$thiet_lap redis"
  echo "========================================================================="
  echo "HOST unix stocket path: /var/run/redis/redis.sock"
  echo "========================================================================="
else

  echo "$xac_nhan $ban_co_muon $xoa redis?"
  prompt="$nhap_lua_chon_cua_ban [1-2]: "
  bien=$1
  dongyconfig='n'
  options=("$dong_y" "$khong_dong_y")

  PS3="$prompt"
  select opt in "${options[@]}"; do
    case "$REPLY" in
    1)
      dongyconfig="y"
      break
      ;;

    2)
      dongyconfig="n"
      break
      ;;

    $((${#options[@]} + 1)))
      printf "\n$ban_nhap_sai_he_thong_se_chon_khong_dong_y\n"
      break
      ;;
    *)
      printf "$ban_nhap_sai_he_thong_se_chon_khong_dong_y\n"
      break
      ;;
    esac
  done

  if [[ "$dongyconfig" != "y" ]]; then
    check_menu_wptangtoc_active=$1
    if [[ $check_menu_wptangtoc_active = "98" ]]; then
      . /etc/wptt/wptt-cache-main 1
    fi
    exit
  fi

  echo "Huỷ kích hoạt redis: $(date '+%d-%m-%Y %H:%M')" >>/var/log/wptangtoc-ols.log

  _runing "$xoa Redis"
  systemctl stop redis >/dev/null 2>&1
  systemctl disable redis >/dev/null 2>&1
  yum remove redis -y >/dev/null 2>&1
  # lsphp=($(ls /usr/local/lsws | grep -P '^lsphp[0-9]+$' | sed 's/^lsphp//g'))
  #grep -oP '^lsphp\K[0-9]+$' sử dụng kiểu này nó chính xác hơn tuyệt đối tránh bị nẹm vào domain lsphp...com nào đó chả hạn
  lsphp=($(ls /usr/local/lsws | grep -oP '^lsphp\K[0-9]+$'))
  for php_redis in ${lsphp[@]}; do
    yum remove lsphp${php_redis}-pecl-redis -y --disablerepo="*" --enablerepo="litespeed,litespeed-update" >/dev/null 2>&1
  done
  rm -rf $duong_dan_config_redis
  _rundone "$xoa Redis"
fi

check_menu_wptangtoc_active=$1
if [[ $check_menu_wptangtoc_active = "98" ]]; then
  . /etc/wptt/wptt-cache-main 1
fi
